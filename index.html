<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sturtee Merch Portal</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:#f1f3f5;color:#111827;font-size:14px}
.app{display:flex;height:100vh;overflow:hidden}
.sidebar{width:230px;flex-shrink:0;background:#fff;border-right:1px solid #e5e7eb;display:flex;flex-direction:column;overflow-y:auto}
.main-content{flex:1;overflow-y:auto;padding:32px 36px}
.top-bar{background:#f8f9fa;border-bottom:1px solid #dee2e6;padding:8px 20px;font-size:12px;color:#9ca3af;letter-spacing:.01em}
/* sidebar */
.sidebar-brand{padding:20px 20px 12px;border-bottom:1px solid #f3f4f6}
.sidebar-brand h2{font-size:16px;font-weight:700;color:#111827}
.sidebar-brand p{font-size:11px;color:#9ca3af;margin-top:2px}
.sidebar-user{padding:14px 16px;border-bottom:1px solid #f3f4f6;display:flex;align-items:center;gap:10px}
.avatar{width:32px;height:32px;border-radius:50%;background:#0f75bc;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;color:#fff;flex-shrink:0}
.user-name{font-size:13px;font-weight:600;color:#111827}
.role-badge{display:inline-block;font-size:10px;font-weight:600;padding:2px 7px;border-radius:4px;margin-top:3px;text-transform:lowercase}
.badge-admin{background:#fee2e2;color:#dc2626}
.badge-sales_rep{background:#dbeafe;color:#2563eb}
.badge-designer{background:#ede9fe;color:#7c3aed}
.badge-fulfillment{background:#dcfce7;color:#16a34a}
.badge-super_admin{background:#0f75bc;color:#fff}
.nav{padding:12px 0;flex:1}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 20px;font-size:13.5px;color:#4b5563;cursor:pointer;transition:background .15s,color .15s}
.nav-item:hover{background:#f0f8ff;color:#0f75bc}
.nav-item.active{background:#e8f4fd;color:#0f75bc;font-weight:600}
.nav-item svg{width:16px;height:16px;flex-shrink:0;opacity:.7}
.nav-item.active svg{opacity:1}
.sidebar-footer{padding:12px 0;border-top:1px solid #f3f4f6}
.sign-out{display:flex;align-items:center;gap:10px;padding:9px 20px;font-size:13px;color:#6b7280;cursor:pointer}
.sign-out:hover{color:#dc2626}
/* login */
.login-page{min-height:100vh;background:#f1f3f5;display:flex;flex-direction:column}
.login-topbar{padding:10px 20px;font-size:12px;color:#9ca3af}
.login-wrap{flex:1;display:flex;align-items:center;justify-content:center;padding:40px 20px}
.login-inner{width:100%;max-width:420px}
.login-logo{display:flex;flex-direction:column;align-items:center;margin-bottom:24px}
.login-logo img{width:100px;height:auto;object-fit:contain;margin-bottom:14px}
.logo-icon{width:52px;height:52px;background:#0f75bc;border-radius:14px;display:flex;align-items:center;justify-content:center;margin-bottom:14px}
.login-inner h1{font-size:22px;font-weight:700;text-align:center;color:#111827}
.subtitle{font-size:13px;color:#6b7280;text-align:center;margin-top:4px}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:24px;margin-bottom:16px}
.card h3{font-size:16px;font-weight:600;margin-bottom:4px;color:#111827}
.card-sub{font-size:12px;color:#6b7280;margin-bottom:20px}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:13px;font-weight:500;margin-bottom:6px;color:#374151}
.form-input{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px;font-family:inherit;background:#f9fafb;color:#111827;outline:none;transition:border .15s}
.form-input:focus{border-color:#0f75bc;background:#fff}
.btn-primary{width:100%;padding:11px;background:#0f75bc;color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;transition:background .15s}
.btn-primary:hover{background:#0d69a8}
.btn-primary:disabled{background:#9ca3af;cursor:not-allowed}
.login-footer{text-align:center;font-size:11px;color:#9ca3af;padding:16px}
.err{background:#fee2e2;color:#dc2626;border-radius:8px;padding:10px 14px;font-size:13px;margin-bottom:14px;display:none}
.suc{background:#dcfce7;color:#16a34a;border-radius:8px;padding:10px 14px;font-size:13px;margin-bottom:14px;display:none}
/* loading */
.loading-screen{display:flex;align-items:center;justify-content:center;height:100vh;background:#f1f3f5;flex-direction:column;gap:12px}
.spinner{width:32px;height:32px;border:3px solid #e5e7eb;border-top-color:#0f75bc;border-radius:50%;animation:spin .7s linear infinite}
.spinner-sm{width:16px;height:16px;border:2px solid #e5e7eb;border-top-color:#0f75bc;border-radius:50%;animation:spin .7s linear infinite;display:inline-block}
@keyframes spin{to{transform:rotate(360deg)}}
/* layout */
.page-header{margin-bottom:28px}
.page-header h1{font-size:22px;font-weight:700;color:#111827}
.page-header p{font-size:13px;color:#6b7280;margin-top:3px}
.header-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:28px}
/* stats */
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:18px 20px;display:flex;align-items:flex-start;gap:14px}
.stat-bar{width:4px;height:40px;border-radius:2px;flex-shrink:0;margin-top:2px}
.stat-num{font-size:28px;font-weight:700;line-height:1;color:#111827}
.stat-label{font-size:12px;color:#6b7280;margin-top:4px}
/* quick actions */
.quick-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:24px}
.quick-card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:16px 18px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:border-color .15s,box-shadow .15s}
.quick-card:hover{border-color:#0f75bc;box-shadow:0 2px 8px rgba(15,117,188,.1)}
.quick-icon{width:36px;height:36px;border-radius:8px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.quick-icon svg{width:18px;height:18px}
.quick-info strong{font-size:14px;font-weight:600;display:block;color:#111827}
.quick-info span{font-size:12px;color:#9ca3af}
/* section card */
.section-card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:20px 24px;margin-bottom:16px}
.section-title{font-size:15px;font-weight:600;margin-bottom:4px;color:#111827}
.section-sub{font-size:12px;color:#6b7280;margin-bottom:16px}
/* activity */
.activity-item{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid #f3f4f6;cursor:pointer}
.activity-item:last-child{border-bottom:none}
.activity-item:hover{background:#fafafa;margin:0 -8px;padding:12px 8px;border-radius:6px}
.activity-info{flex:1}
.activity-info strong{font-size:13px;font-weight:500;color:#111827}
.activity-info span{font-size:11px;color:#9ca3af;display:block;margin-top:1px}
/* pills */
.pill{font-size:11px;font-weight:500;padding:3px 10px;border-radius:6px;border:1px solid #e5e7eb;white-space:nowrap;display:inline-block}
.pill-intake{border-color:#e5e7eb;color:#6b7280;background:#fff}
.pill-quote{background:#ede9fe;color:#7c3aed;border-color:#ddd6fe}
.pill-design{background:#dbeafe;color:#2563eb;border-color:#bfdbfe}
.pill-production{background:#fef3c7;color:#d97706;border-color:#fde68a}
.pill-fulfillment{background:#fed7aa;color:#c2410c;border-color:#fdba74}
.pill-complete{background:#dcfce7;color:#16a34a;border-color:#bbf7d0}
.pill-cancelled{background:#f3f4f6;color:#6b7280;border-color:#e5e7eb}
.pill-rush{background:#fee2e2;color:#dc2626;border-color:#fecaca;font-size:10px}
/* tabs */
.tab-bar{display:flex;background:#f3f4f6;border-radius:8px;padding:3px;margin-bottom:20px;width:fit-content;flex-wrap:wrap;gap:2px}
.tab{padding:7px 16px;border-radius:6px;font-size:13px;cursor:pointer;color:#6b7280;transition:all .15s;white-space:nowrap}
.tab.active{background:#fff;color:#0f75bc;font-weight:600;box-shadow:0 1px 3px rgba(0,0,0,.1)}
/* cards */
.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px}
.order-card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:20px;transition:box-shadow .15s}
.order-card:hover{box-shadow:0 2px 12px rgba(0,0,0,.08)}
.card-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:4px}
.card-header h3{font-size:15px;font-weight:600;color:#111827;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.card-sub{font-size:12px;color:#6b7280;margin-bottom:14px}
.card-meta{display:grid;grid-template-columns:1fr 1fr;gap:8px 20px;margin-bottom:14px}
.meta-row label{font-size:11px;color:#9ca3af;display:block;margin-bottom:1px}
.meta-row span{font-size:13px;font-weight:500;color:#111827}
.notes-box{background:#f9fafb;border-radius:6px;padding:10px 12px;font-size:12px;color:#6b7280;margin-bottom:14px;line-height:1.5}
.notes-box label{display:block;font-size:11px;color:#9ca3af;margin-bottom:3px;font-weight:600}
/* buttons */
.btn{padding:9px 16px;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;font-family:inherit;border:none;transition:background .15s;display:inline-flex;align-items:center;gap:6px;justify-content:center}
.btn-blue{background:#0f75bc;color:#fff}.btn-blue:hover{background:#0d69a8}
.btn-dark{background:#111827;color:#fff}.btn-dark:hover{background:#1f2937}
.btn-ghost{background:#fff;color:#111827;border:1px solid #e5e7eb}.btn-ghost:hover{background:#f9fafb}
.btn-red{background:#fee2e2;color:#dc2626;border:1px solid #fecaca}.btn-red:hover{background:#fecaca}
.btn-green{background:#dcfce7;color:#16a34a;border:1px solid #bbf7d0}.btn-green:hover{background:#bbf7d0}
.btn-full{width:100%}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.btn-sm-blue{padding:8px 16px;background:#0f75bc;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;font-family:inherit;display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
/* form */
.form-card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:28px;max-width:700px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.form-section{margin-bottom:24px}
.form-section-title{font-size:13px;font-weight:600;margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid #f3f4f6;color:#111827}
.form-select{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px;font-family:inherit;background:#f9fafb;color:#111827;outline:none}
.form-select:focus{border-color:#0f75bc}
.form-textarea{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px;font-family:inherit;background:#f9fafb;color:#111827;outline:none;resize:vertical;min-height:80px}
/* modal */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:200;align-items:center;justify-content:center}
.modal-bg.open{display:flex}
.modal{background:#fff;border-radius:14px;padding:28px;width:100%;max-width:460px;margin:20px;box-shadow:0 20px 60px rgba(0,0,0,.2);max-height:90vh;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal-header h2{font-size:17px;font-weight:700;color:#111827}
.modal-close{background:none;border:none;cursor:pointer;font-size:22px;color:#9ca3af;line-height:1;padding:0}
/* empty state */
.empty{text-align:center;padding:48px 20px;color:#9ca3af}
.empty svg{width:40px;height:40px;margin:0 auto 12px;display:block;opacity:.4}
.empty p{font-size:14px;margin-bottom:16px}
/* order number */
.order-num{font-family:monospace;font-size:11px;color:#9ca3af}
/* team table */
.team-table{width:100%;border-collapse:collapse}
.team-table th{text-align:left;padding:8px 14px;font-size:11px;color:#9ca3af;font-weight:600;text-transform:uppercase;letter-spacing:.05em;border-bottom:1px solid #f3f4f6}
.team-table td{padding:13px 14px;border-bottom:1px solid #f9fafb;font-size:13px;color:#374151}
.team-table tr:last-child td{border-bottom:none}
.team-table tr:hover td{background:#fafafa}
/* flag cards */
.flag-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:12px;margin-bottom:20px}
.flag-card{background:#fff;border:1px solid #fecaca;border-radius:10px;padding:16px 18px;display:flex;align-items:flex-start;gap:12px}
.flag-bar{width:4px;height:36px;border-radius:2px;flex-shrink:0}
.flag-num{font-size:24px;font-weight:700;line-height:1;color:#111827}
.flag-label{font-size:12px;color:#6b7280;margin-top:3px}
/* metric */
.metric-card{background:#f9fafb;border-radius:8px;padding:14px 16px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
.metric-val{font-size:22px;font-weight:700;color:#111827}
.metric-label{font-size:12px;color:#6b7280}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}
/* info box */
.info-box{background:#f0f8ff;border:1px solid #bae6fd;border-radius:8px;padding:12px 14px;font-size:12px;color:#0369a1;margin-top:14px;line-height:1.5}
/* page animation */
.page{animation:fadeUp .18s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}
/* status flow bar */
.flow-bar{display:flex;align-items:center;gap:0;margin-bottom:24px;overflow-x:auto;padding-bottom:4px}
.flow-step{display:flex;align-items:center;gap:0;flex-shrink:0}
.flow-node{padding:6px 14px;border-radius:20px;font-size:12px;font-weight:500;white-space:nowrap;border:1.5px solid #e5e7eb;color:#9ca3af;background:#fff;cursor:default}
.flow-node.done{background:#dcfce7;border-color:#bbf7d0;color:#16a34a}
.flow-node.current{background:#0f75bc;border-color:#0f75bc;color:#fff}
.flow-arrow{width:24px;height:2px;background:#e5e7eb;flex-shrink:0}
.flow-arrow.done{background:#bbf7d0}
.wizard-steps{display:flex;gap:4px;margin-bottom:20px;flex-wrap:wrap}
.wizard-step{padding:8px 14px;border-radius:8px;font-size:12px;font-weight:500;background:#f3f4f6;color:#6b7280;cursor:pointer}
.wizard-step.active{background:#0f75bc;color:#fff}
.wizard-step.done{background:#dcfce7;color:#16a34a}
.timeline-risk{padding:12px 16px;border-radius:8px;margin-bottom:16px;font-size:13px;font-weight:500}
.timeline-risk.low{background:#dcfce7;color:#16a34a;border:1px solid #bbf7d0}
.timeline-risk.medium{background:#fef3c7;color:#d97706;border:1px solid #fde68a}
.timeline-risk.high{background:#fee2e2;color:#dc2626;border:1px solid #fecaca}
@media(max-width:700px){.two-col,.form-row{grid-template-columns:1fr}.sidebar{width:200px}.main-content{padding:20px 16px}.card-grid{grid-template-columns:1fr}}
</style>
</head>
<body>

<div id="loadingScreen" class="loading-screen">
  <div class="spinner"></div>
  <div style="font-size:13px;color:#9ca3af;margin-top:4px">Loading Sturtee...</div>
</div>

<div id="loginPage" class="login-page" style="display:none">
  <div class="login-topbar">Sturtee Merchandise Workflow System</div>
  <div class="login-wrap">
    <div class="login-inner">
      <div class="login-logo">
        <img src="./sturdy-logo.png" alt="Sturdy" onerror="this.style.display='none'">
        <div class="logo-icon">
          <svg width="26" height="26" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
        </div>
        <h1>Sturtee Merch Portal</h1>
        <p class="subtitle">Sign in to access the workflow system</p>
      </div>
      <div class="card">
        <h3>Sign In</h3>
        <p class="card-sub">Enter your credentials to continue</p>
        <div id="loginErr" class="err"></div>
        <div class="form-group"><label>Email</label><input type="email" class="form-input" id="loginEmail" placeholder="you@sturtee.com" onkeydown="if(event.key==='Enter')doLogin()"></div>
        <div class="form-group"><label>Password</label><input type="password" class="form-input" id="loginPass" placeholder="Enter password" onkeydown="if(event.key==='Enter')doLogin()"></div>
        <button class="btn-primary" id="loginBtn" onclick="doLogin()">Sign In</button>
      </div>
      <div class="login-footer">Sturtee Merch Portal · v1.0</div>
    </div>
  </div>
</div>

<div id="appShell" class="app" style="display:none">
  <div class="sidebar">
    <div class="sidebar-brand"><h2>Sturtee Merch</h2><p>Workflow Portal</p></div>
    <div class="sidebar-user">
      <div class="avatar" id="sbAvatar">?</div>
      <div style="flex:1;min-width:0">
        <div class="user-name" id="sbName" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">...</div>
        <span class="role-badge" id="sbBadge">...</span>
      </div>
    </div>
    <nav class="nav" id="sbNav"></nav>
    <div class="sidebar-footer">
      <div class="sign-out" onclick="doSignOut()">
        <svg width="15" height="15" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
        Sign Out
      </div>
    </div>
  </div>
  <div style="flex:1;display:flex;flex-direction:column;overflow:hidden">
    <div class="top-bar">Sturtee Merchandise Workflow System</div>
    <div class="main-content" id="mainContent"></div>
  </div>
</div>

<script>
// ═══════════════════ SUPABASE ═══════════════════
let sb = null;
if (typeof supabase !== 'undefined') {
  try {
    sb = supabase.createClient(
      'https://xtgtihetywvytwqiyriw.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh0Z3RpaGV0eXd2eXR3cWl5cml3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NDUyMDIsImV4cCI6MjA4NzAyMTIwMn0.YPRcqWz7uFR-WybGnK6HcZ_v-EYCeedDgLJB4_4iQUU'
    );
  } catch (e) { console.error(e); }
}

// ═══════════════════ STATE ═══════════════════
let CU = null; // current user (auth)
let CP = null; // current profile (db)
let PAGE = 'dashboard';

const NAV_ROLES = {
  super_admin: ['dashboard','quote-request','chapters','design-queue','approvals','fulfillment','storefront','admin','team'],
  admin:       ['dashboard','quote-request','chapters','design-queue','approvals','fulfillment','storefront','admin','team'],
  sales_rep:   ['dashboard','quote-request','chapters','approvals','storefront'],
  designer:    ['dashboard','design-queue','approvals'],
  fulfillment: ['dashboard','fulfillment'],
};

const NAV_DEFS = {
  dashboard:      { label:'Dashboard',     icon:'<path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>' },
  'quote-request':{ label:'New Quote',     icon:'<path d="M12 4v16m8-8H4"/>' },
  chapters:       { label:'Chapters',      icon:'<path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M17 16h2m-2 0h-5m-9 0H3"/>' },
  'design-queue': { label:'Design Queue',  icon:'<path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>' },
  approvals:      { label:'Approvals',     icon:'<path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>' },
  fulfillment:    { label:'Fulfillment',   icon:'<path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>' },
  storefront:     { label:'Storefront',    icon:'<path d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>' },
  admin:          { label:'Admin',         icon:'<path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/>' },
  team:           { label:'Team',          icon:'<path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>' },
};

const STATUS_FLOW = ['intake','quote','design','production','fulfillment','complete'];
const STATUS_LABELS = {intake:'Intake',quote:'Quoted',design:'Design',production:'Production',fulfillment:'Fulfillment',complete:'Complete',cancelled:'Cancelled'};

// ═══════════════════ BOOT ═══════════════════
async function boot() {
  const params = new URLSearchParams(window.location.search);
  const storefrontToken = params.get('storefront_token') || params.get('token');
  if (storefrontToken && sb) {
    hide('loadingScreen');
    try {
      const { data, error } = await sb.rpc('get_public_storefront', { token: storefrontToken });
      if (error) { document.body.innerHTML = '<div class="err" style="margin:20px">Storefront not found or inactive.</div>'; return; }
      if (data) { renderPublicStorefront(data, storefrontToken); return; }
    } catch (e) { console.error('[PublicStorefront]', e); document.body.innerHTML = '<div class="err" style="margin:20px">Failed to load storefront.</div>'; return; }
  }
  if (!sb) { hide('loadingScreen'); show('loginPage'); document.body.insertAdjacentHTML('beforeend', '<div class="err" style="margin:20px">Failed to load Supabase. Check your connection.</div>'); return; }
  try {
    const { data: { session } } = await sb.auth.getSession();
    if (session) await loadProfile(session.user);
    else showLogin();
  } catch (e) { hide('loadingScreen'); show('loginPage'); console.error('[Boot]', e); }
}

async function loadProfile(user) {
  CU = user;
  const { data: p } = await sb.from('users').select('*').eq('id', user.id).single();
  if (!p) {
    const { data: np, error: insErr } = await sb.from('users').insert({
      id: user.id, email: user.email,
      full_name: user.user_metadata?.full_name || user.email.split('@')[0],
      role: 'admin'
    }).select().single();
    if (insErr) { console.error(insErr); CP = { id: user.id, email: user.email, full_name: user.email.split('@')[0], role: 'admin' }; }
    else CP = np;
  } else { CP = p; }
  showApp();
}

function showLogin() {
  hide('loadingScreen'); show('loginPage'); hide('appShell');
}
function showApp() {
  hide('loadingScreen'); hide('loginPage'); show('appShell');
  const name = CP?.full_name || (CU && CU.email) || 'User';
  const role = CP?.role || 'admin';
  const av = $('sbAvatar'), nm = $('sbName'), b = $('sbBadge');
  if (av) av.textContent = name.charAt(0).toUpperCase();
  if (nm) nm.textContent = name;
  if (b) { b.textContent = role.replace('_',' '); b.className = 'role-badge badge-' + role; }
  buildNav(role);
  go('dashboard');
}

async function doLogin() {
  if (!sb) return;
  const email = v('loginEmail'), pass = v('loginPass');
  const errEl = $('loginErr');
  if (!email || !pass) { showErr(errEl, 'Please enter your email and password'); return; }
  const btn = $('loginBtn'); if (btn) { btn.disabled = true; btn.textContent = 'Signing in...'; }
  const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
  if (btn) { btn.disabled = false; btn.textContent = 'Sign In'; }
  if (error) { showErr(errEl, error.message); return; }
  if (errEl) errEl.style.display = 'none';
  if (data && data.user) await loadProfile(data.user);
}

async function doSignOut() {
  if (sb) await sb.auth.signOut();
  CU = null; CP = null;
  showLogin();
}

// ═══════════════════ PUBLIC STOREFRONT (no auth) ═══════════════════
function renderPublicStorefront(data, token) {
  window._publicStorefrontData = data;
  window._publicStorefrontToken = token;
  const products = data.products || [];
  const price = (p) => p.price_override != null ? Number(p.price_override) : Number(p.base_price);
  document.body.innerHTML = `
  <div class="main-content" style="max-width:800px;margin:0 auto;padding:24px">
    <div class="page-header"><h1>${escapeHtml(data.name || 'Storefront')}</h1>
    ${data.delivery_estimate_text ? `<p class="section-sub">${escapeHtml(data.delivery_estimate_text)}</p>` : ''}
    ${data.closes_at ? `<p style="font-size:12px;color:#6b7280">Closes ${fmtDate(data.closes_at)}</p>` : ''}</div>
    <div class="card-grid" id="publicStorefrontProducts"></div>
    <div id="publicStorefrontForm" style="display:none;margin-top:24px" class="form-card">
      <h3 style="margin-bottom:12px">Place order</h3>
      <div class="form-group"><label>Name *</label><input class="form-input" id="ps_name" placeholder="Your name"></div>
      <div class="form-group"><label>Email *</label><input class="form-input" id="ps_email" type="email" placeholder="you@example.com"></div>
      <div id="ps_items"></div>
      <button class="btn btn-blue btn-full" onclick="submitPublicStorefrontOrder()">Submit Order</button>
    </div>
    <div id="publicStorefrontMsg"></div>
  </div>`;
  const el = document.getElementById('publicStorefrontProducts');
  if (!el) return;
  if (!products.length) { el.innerHTML = '<p style="color:#6b7280">No products available.</p>'; return; }
  el.innerHTML = products.map((p, i) => `
    <div class="order-card">
      <div style="font-size:15px;font-weight:600;margin-bottom:4px">${escapeHtml(p.name)}</div>
      ${p.short_description ? `<div style="font-size:12px;color:#6b7280;margin-bottom:8px">${escapeHtml(p.short_description)}</div>` : ''}
      <div style="font-size:18px;font-weight:700;color:#0f75bc">$${price(p).toFixed(2)}</div>
      <button class="btn btn-blue btn-sm" style="margin-top:8px" onclick="openPublicStorefrontOrder()">Place Order</button>
    </div>`).join('');
}

function openPublicStorefrontOrder() {
  const products = (window._publicStorefrontData && window._publicStorefrontData.products) || [];
  document.getElementById('publicStorefrontForm').style.display = 'block';
  const container = document.getElementById('ps_items');
  if (container) container.innerHTML = products.map((p, i) => {
    const pr = p.price_override != null ? Number(p.price_override) : Number(p.base_price);
    return `<div class="form-row" style="align-items:center"><div class="form-group" style="flex:1"><label>${escapeHtml(p.name)} — $${pr.toFixed(2)}</label><input type="number" min="0" class="form-input" id="ps_qty_${i}" placeholder="Qty" value="0"></div></div>`;
  }).join('');
}

async function submitPublicStorefrontOrder() {
  const token = window._publicStorefrontToken;
  const name = document.getElementById('ps_name')?.value?.trim();
  const email = document.getElementById('ps_email')?.value?.trim();
  const msgEl = document.getElementById('publicStorefrontMsg');
  if (!name || !email) { if (msgEl) { msgEl.className = 'err'; msgEl.style.display = 'block'; msgEl.textContent = 'Name and email required.'; } return; }
  const items = [];
  document.querySelectorAll('[id^="ps_qty_"]').forEach((inp, i) => { const q = parseInt(inp.value, 10); if (q > 0) items.push({ index: i, qty: q }); });
  if (!items.length) { if (msgEl) { msgEl.className = 'err'; msgEl.style.display = 'block'; msgEl.textContent = 'Add at least one item.'; } return; }
  if (!sb || !token) { if (msgEl) { msgEl.className = 'err'; msgEl.style.display = 'block'; msgEl.textContent = 'Session expired.'; } return; }
  const { data: sf } = await sb.from('storefronts').select('id').eq('public_token', token).single();
  if (!sf) { if (msgEl) { msgEl.className = 'err'; msgEl.style.display = 'block'; msgEl.textContent = 'Storefront not found.'; } return; }
  const { error } = await sb.from('storefront_orders').insert({ storefront_id: sf.id, buyer_name: name, buyer_email: email, items: items, status: 'pending' });
  if (error) { if (msgEl) { msgEl.className = 'err'; msgEl.style.display = 'block'; msgEl.textContent = error.message; } return; }
  if (msgEl) { msgEl.className = 'suc'; msgEl.style.display = 'block'; msgEl.textContent = 'Order submitted. We\'ll be in touch!'; }
  document.getElementById('publicStorefrontForm').style.display = 'none';
}

// ═══════════════════ NAV ═══════════════════
function buildNav(role) {
  const pages = NAV_ROLES[role] || ['dashboard'];
  const navEl = $('sbNav'); if (!navEl) return;
  navEl.innerHTML = pages.map(p => {
    const d = NAV_DEFS[p];
    return `<div class="nav-item" id="nav-${p}" onclick="go('${p}')">
      <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">${d.icon}</svg>
      ${d.label}
    </div>`;
  }).join('');
}

function go(page) {
  PAGE = page;
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  const el = document.getElementById('nav-' + page);
  if (el) el.classList.add('active');
  const renders = {
    dashboard: pgDashboard,
    'quote-request': pgQuote,
    chapters: pgChapters,
    'design-queue': pgDesignQueue,
    approvals: pgApprovals,
    fulfillment: pgFulfillment,
    storefront: pgStorefront,
    admin: pgAdmin,
    team: pgTeam,
  };
  (renders[page] || pgDashboard)();
}

function setTab(c, el, fn) {
  if (typeof c === 'string') c = document.getElementById(c);
  if (!c) return;
  c.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  if (fn) fn();
}

// ═══════════════════ HELPERS ═══════════════════
const v = id => document.getElementById(id)?.value?.trim() || '';
const $ = id => document.getElementById(id);
function show(id) { const el = typeof id === 'string' ? $(id) : id; if (el) el.style.display = 'flex'; }
function hide(id) { const el = typeof id === 'string' ? $(id) : id; if (el) el.style.display = 'none'; }
function showErr(el, msg) { if (el) { el.className = 'err'; el.textContent = msg; el.style.display = 'block'; } }
function mc(id, html) { const el = $(id); if (el) el.innerHTML = html; }
function escapeHtml(str) { if (str == null) return ''; const s = String(str); const div = document.createElement('div'); div.textContent = s; return div.innerHTML; }
function escJs(s) { if (s == null) return ''; return String(s).replace(/\\/g, '\\\\').replace(/'/g, "\\'"); }

function timeAgo(d) {
  const diff = Date.now() - new Date(d).getTime();
  const m = Math.floor(diff / 60000);
  if (m < 1) return 'just now';
  if (m < 60) return m + 'm ago';
  const h = Math.floor(m / 60);
  if (h < 24) return h + 'h ago';
  return Math.floor(h / 24) + 'd ago';
}

function fmtDate(d) {
  if (!d) return '—';
  return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function orderDisplayName(o) {
  if (o.client_name) return escapeHtml(o.client_name);
  if (o.chapter_id && window._chapterMap && window._chapterMap[o.chapter_id]) return escapeHtml(window._chapterMap[o.chapter_id].chapter_name || window._chapterMap[o.chapter_id].school || '—');
  return '—';
}

// Stub for AI summary (replace with server-side OpenAI call later)
function summarizeOrder(order) {
  if (!order) return '—';
  const parts = [];
  if (order.garment_type) parts.push(order.garment_type);
  if (order.estimated_qty_min || order.estimated_qty_max) parts.push((order.estimated_qty_min || order.estimated_qty_max) + ' units');
  if (order.order_context) parts.push(order.order_context);
  if (order.event_name) parts.push(order.event_name);
  return parts.length ? parts.join(' · ') : (order.design_direction || '').slice(0, 60) + (order.design_direction && order.design_direction.length > 60 ? '…' : '') || '—';
}

async function auditLog(action, entityType, entityId, payload) {
  if (!sb || !CU) return;
  try {
    await sb.from('audit_log').insert({ user_id: CU.id, action, entity_type: entityType, entity_id: entityId, payload: payload || null });
  } catch (e) { console.warn('[audit_log]', e); }
}

function pill(status) {
  return `<span class="pill pill-${status}">${STATUS_LABELS[status] || status}</span>`;
}

function flowBar(currentStatus) {
  const steps = STATUS_FLOW;
  const ci = steps.indexOf(currentStatus);
  return `<div class="flow-bar">${steps.map((s, i) => {
    const cls = i < ci ? 'done' : i === ci ? 'current' : '';
    const arrow = i < steps.length - 1 ? `<div class="flow-arrow ${i < ci ? 'done' : ''}"></div>` : '';
    return `<div class="flow-step"><div class="flow-node ${cls}">${STATUS_LABELS[s]}</div>${arrow}</div>`;
  }).join('')}</div>`;
}

function emptyState(msg, btnLabel, btnFn) {
  return `<div class="empty">
    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
    <p>${msg}</p>
    ${btnLabel ? `<button class="btn btn-blue" onclick="${btnFn}">${btnLabel}</button>` : ''}
  </div>`;
}

async function updateStatus(id, status) {
  const { error } = await sb.from('orders').update({ status, updated_at: new Date().toISOString() }).eq('id', id);
  if (error) { alert('Error: ' + error.message); return false; }
  auditLog('order_status_change', 'order', id, { status });
  return true;
}

// ═══════════════════ DASHBOARD ═══════════════════
async function pgDashboard() {
  mc('mainContent', `<div class="page">
    <div class="page-header"><h1>Dashboard</h1><p>Live overview of orders and pipeline</p></div>
    <div id="dErr" class="err" style="display:none"></div>
    <div class="stat-grid" id="dStats"><div class="stat-card"><div class="spinner-sm"></div></div></div>
    <div class="quick-grid">
      <div class="quick-card" onclick="go('quote-request')"><div class="quick-icon"><svg fill="none" viewBox="0 0 24 24" stroke="#0f75bc" stroke-width="2"><path d="M12 4v16m8-8H4"/></svg></div><div class="quick-info"><strong>New Quote</strong><span>Start intake</span></div></div>
      <div class="quick-card" onclick="go('chapters')"><div class="quick-icon"><svg fill="none" viewBox="0 0 24 24" stroke="#2563eb" stroke-width="2"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M17 16h2m-2 0h-5m-9 0H3"/></svg></div><div class="quick-info"><strong>Chapters</strong><span>CRM</span></div></div>
      <div class="quick-card" onclick="go('design-queue')"><div class="quick-icon"><svg fill="none" viewBox="0 0 24 24" stroke="#7c3aed" stroke-width="2"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg></div><div class="quick-info"><strong>Design Queue</strong><span>Active designs</span></div></div>
      <div class="quick-card" onclick="go('approvals')"><div class="quick-icon"><svg fill="none" viewBox="0 0 24 24" stroke="#16a34a" stroke-width="2"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div><div class="quick-info"><strong>Approvals</strong><span>Pending review</span></div></div>
      <div class="quick-card" onclick="go('fulfillment')"><div class="quick-icon"><svg fill="none" viewBox="0 0 24 24" stroke="#d97706" stroke-width="2"><path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg></div><div class="quick-info"><strong>Fulfillment</strong><span>Production & shipping</span></div></div>
    </div>
    <div class="section-card">
      <div class="section-title">Recent Orders</div>
      <div class="section-sub">Click any order to view details</div>
      <div id="dRecent"><div style="text-align:center;padding:20px"><div class="spinner-sm"></div></div></div>
    </div>
  </div>`);

  const dErr = $('dErr'); const dStatsEl = $('dStats'); const dRecent = $('dRecent');
  try {
    let q = sb.from('orders').select('*');
    if (CP?.role === 'sales_rep') q = q.eq('rep_id', CU.id);
    const { data: orders, error } = await q;
    if (error) throw error;
    const list = orders || [];
    const c = {};
    STATUS_FLOW.forEach(s => c[s] = 0);
    list.forEach(o => { if (c[o.status] !== undefined) c[o.status]++; });
    const now = Date.now(); const day = 24 * 60 * 60 * 1000;
    const due7 = list.filter(o => o.needed_by_date && !['complete','cancelled'].includes(o.status) && (new Date(o.needed_by_date) - now) <= 7 * day).length;
    const due14 = list.filter(o => o.needed_by_date && !['complete','cancelled'].includes(o.status) && (new Date(o.needed_by_date) - now) <= 14 * day).length;
    if (dStatsEl) dStatsEl.innerHTML = `
      <div class="stat-card"><div class="stat-bar" style="background:#0f75bc"></div><div><div class="stat-num">${(c.intake || 0) + (c.quote || 0)}</div><div class="stat-label">Pending Quotes</div></div></div>
      <div class="stat-card"><div class="stat-bar" style="background:#7c3aed"></div><div><div class="stat-num">${c.design || 0}</div><div class="stat-label">In Design</div></div></div>
      <div class="stat-card"><div class="stat-bar" style="background:#d97706"></div><div><div class="stat-num">${c.production || 0}</div><div class="stat-label">Production</div></div></div>
      <div class="stat-card"><div class="stat-bar" style="background:#16a34a"></div><div><div class="stat-num">${c.fulfillment || 0}</div><div class="stat-label">Ready to Ship</div></div></div>
      <div class="stat-card"><div><div class="stat-num">${due7}</div><div class="stat-label">Due in 7 days</div></div></div>
      <div class="stat-card"><div><div class="stat-num">${due14}</div><div class="stat-label">Due in 14 days</div></div></div>`;
    const recent = list.slice(0, 8);
    if (!recent.length) { mc('dRecent', emptyState('No orders yet.', 'Create First Quote', "go('quote-request')")); return; }
    if (dRecent) dRecent.innerHTML = recent.map(o => `
      <div class="activity-item" onclick="openOrder('${String(o.id).replace(/'/g, "\\'")}')">
        <div style="flex:1">
          <strong style="font-size:13px;font-weight:500;color:#111827">${orderDisplayName(o)}${o.event_name ? ' – ' + escapeHtml(o.event_name) : ''}</strong>
          <span style="font-size:11px;color:#9ca3af;display:block;margin-top:1px">${escapeHtml(o.order_number || '—')} · ${escapeHtml(o.garment_type || '—')} · Qty ${o.quantity ?? '—'} · ${timeAgo(o.created_at)}</span>
        </div>
        ${pill(o.status)} ${o.is_rush ? '<span class="pill pill-rush">RUSH</span>' : ''}
      </div>`).join('');
  } catch (e) {
    console.error('[Dashboard]', e);
    if (dErr) { dErr.textContent = e.message || 'Failed to load dashboard.'; dErr.style.display = 'block'; }
    if (dStatsEl) dStatsEl.innerHTML = '<div class="stat-card"><div class="stat-label">No data</div></div>';
    if (dRecent) dRecent.innerHTML = emptyState('Could not load orders.', null, null);
  }
}

// ═══════════════════ ORDER DETAIL MODAL ═══════════════════
async function openOrder(id) {
  const { data: o } = await sb.from('orders').select('*').eq('id', id).single();
  if (!o) return;
  const role = CP?.role;
  const canAdvance = ['admin','super_admin','fulfillment'].includes(role);
  const nextStatus = { intake:'quote', quote:'design', design:'production', production:'fulfillment', fulfillment:'complete' };
  const next = nextStatus[o.status];

  const modal = document.createElement('div');
  modal.className = 'modal-bg open';
  modal.id = 'orderModal';
  const _flow = flowBar(o.status);
  modal.innerHTML = `<div class="modal" style="max-width:560px">
    <div class="modal-header">
      <h2>${escapeHtml(o.client_name)}${o.event_name ? ' – ' + escapeHtml(o.event_name) : ''}</h2>
      <button class="modal-close" onclick="closeOrderModal()">×</button>
    </div>
    ${_flow}
    <div class="notes-box" style="margin-bottom:14px"><label>Summary (auto)</label>${escapeHtml(summarizeOrder(o))}</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px 24px;margin-bottom:16px">
      <div><div style="font-size:11px;color:#9ca3af;margin-bottom:2px">Order #</div><div style="font-family:monospace;font-size:13px">${escapeHtml(o.order_number || '—')}</div></div>
      <div><div style="font-size:11px;color:#9ca3af;margin-bottom:2px">Status</div>${pill(o.status)}</div>
      <div><div style="font-size:11px;color:#9ca3af;margin-bottom:2px">Garment</div><div style="font-size:13px;font-weight:500">${escapeHtml(o.garment_type || '—')}</div></div>
      <div><div style="font-size:11px;color:#9ca3af;margin-bottom:2px">Print Method</div><div style="font-size:13px;font-weight:500">${escapeHtml(o.print_method || '—')}</div></div>
      <div><div style="font-size:11px;color:#9ca3af;margin-bottom:2px">Quantity</div><div style="font-size:13px;font-weight:500">${o.quantity ?? '—'} units</div></div>
      <div><div style="font-size:11px;color:#9ca3af;margin-bottom:2px">Budget</div><div style="font-size:13px;font-weight:500">${o.budget != null ? '$' + Number(o.budget).toLocaleString() : '—'}</div></div>
      <div><div style="font-size:11px;color:#9ca3af;margin-bottom:2px">Due Date</div><div style="font-size:13px;font-weight:500">${escapeHtml(fmtDate(o.needed_by_date || o.timeline_date))}</div></div>
      <div><div style="font-size:11px;color:#9ca3af;margin-bottom:2px">Fulfillment</div><div style="font-size:13px;font-weight:500">${escapeHtml(o.fulfillment_type || 'bulk')}</div></div>
      <div><div style="font-size:11px;color:#9ca3af;margin-bottom:2px">Organization</div><div style="font-size:13px;font-weight:500">${escapeHtml(o.organization || '—')}</div></div>
      <div><div style="font-size:11px;color:#9ca3af;margin-bottom:2px">Rush</div><div style="font-size:13px;font-weight:500">${o.is_rush ? '⚡ Yes' : 'No'}</div></div>
    </div>
    ${o.design_notes ? `<div class="notes-box"><label>Design Brief</label>${escapeHtml(o.design_notes)}</div>` : ''}
    <div style="font-size:11px;color:#9ca3af;margin-bottom:14px">Created ${fmtDate(o.created_at)}</div>
    ${canAdvance && next ? `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <button class="btn btn-ghost btn-full" onclick="cancelOrder('${o.id}')">Cancel Order</button>
      <button class="btn btn-blue btn-full" onclick="advanceOrder('${o.id}','${next}')">Move to ${STATUS_LABELS[next]} →</button>
    </div>` : ''}
    ${o.status === 'complete' ? '<div style="text-align:center;padding:12px;color:#16a34a;font-weight:600">✓ Order Complete</div>' : ''}
  </div>`;
  document.body.appendChild(modal);
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
}

function closeOrderModal() { document.getElementById('orderModal')?.remove(); }
async function advanceOrder(id, status) {
  const ok = await updateStatus(id, status);
  if (ok) { $('orderModal')?.remove(); go(PAGE); }
}

async function cancelOrder(id) {
  if (!confirm('Cancel this order?')) return;
  const ok = await updateStatus(id, 'cancelled');
  if (ok) { $('orderModal')?.remove(); go(PAGE); }
}

// ═══════════════════ CHAPTERS ═══════════════════
async function pgChapters() {
  mc('mainContent', `<div class="page">
    <div class="page-header"><h1>Chapters</h1><p>Manage chapter profiles, contacts, and orders</p></div>
    <div id="chErr" class="err" style="display:none"></div>
    <div class="form-group" style="max-width:320px;margin-bottom:16px">
      <input type="text" class="form-input" id="chSearch" placeholder="Search by school or chapter name..." oninput="chSearchDebounce()">
    </div>
    <div id="chList"><div style="text-align:center;padding:24px"><div class="spinner-sm"></div></div></div>
    <div id="chDetail" style="display:none"></div>
  </div>`);
  await loadChaptersList();
}

let _chSearchTimeout = null;
function chSearchDebounce() {
  clearTimeout(_chSearchTimeout);
  _chSearchTimeout = setTimeout(() => chFilterList(), 200);
}

async function loadChaptersList() {
  const errEl = $('chErr'); const listEl = $('chList'); if (!listEl) return;
  const { data: chapters, error } = await sb.from('chapters').select('*').order('chapter_name');
  if (error) { console.error('[Chapters]', error); if (errEl) { errEl.textContent = error.message; errEl.style.display = 'block'; } listEl.innerHTML = emptyState('Failed to load chapters.', null, null); return; }
  window._chaptersList = chapters || [];
  window._chapterMap = {};
  (chapters || []).forEach(c => { window._chapterMap[c.id] = c; });
  const repIds = [...new Set((chapters || []).map(c => c.assigned_sales_rep).filter(Boolean))];
  if (repIds.length && (CP?.role === 'admin' || CP?.role === 'super_admin')) {
    const { data: users } = await sb.from('users').select('id,full_name').in('id', repIds);
    window._chapterUserMap = {}; (users || []).forEach(u => { window._chapterUserMap[u.id] = u.full_name || u.id; });
  } else { window._chapterUserMap = {}; }
  chFilterList();
}

function chFilterList() {
  const listEl = $('chList'); if (!listEl) return;
  const search = (v('chSearch') || '').toLowerCase();
  const list = (window._chaptersList || []).filter(c => !search || (c.school || '').toLowerCase().includes(search) || (c.chapter_name || '').toLowerCase().includes(search));
  if (!list.length) { listEl.innerHTML = emptyState('No chapters found.', null, null); return; }
  listEl.innerHTML = `<div class="card-grid">${list.map(c => `
    <div class="order-card" style="cursor:pointer" onclick="openChapterDetail('${c.id}')">
      <div class="card-header"><h3>${escapeHtml(c.chapter_name)}</h3><span class="pill pill-${c.status === 'active' ? 'complete' : 'cancelled'}">${c.status || 'active'}</span></div>
      <div class="card-sub">${escapeHtml(c.school || '—')} · ${escapeHtml(c.org_type || '')}</div>
      <div class="card-meta">
        <div class="meta-row"><label>Assigned</label><span>${escapeHtml((window._chapterUserMap && window._chapterUserMap[c.assigned_sales_rep]) || '—')}</span></div>
        <div class="meta-row"><label>Open orders</label><span id="chOpen_${c.id}">—</span></div>
      </div>
    </div>`).join('')}</div>`;
  list.forEach(c => loadChapterOpenCount(c.id));
}

function loadChapterOpenCount(chapterId) {
  sb.from('orders').select('id', { count: 'exact', head: true }).eq('chapter_id', chapterId).in('status', ['intake','quote','design','production','fulfillment']).then(({ count }) => {
    const el = $('chOpen_' + chapterId); if (el) el.textContent = count ?? 0;
  });
}

function chapterCanEdit(c) {
  if (!c || !CU) return false;
  return (CP?.role === 'admin' || CP?.role === 'super_admin') || (c.assigned_sales_rep === CU.id);
}

async function openChapterDetail(chapterId) {
  const detailEl = $('chDetail'); const listEl = $('chList'); if (!detailEl || !listEl) return;
  const c = window._chapterMap && window._chapterMap[chapterId]; if (!c) return;
  const canEdit = chapterCanEdit(c);
  const assignedName = (window._chapterUserMap && window._chapterUserMap[c.assigned_sales_rep]) || '—';
  listEl.style.display = 'none';
  detailEl.style.display = 'block';
  detailEl.innerHTML = `<div class="page"><div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
    <button class="btn btn-ghost btn-sm" onclick="closeChapterDetail()">← Back</button>
    <h1 style="margin:0">${escapeHtml(c.chapter_name)}</h1>
  </div>
  <div class="section-card">
    <div class="section-title">Chapter profile</div>
    <div class="card-meta"><div class="meta-row"><label>School</label><span>${escapeHtml(c.school || '—')}</span></div>
    <div class="meta-row"><label>Org type</label><span>${escapeHtml(c.org_type || '—')}</span></div>
    <div class="meta-row"><label>National org</label><span>${escapeHtml(c.national_org || '—')}</span></div>
    <div class="meta-row"><label>Campus</label><span>${escapeHtml(c.campus || '—')}</span></div>
    <div class="meta-row"><label>Assigned sales rep</label><span>${escapeHtml(assignedName)}</span></div></div>
    ${c.notes ? `<div class="notes-box"><label>Notes</label>${escapeHtml(c.notes)}</div>` : ''}
    ${canEdit ? `<button class="btn btn-blue btn-sm" style="margin-top:8px" onclick="openEditChapter('${chapterId}')">Edit chapter</button>` : ''}
  </div>
  <div class="section-card">
    <div class="section-title">Contacts</div>
    <div id="chContacts"><div class="spinner-sm"></div></div>
    ${canEdit ? `<button class="btn btn-blue btn-sm" style="margin-top:8px" onclick="openAddContact('${chapterId}')">+ Add Contact</button>` : ''}
  </div>
  <div class="section-card">
    <div class="section-title">Orders</div>
    <div id="chOrders"><div class="spinner-sm"></div></div>
    ${canEdit ? `<button class="btn btn-blue btn-sm" style="margin-top:8px" onclick="goToQuoteWithChapter('${chapterId}')">Create New Quote for this Chapter</button>` : ''}
  </div></div>`;
  await loadChapterContacts(chapterId);
  await loadChapterOrders(chapterId);
}

function openEditChapter(chapterId) {
  const c = window._chapterMap && window._chapterMap[chapterId]; if (!c) return;
  const canEdit = chapterCanEdit(c); if (!canEdit) return;
  const modal = document.createElement('div'); modal.className = 'modal-bg open'; modal.id = 'editChapterModal';
  modal.innerHTML = `<div class="modal" style="max-width:480px"><div class="modal-header"><h2>Edit chapter</h2><button class="modal-close" onclick="$('editChapterModal').remove()">×</button></div>
  <div id="ecMsg" class="err" style="display:none"></div>
  <div class="form-group"><label>School *</label><input class="form-input" id="ec_school" value="${escapeHtml(c.school || '')}"></div>
  <div class="form-group"><label>Chapter name *</label><input class="form-input" id="ec_chapter_name" value="${escapeHtml(c.chapter_name || '')}"></div>
  <div class="form-row"><div class="form-group"><label>Org type</label><input class="form-input" id="ec_org_type" value="${escapeHtml(c.org_type || '')}"></div><div class="form-group"><label>National org</label><input class="form-input" id="ec_national_org" value="${escapeHtml(c.national_org || '')}"></div></div>
  <div class="form-group"><label>Campus</label><input class="form-input" id="ec_campus" value="${escapeHtml(c.campus || '')}"></div>
  <div class="form-group"><label>Notes</label><textarea class="form-textarea" id="ec_notes" style="min-height:60px">${escapeHtml(c.notes || '')}</textarea></div>
  <div class="form-group" id="ecAssignWrap"><label>Assigned sales rep</label><select class="form-select" id="ec_assigned_sales_rep"><option value="">— None —</option></select></div>
  <button class="btn btn-blue btn-full" onclick="saveEditChapter('${chapterId}')">Save</button></div>`;
  document.body.appendChild(modal);
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
  if (CP?.role === 'admin' || CP?.role === 'super_admin') {
    sb.from('users').select('id,full_name').in('role', ['sales_rep', 'admin', 'super_admin']).then(({ data: users }) => {
      const sel = $('ec_assigned_sales_rep'); if (!sel) return;
      sel.innerHTML = '<option value="">— None —</option>' + (users || []).map(u => `<option value="${u.id}" ${u.id === c.assigned_sales_rep ? 'selected' : ''}>${escapeHtml(u.full_name || u.email || u.id)}</option>`).join('');
    });
  } else { const w = $('ecAssignWrap'); if (w) w.style.display = 'none'; }
}

async function saveEditChapter(chapterId) {
  const msg = $('ecMsg'); const school = v('ec_school'); const chapterName = v('ec_chapter_name');
  if (!school || !chapterName) { showErr(msg, 'School and chapter name required'); return; }
  const assigned = ($('ec_assigned_sales_rep') && $('ec_assigned_sales_rep').value) || null;
  const { error } = await sb.from('chapters').update({
    school, chapter_name: chapterName, org_type: v('ec_org_type') || null, national_org: v('ec_national_org') || null,
    campus: v('ec_campus') || null, notes: v('ec_notes') || null, assigned_sales_rep: assigned || null, updated_at: new Date().toISOString()
  }).eq('id', chapterId);
  if (error) { showErr(msg, error.message); return; }
  const c = window._chapterMap && window._chapterMap[chapterId]; if (c) { c.school = school; c.chapter_name = chapterName; c.assigned_sales_rep = assigned; }
  auditLog('chapter_updated', 'chapter', chapterId, null);
  $('editChapterModal')?.remove();
  openChapterDetail(chapterId);
}

function closeChapterDetail() {
  const detailEl = $('chDetail'); const listEl = $('chList'); if (detailEl) detailEl.style.display = 'none'; if (listEl) listEl.style.display = 'block'; detailEl.innerHTML = '';
}

function goToQuoteWithChapter(chapterId) {
  window._quotePrefillChapterId = chapterId;
  closeChapterDetail();
  go('quote-request');
}

async function loadChapterContacts(chapterId) {
  const el = $('chContacts'); if (!el) return;
  const { data: contacts, error } = await sb.from('chapter_contacts').select('*').eq('chapter_id', chapterId).order('is_primary', { ascending: false });
  if (error) { el.innerHTML = '<p class="err">Failed to load contacts.</p>'; return; }
  if (!contacts || !contacts.length) { el.innerHTML = '<p style="color:#6b7280">No contacts yet.</p>'; return; }
  el.innerHTML = `<table class="team-table"><thead><tr><th>Name</th><th>Role</th><th>Contact</th><th>Primary</th></tr></thead><tbody>
  ${contacts.map(cc => `<tr>
    <td>${escapeHtml(cc.name)}</td><td>${escapeHtml(cc.role_title || '—')}</td>
    <td>${escapeHtml(cc.email || cc.phone || '—')}</td>
    <td>${cc.is_primary ? '✓' : '—'}</td>
  </tr>`).join('')}</tbody></table>`;
}

async function loadChapterOrders(chapterId) {
  const el = $('chOrders'); if (!el) return;
  const { data: orders, error } = await sb.from('orders').select('*').eq('chapter_id', chapterId).order('created_at', { ascending: false }).limit(20);
  if (error) { el.innerHTML = '<p class="err">Failed to load orders.</p>'; return; }
  if (!orders || !orders.length) { el.innerHTML = '<p style="color:#6b7280">No orders yet.</p>'; return; }
  el.innerHTML = orders.map(o => `
    <div class="activity-item" onclick="openOrder('${o.id}')">
      <div style="flex:1"><strong>${orderDisplayName(o)}</strong> ${o.event_name ? ' – ' + escapeHtml(o.event_name) : ''}<span style="font-size:11px;color:#9ca3af;display:block">${escapeHtml(o.order_number || '—')} · ${fmtDate(o.needed_by_date || o.timeline_date)}</span></div>
      ${pill(o.status)}
    </div>`).join('');
}

function openAddContact(chapterId) {
  const modal = document.createElement('div');
  modal.className = 'modal-bg open'; modal.id = 'addContactModal';
  modal.innerHTML = `<div class="modal"><div class="modal-header"><h2>Add Contact</h2><button class="modal-close" onclick="$('addContactModal').remove()">×</button></div>
  <div id="acMsg" class="err" style="display:none"></div>
  <div class="form-group"><label>Name *</label><input class="form-input" id="ac_name" placeholder="Full name"></div>
  <div class="form-group"><label>Role / Title</label><input class="form-input" id="ac_role" placeholder="e.g. Merch Chair"></div>
  <div class="form-row"><div class="form-group"><label>Phone *</label><input class="form-input" id="ac_phone" placeholder="Required"></div><div class="form-group"><label>Email (optional)</label><input class="form-input" id="ac_email" type="email"></div></div>
  <div class="form-group"><label>Primary contact?</label><select class="form-select" id="ac_primary"><option value="false">No</option><option value="true">Yes</option></select></div>
  <button class="btn btn-blue btn-full" onclick="saveContact('${chapterId}')">Save Contact</button></div>`;
  document.body.appendChild(modal);
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
}

async function saveContact(chapterId) {
  const name = v('ac_name'); const phone = v('ac_phone'); const msgEl = $('acMsg');
  if (!name) { showErr(msgEl, 'Name required'); return; }
  if (!phone) { showErr(msgEl, 'Phone required'); return; }
  const primary = ($('ac_primary') && $('ac_primary').value) === 'true';
  const { error } = await sb.from('chapter_contacts').insert({ chapter_id: chapterId, name, role_title: v('ac_role'), email: v('ac_email'), phone: v('ac_phone'), is_primary: primary });
  if (error) { showErr(msgEl, error.message); return; }
  auditLog('chapter_contact_added', 'chapter', chapterId, null);
  $('addContactModal')?.remove();
  loadChapterContacts(chapterId);
}

// ═══════════════════ QUOTE REQUEST (Intake Wizard) ═══════════════════
const INTAKE_STEPS = ['chapter','orderType','specs','design','timeline','invoice'];
const INTAKE_STEP_LABELS = ['Chapter','Order Type','Specs','Design Direction','Timeline & Delivery','Invoice'];
let _intakeStep = 0;
let _intakeDraftId = null;
let _intakeRefUrls = []; // reference image URLs after upload

const ORDER_CONTEXTS = ['Event','General / Ongoing Merch','Rush / Recruitment','Philanthropy','Formal / Social','Intramurals / Sports','Parent Weekend','Alumni'];

function pgQuote() {
  _intakeStep = 0;
  _intakeRefUrls = [];
  const prefillId = window._quotePrefillChapterId || null;
  window._quotePrefillChapterId = null;
  mc('mainContent', `<div class="page">
    <div class="page-header"><h1>New Quote / Order Intake</h1><p>Guided intake — complete all steps to submit to design</p></div>
    <div id="quoteMsg" class="err" style="display:none"></div>
    <div id="quoteStepErrors" class="err" style="display:none;margin-bottom:12px"></div>
    <div class="wizard-steps" id="intakeWizardSteps"></div>
    <div id="intakeStepContent"></div>
    <div id="intakeActions" style="margin-top:20px"></div>
  </div>`);
  renderIntakeWizardSteps();
  renderIntakeStep(prefillId);
}

function renderIntakeWizardSteps() {
  const el = $('intakeWizardSteps'); if (!el) return;
  el.innerHTML = INTAKE_STEPS.map((s, i) => `<div class="wizard-step ${i === _intakeStep ? 'active' : i < _intakeStep ? 'done' : ''}" onclick="setIntakeStep(${i})">${INTAKE_STEP_LABELS[i]}</div>`).join('');
}

function setIntakeStep(i) { _intakeStep = i; renderIntakeWizardSteps(); renderIntakeStep(null); updateIntakeButtons(); }

function intakeValidation(step) {
  const missing = [];
  if (step === 0) {
    const existing = ($('q_chapter_existing') && $('q_chapter_existing').checked);
    if (existing) {
      const chVal = $('q_chapter') && $('q_chapter').value;
      if (!chVal) missing.push('Select a chapter');
    } else {
      if (!v('q_school')) missing.push('School');
      if (!v('q_chapter_name')) missing.push('Chapter name');
      if (!v('q_contact_name')) missing.push('Contact name');
      if (!v('q_contact_phone')) missing.push('Contact phone');
    }
  } else if (step === 1) {
    if (!($('q_order_type') && $('q_order_type').value)) missing.push('Order type');
    if (!($('q_order_context') && $('q_order_context').value)) missing.push('Order context');
    const ctx = $('q_order_context') && $('q_order_context').value;
    if (ctx === 'Event' && !v('q_event_date')) missing.push('Event date');
  } else if (step === 2) {
    const qtyMin = parseInt(v('q_qty_min'), 10); const qtyMax = parseInt(v('q_qty_max'), 10);
    if (!(qtyMin >= 1 && qtyMax >= qtyMin)) missing.push('Valid quantity range (min ≤ max)');
    if (!v('q_colors')) missing.push('Garment colors');
    if (!v('q_print_locations')) missing.push('Print locations');
  } else if (step === 3) {
    if (!v('q_design_direction') || v('q_design_direction').length < 20) missing.push('Design direction (2–3 sentences)');
    if (!v('q_required_text')) missing.push('Required text');
    const refs = (v('q_ref_links') || '').split(/[\n,]/).map(s => s.trim()).filter(Boolean);
    const hasRefs = refs.length > 0 || (_intakeRefUrls && _intakeRefUrls.length > 0);
    if (!hasRefs) missing.push('Reference links or upload at least one image');
  } else if (step === 4) {
    if (!v('q_needed_by')) missing.push('Needed by date');
    if (!($('q_delivery') && $('q_delivery').value)) missing.push('Delivery method');
  } else if (step === 5) {
    if (!v('q_invoice_email')) missing.push('Invoice email');
  }
  return { ok: missing.length === 0, missing };
}

function updateIntakeButtons() {
  const errEl = $('quoteStepErrors'); const actions = $('intakeActions');
  const v = intakeValidation(_intakeStep);
  if (errEl) { errEl.style.display = v.ok ? 'none' : 'block'; errEl.textContent = v.ok ? '' : 'Missing: ' + v.missing.join(', '); }
  const nextBtn = document.querySelector('#intakeActions button[onclick^="setIntakeStep"]');
  const submitBtn = $('btnSubmitToDesign');
  if (nextBtn) nextBtn.disabled = !v.ok;
  if (submitBtn) submitBtn.disabled = !v.ok;
}

function renderIntakeStep(prefillChapterId) {
  const content = $('intakeStepContent'); const actions = $('intakeActions'); if (!content) return;
  if (_intakeStep === 0) {
    content.innerHTML = `<div class="form-card">
      <div class="form-section"><div class="form-section-title">Is this an existing chapter we work with?</div>
      <div class="form-group" style="display:flex;gap:16px;margin-bottom:16px">
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="radio" name="q_chapter_choice" id="q_chapter_existing" onchange="toggleIntakeChapterForm()"> Existing</label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="radio" name="q_chapter_choice" id="q_chapter_new" onchange="toggleIntakeChapterForm()"> New</label>
      </div>
      <div id="q_existing_block" style="display:none">
        <div class="form-group"><label>Select chapter *</label><input type="text" class="form-input" id="q_chapter_search" placeholder="Search school or chapter..." oninput="filterChapterSelect()"><select class="form-select" id="q_chapter" style="margin-top:6px" onchange="onIntakeChapterSelect()"><option value="">— Select —</option></select></div>
      </div>
      <div id="q_new_block" style="display:none">
        <div class="form-section-title" style="margin-top:8px">Create New Chapter</div>
        <div class="form-row"><div class="form-group"><label>School *</label><input class="form-input" id="q_school" placeholder="e.g. Ohio State"></div><div class="form-group"><label>Chapter name *</label><input class="form-input" id="q_chapter_name" placeholder="e.g. Alpha Phi"></div></div>
        <div class="form-row"><div class="form-group"><label>Org type (optional)</label><input class="form-input" id="q_org_type" placeholder="Fraternity / Sorority"></div><div class="form-group"><label>Notes (optional)</label><input class="form-input" id="q_notes" placeholder=""></div></div>
        <div class="form-section-title" style="margin-top:16px">Primary contact</div>
        <div class="form-group"><label>Contact name *</label><input class="form-input" id="q_contact_name" placeholder="Full name"></div>
        <div class="form-row"><div class="form-group"><label>Contact phone *</label><input class="form-input" id="q_contact_phone" placeholder="Required"></div><div class="form-group"><label>Contact email (optional)</label><input class="form-input" id="q_contact_email" type="email"></div></div>
        <div class="form-group"><label>Role / title (optional)</label><input class="form-input" id="q_contact_role" placeholder="e.g. Merch Chair"></div>
      </div>
      </div></div>`;
    document.getElementById('q_chapter_new').checked = true; toggleIntakeChapterForm();
    loadChapterSelect(prefillChapterId);
  } else if (_intakeStep === 1) {
    content.innerHTML = `<div class="form-card">
      <div class="form-section"><div class="form-section-title">Order Type *</div>
      <div class="form-group"><label>Order type *</label><select class="form-select" id="q_order_type"><option value="">— Select —</option><option value="quote">Quote</option><option value="order">Order</option></select></div>
      <div class="form-section-title">Order Context *</div>
      <div class="form-group"><label>Order context *</label><select class="form-select" id="q_order_context" onchange="toggleEventDateField()">${ORDER_CONTEXTS.map(x => `<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join('')}</select></div>
      <div id="q_event_date_block" style="display:none" class="form-group"><label>Event date *</label><input class="form-input" id="q_event_date" type="date"></div>
      <div class="form-group" id="q_event_subtype_block" style="display:none"><label>Event subtype</label><select class="form-select" id="q_event_subtype"><option value="formal">Formal</option><option value="recruitment">Recruitment</option><option value="philanthropy">Philanthropy</option><option value="other">Other</option></select></div>
      </div></div>`;
  } else if (_intakeStep === 2) {
    content.innerHTML = `<div class="form-card">
      <div class="form-section"><div class="form-section-title">Order Specs</div>
      <div class="form-row"><div class="form-group"><label>Garment type *</label><select class="form-select" id="q_garment"><option value="tee">T-Shirt</option><option value="hoodie">Hoodie</option><option value="crewneck">Crewneck</option><option value="tank">Tank</option><option value="longsleeve">Long Sleeve</option><option value="polo">Polo</option><option value="hat">Hat</option><option value="other">Other</option></select></div><div class="form-group"><label>Fit *</label><select class="form-select" id="q_fit"><option value="standard">Standard</option><option value="oversized">Oversized</option><option value="heavyweight">Heavyweight</option></select></div></div>
      <div class="form-group"><label>Pocket tee? (Print pocket?)</label><select class="form-select" id="q_pocket_tee"><option value="false">No</option><option value="true">Yes</option></select></div>
      <div class="form-group"><label>Estimated qty range *</label><div class="form-row"><input class="form-input" id="q_qty_min" type="number" min="1" placeholder="Min"><input class="form-input" id="q_qty_max" type="number" min="1" placeholder="Max"></div></div>
      <div class="form-group"><label>Garment colors (comma-separated) *</label><input class="form-input" id="q_colors" placeholder="e.g. Navy, White"></div>
      <div class="form-group"><label>Print locations *</label><input class="form-input" id="q_print_locations" placeholder="e.g. front, back, sleeve"></div>
      <div class="form-group"><label>Budget range (optional)</label><select class="form-select" id="q_budget_range"><option value="">— Optional —</option><option value="under_20">Under $20</option><option value="20_25">$20–25</option><option value="25_30">$25–30</option><option value="open">Open</option></select></div>
      </div></div>`;
  } else if (_intakeStep === 3) {
    content.innerHTML = `<div class="form-card">
      <div class="form-section"><div class="form-section-title">Design Direction *</div>
      <div class="form-group"><label>Design direction (2–3 sentences) *</label><textarea class="form-textarea" id="q_design_direction" placeholder="Describe the vibe, colors, placement..." oninput="updateIntakeButtons()"></textarea><span id="q_design_err" class="err" style="display:none;font-size:12px;margin-top:4px"></span></div>
      <div class="form-group"><label>Required text *</label><input class="form-input" id="q_required_text" placeholder="Text that must appear" oninput="updateIntakeButtons()"></div>
      <div class="form-group"><label>Reference links (one per line) OR upload images — at least one required</label><textarea class="form-textarea" id="q_ref_links" placeholder="https://..." style="min-height:60px" oninput="updateIntakeButtons()"></textarea></div>
      <div class="form-group"><label>Upload reference images (PNG/JPG/PDF)</label><input type="file" class="form-input" id="q_ref_uploads" accept=".png,.jpg,.jpeg,.pdf" multiple onchange="onIntakeRefUpload()"><div id="q_ref_upload_list" style="font-size:12px;color:#6b7280;margin-top:6px"></div></div>
      <div class="form-group"><label>Must-haves (optional)</label><textarea class="form-textarea" id="q_must_haves" style="min-height:60px"></textarea></div>
      <div class="form-group"><label>Deal-breakers (optional)</label><textarea class="form-textarea" id="q_dealbreakers" style="min-height:60px"></textarea></div>
      <button class="btn btn-green" id="btnSubmitToDesign" onclick="submitToDesignFromIntake()">Submit to Design</button>
      <p style="font-size:12px;color:#6b7280;margin-top:12px">After submitting to design you can continue to Timeline &amp; Invoice.</p>
      </div></div>`;
  } else if (_intakeStep === 4) {
    content.innerHTML = `<div class="form-card">
      <div class="form-section"><div class="form-section-title">Timeline &amp; Delivery *</div>
      <div class="form-group"><label>Needed by date *</label><input class="form-input" id="q_needed_by" type="date" onchange="updateTimelineRisk();updateIntakeButtons()"></div>
      <div id="timelineRiskBanner"></div>
      <div class="form-group"><label>Delivery method *</label><select class="form-select" id="q_delivery"><option value="ship">Ship</option><option value="pickup">Pickup</option><option value="vendor">Vendor</option></select></div>
      <div class="form-group"><label>Internal timeline notes</label><input class="form-input" id="q_timeline_notes" placeholder="SLA estimate etc."></div>
      </div></div>`;
  } else {
    const pc = window._intakePrimaryContact || {};
    content.innerHTML = `<div class="form-card">
      <div class="form-section"><div class="form-section-title">Invoice &amp; Contacts *</div>
      <div class="form-group"><label>Invoice email *</label><input class="form-input" id="q_invoice_email" type="email" placeholder="billing@chapter.org" value="${escapeHtml(pc.email || '')}" oninput="updateIntakeButtons()"></div>
      <div class="form-group"><label>Primary contact name</label><input class="form-input" id="q_contact_name" placeholder="Full name" value="${escapeHtml(pc.name || '')}"></div>
      <div class="form-group"><label>Primary contact phone</label><input class="form-input" id="q_contact_phone" placeholder="Phone" value="${escapeHtml(pc.phone || '')}"></div>
      </div></div>`;
  }
  const prev = _intakeStep > 0 ? `<button class="btn btn-ghost" onclick="setIntakeStep(${_intakeStep - 1})">← Back</button>` : '';
  const next = _intakeStep < INTAKE_STEPS.length - 1 ? `<button class="btn btn-blue" id="btnIntakeNext" onclick="setIntakeStep(${_intakeStep + 1})">Next →</button>` : '';
  const draft = `<button class="btn btn-ghost" onclick="saveIntakeDraft()">Save Draft</button>`;
  const finish = _intakeStep === INTAKE_STEPS.length - 1 ? `<button class="btn btn-green" id="btnIntakeFinish" onclick="saveIntakeInvoiceAndFinish()">Save invoice & finish</button>` : '';
  if (actions) actions.innerHTML = [prev, draft, next, finish].filter(Boolean).join(' ');
  if (_intakeStep === 1) toggleEventDateField();
  if (_intakeStep === 4) updateTimelineRisk();
  setTimeout(updateIntakeButtons, 50);
}

function toggleIntakeChapterForm() {
  const existing = $('q_chapter_existing') && $('q_chapter_existing').checked;
  const exBl = $('q_existing_block'); const newBl = $('q_new_block');
  if (exBl) exBl.style.display = existing ? 'block' : 'none';
  if (newBl) newBl.style.display = existing ? 'none' : 'block';
  updateIntakeButtons();
}

function toggleEventDateField() {
  const ctx = $('q_order_context') && $('q_order_context').value;
  const isEvent = ctx === 'Event';
  const bl = $('q_event_date_block'); const sub = $('q_event_subtype_block');
  if (bl) bl.style.display = isEvent ? 'block' : 'none';
  if (sub) sub.style.display = isEvent ? 'block' : 'none';
  updateIntakeButtons();
}

function filterChapterSelect() {
  const search = (v('q_chapter_search') || '').toLowerCase();
  const sel = $('q_chapter'); if (!sel) return;
  const opts = sel.querySelectorAll('option');
  opts.forEach((o, i) => { if (i === 0) return; o.style.display = !search || o.textContent.toLowerCase().includes(search) ? '' : 'none'; });
}

async function loadChapterSelect(prefillId) {
  const { data: list } = await sb.from('chapters').select('id,chapter_name,school').order('chapter_name');
  const sel = $('q_chapter'); if (!sel) return;
  sel.innerHTML = '<option value="">— Select —</option>' + (list || []).map(c => `<option value="${c.id}" ${prefillId === c.id ? 'selected' : ''}>${escapeHtml(c.chapter_name)} · ${escapeHtml(c.school || '')}</option>`).join('');
  if (prefillId && list && list.find(c => c.id === prefillId)) { document.getElementById('q_chapter_existing').checked = true; toggleIntakeChapterForm(); onIntakeChapterSelect(); }
}

async function onIntakeChapterSelect() {
  const chId = $('q_chapter') && $('q_chapter').value;
  if (!chId || !sb) return;
  const { data: primary } = await sb.from('chapter_contacts').select('name,phone,email').eq('chapter_id', chId).eq('is_primary', true).limit(1).single();
  window._intakePrimaryContact = primary || null;
}

async function onIntakeRefUpload() {
  const input = $('q_ref_uploads'); if (!input || !input.files || !input.files.length || !sb) return;
  const orderId = _intakeDraftId; if (!orderId) { showErr($('quoteMsg'), 'Save draft first to upload files.'); return; }
  const listEl = $('q_ref_upload_list'); const msg = $('quoteMsg'); msg.style.display = 'none';
  for (let i = 0; i < input.files.length; i++) {
    const file = input.files[i]; const ext = (file.name.split('.').pop() || '').toLowerCase();
    if (!['png','jpg','jpeg','pdf'].includes(ext)) { showErr(msg, 'Only PNG, JPG, PDF allowed.'); continue; }
    const path = `orders/${orderId}/refs/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
    const { data, error } = await sb.storage.from('intake-assets').upload(path, file, { upsert: true });
    if (error) { showErr(msg, 'Upload failed: ' + error.message); continue; }
    const { data: urlData } = sb.storage.from('intake-assets').getPublicUrl(data.path);
    _intakeRefUrls = _intakeRefUrls || []; _intakeRefUrls.push(urlData.publicUrl);
  }
  if (listEl) listEl.textContent = (_intakeRefUrls && _intakeRefUrls.length) ? _intakeRefUrls.length + ' file(s) uploaded' : '';
  updateIntakeButtons();
  input.value = '';
}

function updateTimelineRisk() {
  const needed = v('q_needed_by'); const banner = $('timelineRiskBanner'); if (!banner) return;
  if (!needed) { banner.innerHTML = ''; return; }
  const days = Math.ceil((new Date(needed) - new Date()) / (24 * 60 * 60 * 1000));
  let level = 'low', text = 'Comfortable timeline.';
  if (days < 14) { level = 'high'; text = 'High risk — under 14 days. Expedite production.'; } else if (days < 21) { level = 'medium'; text = 'Medium risk — 2–3 weeks. Confirm production capacity.'; }
  banner.innerHTML = `<div class="timeline-risk ${level}">${text} (${days} days until needed)</div>`;
}

function intakePayload() {
  const refLinks = (v('q_ref_links') || '').split(/[\n,]/).map(s => s.trim()).filter(Boolean);
  const needed = v('q_needed_by');
  let timelineRisk = 'low';
  if (needed) { const days = Math.ceil((new Date(needed) - new Date()) / (24 * 60 * 60 * 1000)); if (days < 14) timelineRisk = 'high'; else if (days < 21) timelineRisk = 'medium'; }
  const chapterId = ($('q_chapter') && $('q_chapter').value) || window._intakeDraftChapterId || null;
  const orderContext = ($('q_order_context') && $('q_order_context').value) || null;
  const eventDate = ($('q_order_context') && $('q_order_context').value === 'Event') ? v('q_event_date') : null;
  return {
    chapter_id: chapterId || null,
    client_name: v('q_chapter_name') || v('q_school') || '—',
    organization: v('q_school'),
    event_type: ($('q_event_subtype') && $('q_event_subtype').value) || 'general',
    event_date: eventDate || v('q_event_date') || null,
    order_context: orderContext,
    event_subtype: ($('q_event_subtype') && $('q_event_subtype').value) || null,
    pocket_tee: ($('q_pocket_tee') && $('q_pocket_tee').value) === 'true',
    needed_by_date: needed || null,
    timeline_date: needed,
    delivery_method: ($('q_delivery') && $('q_delivery').value) || 'ship',
    timeline_risk_level: timelineRisk,
    invoice_email: v('q_invoice_email'),
    budget_range: ($('q_budget_range') && $('q_budget_range').value) || null,
    estimated_qty_min: parseInt(v('q_qty_min'), 10) || null,
    estimated_qty_max: parseInt(v('q_qty_max'), 10) || null,
    quantity: parseInt(v('q_qty_max'), 10) || parseInt(v('q_qty_min'), 10) || null,
    garment_type: ($('q_garment') && $('q_garment').value) || 'tee',
    fit_type: ($('q_fit') && $('q_fit').value) || 'standard',
    garment_colors: (v('q_colors') || '').split(',').map(s => s.trim()).filter(Boolean),
    print_locations: (v('q_print_locations') || '').split(',').map(s => s.trim()).filter(Boolean),
    design_direction: v('q_design_direction'),
    required_text: v('q_required_text'),
    must_haves: v('q_must_haves'),
    dealbreakers: v('q_dealbreakers'),
    reference_links: refLinks,
    reference_images: _intakeRefUrls || [],
    internal_notes: v('q_timeline_notes'),
    created_by: CU.id,
    rep_id: CU.id,
    assigned_sales_rep: (CP?.role === 'sales_rep' ? CU.id : null),
    status: 'intake',
  };
}

async function ensureIntakeChapterAndOrder() {
  const existing = $('q_chapter_existing') && $('q_chapter_existing').checked;
  let chapterId = ($('q_chapter') && $('q_chapter').value) || null;
  if (!existing) {
    const school = v('q_school'); const chapterName = v('q_chapter_name');
    if (!school || !chapterName) return { ok: false, error: 'School and chapter name required' };
    const { data: ch, error: chErr } = await sb.from('chapters').insert({
      school, chapter_name: chapterName, org_type: v('q_org_type') || null, notes: v('q_notes') || null,
      assigned_sales_rep: (CP?.role === 'sales_rep' ? CU.id : null), status: 'active'
    }).select('id').single();
    if (chErr) return { ok: false, error: chErr.message };
    chapterId = ch.id;
    window._intakeDraftChapterId = ch.id;
    const contactName = v('q_contact_name'); const contactPhone = v('q_contact_phone');
    if (contactName || contactPhone) {
      await sb.from('chapter_contacts').insert({ chapter_id: ch.id, name: contactName || '—', phone: contactPhone || null, email: v('q_contact_email') || null, role_title: v('q_contact_role') || null, is_primary: true });
    }
  }
  let orderId = _intakeDraftId;
  const payload = intakePayload();
  payload.chapter_id = chapterId;
  if (orderId) {
    const { error } = await sb.from('orders').update({ ...payload, updated_at: new Date().toISOString() }).eq('id', orderId);
    if (error) return { ok: false, error: error.message };
  } else {
    const { data: row, error } = await sb.from('orders').insert(payload).select('id,chapter_id,organization,client_name').single();
    if (error) return { ok: false, error: error.message };
    orderId = row.id;
    _intakeDraftId = orderId;
    try {
      const { data: orderNum } = await sb.rpc('generate_order_number', { p_chapter_id: row.chapter_id, p_school: row.organization, p_chapter_name: row.client_name });
      if (orderNum) await sb.from('orders').update({ order_number: orderNum, updated_at: new Date().toISOString() }).eq('id', orderId);
    } catch (e) { console.warn('[order_number]', e); }
  }
  return { ok: true, orderId, chapterId };
}

async function saveIntakeDraft() {
  const msg = $('quoteMsg'); msg.style.display = 'none';
  const existing = $('q_chapter_existing') && $('q_chapter_existing').checked;
  let chapterId = ($('q_chapter') && $('q_chapter').value) || window._intakeDraftChapterId || null;
  if (!_intakeDraftId && !existing && ($('q_school') && $('q_chapter_name'))) {
    const school = v('q_school'); const chapterName = v('q_chapter_name');
    if (school && chapterName) {
      const { data: ch, error: chErr } = await sb.from('chapters').insert({
        school, chapter_name: chapterName, org_type: v('q_org_type') || null, notes: v('q_notes') || null,
        assigned_sales_rep: (CP?.role === 'sales_rep' ? CU.id : null), status: 'active'
      }).select('id').single();
      if (!chErr && ch) { chapterId = ch.id; window._intakeDraftChapterId = ch.id; }
    }
  }
  const payload = intakePayload();
  payload.chapter_id = chapterId;
  if (_intakeDraftId) {
    const { error } = await sb.from('orders').update({ ...payload, updated_at: new Date().toISOString() }).eq('id', _intakeDraftId);
    if (error) { showErr(msg, error.message); return; }
    msg.className = 'suc'; msg.style.display = 'block'; msg.textContent = 'Draft updated.';
    return;
  }
  const { data: row, error } = await sb.from('orders').insert(payload).select('id,chapter_id,organization,client_name').single();
  if (error) { showErr(msg, error.message); return; }
  _intakeDraftId = row.id;
  const { data: orderNum } = await sb.rpc('generate_order_number', { p_chapter_id: row.chapter_id, p_school: row.organization, p_chapter_name: row.client_name });
  if (orderNum) await sb.from('orders').update({ order_number: orderNum, updated_at: new Date().toISOString() }).eq('id', row.id);
  auditLog('order_created', 'order', row.id, null);
  msg.className = 'suc'; msg.style.display = 'block'; msg.textContent = 'Draft saved. You can upload reference images in Design step.';
}

async function submitToDesignFromIntake() {
  const msg = $('quoteMsg'); const errStep = $('quoteStepErrors'); msg.style.display = 'none'; if (errStep) errStep.style.display = 'none';
  const v = intakeValidation(3);
  if (!v.ok) { if (errStep) { errStep.textContent = 'Missing: ' + v.missing.join(', '); errStep.style.display = 'block'; } return; }
  const result = await ensureIntakeChapterAndOrder();
  if (!result.ok) { showErr(msg, result.error); return; }
  const orderId = result.orderId;
  await sb.from('orders').update({ status: 'design', updated_at: new Date().toISOString() }).eq('id', orderId);
  const { data: existingDr } = await sb.from('design_requests').select('id').eq('order_id', orderId).limit(1).single();
  if (existingDr) {
    await sb.from('design_requests').update({ status: 'pending', updated_at: new Date().toISOString() }).eq('id', existingDr.id);
  } else {
    await sb.from('design_requests').insert({ order_id: orderId, status: 'pending' });
  }
  if (msg) { msg.className = 'suc'; msg.style.display = 'block'; msg.textContent = 'Submitted to design. Continue to Timeline & Invoice below.'; }
  auditLog('order_submit_to_design', 'order', orderId, null);
  setIntakeStep(4);
}

async function saveIntakeInvoiceAndFinish() {
  const msg = $('quoteMsg'); msg.style.display = 'none';
  const v = intakeValidation(5);
  if (!v.ok) { const e = $('quoteStepErrors'); if (e) { e.textContent = 'Missing: ' + v.missing.join(', '); e.style.display = 'block'; } return; }
  if (!_intakeDraftId) { showErr(msg, 'Complete Design step first (Submit to Design).'); return; }
  const payload = intakePayload();
  await sb.from('orders').update({ invoice_email: payload.invoice_email, updated_at: new Date().toISOString() }).eq('id', _intakeDraftId);
  msg.className = 'suc'; msg.style.display = 'block'; msg.textContent = 'Invoice contact saved.';
  setTimeout(() => go('dashboard'), 1200);
}

// ═══════════════════ DESIGN QUEUE ═══════════════════
async function pgDesignQueue() {
  mc('mainContent', `<div class="page">
    <div class="page-header"><h1>Design Queue</h1><p>Manage mockup creation and design workflow</p></div>
    <div id="dqErr" class="err" style="display:none"></div>
    <div class="stat-grid" id="dqStats"><div class="stat-card"><div class="spinner-sm"></div></div></div>
    <div class="tab-bar">
      <div class="tab active" onclick="setTab(this.parentElement,this,()=>dqFilter('all'))">All</div>
      <div class="tab" onclick="setTab(this.parentElement,this,()=>dqFilter('pending'))">Pending</div>
      <div class="tab" onclick="setTab(this.parentElement,this,()=>dqFilter('design'))">In Progress</div>
      <div class="tab" onclick="setTab(this.parentElement,this,()=>dqFilter('production'))">Production</div>
    </div>
    <div class="card-grid" id="dqCards"><div style="padding:20px"><div class="spinner-sm"></div></div></div>
  </div>`);

  const dqErrEl = $('dqErr');
  const { data: orders, error: dqErr } = await sb.from('orders').select('*')
    .in('status', ['intake','quote','design','production'])
    .order('is_rush', { ascending: false })
    .order('created_at', { ascending: true });

  if (dqErr) { if (dqErrEl) { dqErrEl.textContent = dqErr.message; dqErrEl.style.display = 'block'; } mc('dqCards', emptyState('Failed to load design queue.', null, null)); mc('dqStats', ''); return; }
  window._dqAll = orders || [];
  const orderIds = (orders || []).map(o => o.id);
  const { data: drList } = orderIds.length ? await sb.from('design_requests').select('*').in('order_id', orderIds) : { data: [] };
  window._dqDrMap = {}; (drList || []).forEach(dr => { window._dqDrMap[dr.order_id] = dr; });
  const designerIds = [...new Set((drList || []).map(dr => dr.assigned_designer).filter(Boolean))];
  let designerMap = {};
  if (designerIds.length && (CP?.role === 'admin' || CP?.role === 'super_admin')) {
    const { data: users } = await sb.from('users').select('id,full_name').in('id', designerIds);
    (users || []).forEach(u => { designerMap[u.id] = u.full_name || u.email; });
  }
  window._dqDesignerMap = designerMap;
  if (!window._chapterMap) { window._chapterMap = {}; const { data: ch } = await sb.from('chapters').select('id,school,chapter_name'); (ch || []).forEach(c => window._chapterMap[c.id] = c); }
  dqRender(window._dqAll);

  const o = window._dqAll;
  const dqStatsEl = $('dqStats'); if (dqStatsEl) dqStatsEl.innerHTML = `
    <div class="stat-card"><div><div class="stat-num">${o.filter(x => x.status === 'intake' || x.status === 'quote').length}</div><div class="stat-label">Pending</div></div></div>
    <div class="stat-card"><div><div class="stat-num">${o.filter(x => x.status === 'design').length}</div><div class="stat-label">In Design</div></div></div>
    <div class="stat-card"><div><div class="stat-num">${o.filter(x => x.status === 'production').length}</div><div class="stat-label">Production</div></div></div>
    <div class="stat-card"><div><div class="stat-num">${o.length}</div><div class="stat-label">Total Active</div></div></div>`;
}

function dqFilter(s) {
  const o = window._dqAll || [];
  if (s === 'all') dqRender(o);
  else if (s === 'pending') dqRender(o.filter(x => x.status === 'intake' || x.status === 'quote'));
  else dqRender(o.filter(x => x.status === s));
}

function dqRender(orders) {
  if (!orders.length) { mc('dqCards', emptyState('No orders in this stage.', null, null)); return; }
  const designerMap = window._dqDesignerMap || {};
  const drMap = window._dqDrMap || {};
  const chMap = window._chapterMap || {};
  mc('dqCards', orders.map(o => {
    const dr = drMap[o.id];
    const ch = o.chapter_id ? chMap[o.chapter_id] : null;
    const schoolChapter = ch ? (escapeHtml(ch.school || '') + ' · ' + escapeHtml(ch.chapter_name || '')) : (escapeHtml(o.organization || '') + ' · ' + escapeHtml(o.client_name || '—'));
    const summary = summarizeOrder(o);
    const designerName = dr && dr.assigned_designer ? (designerMap[dr.assigned_designer] || '—') : '—';
    const lastUpd = dr && (dr.updated_at || dr.created_at) ? timeAgo(dr.updated_at || dr.created_at) : timeAgo(o.updated_at || o.created_at);
    return `<div class="order-card">
      <div class="card-header">
        <h3><span class="order-num">${escapeHtml(o.order_number || '—')}</span> ${o.is_rush ? '<span class="pill pill-rush">RUSH</span>' : ''}</h3>
        ${pill(o.status)}
      </div>
      <div class="card-sub">${schoolChapter}</div>
      <div class="notes-box" style="margin-bottom:10px"><label>Summary (auto)</label>${escapeHtml(summary)}</div>
      <div class="card-meta">
        <div class="meta-row"><label>Design status</label><span>${escapeHtml((dr && dr.status) || 'pending')}</span></div>
        <div class="meta-row"><label>Assigned designer</label><span>${escapeHtml(designerName)}</span></div>
        <div class="meta-row"><label>Last update</label><span>${lastUpd}</span></div>
      </div>
      <div class="btn-row" style="flex-wrap:wrap;gap:6px">
        <button class="btn btn-ghost btn-sm" onclick="openOrder('${o.id}')">View order</button>
        ${(CP?.role === 'admin' || CP?.role === 'super_admin' || CP?.role === 'sales_rep') ? `<button class="btn btn-ghost btn-sm" onclick="dqAssignDesigner('${o.id}')">Assign designer</button>` : ''}
        ${(CP?.role === 'admin' || CP?.role === 'super_admin' || CP?.role === 'designer' || (dr && dr.assigned_designer === CU.id)) ? `<button class="btn btn-ghost btn-sm" onclick="dqDesignerActions('${o.id}')">Status / Notes / Upload</button>` : ''}
        <button class="btn btn-blue btn-sm" onclick="dqAdvance('${o.id}','${o.status}')">${o.status === 'intake' || o.status === 'quote' ? '▶ Start Design' : o.status === 'design' ? '→ To Production' : '→ Fulfillment'}</button>
      </div>
    </div>`;
  }).join(''));
}

async function dqAssignDesigner(orderId) {
  const { data: users } = await sb.from('users').select('id,full_name').in('role', ['designer','admin','super_admin']);
  const dr = window._dqDrMap && window._dqDrMap[orderId];
  const opts = (users || []).map(u => `<option value="${u.id}" ${dr && dr.assigned_designer === u.id ? 'selected' : ''}>${escapeHtml(u.full_name || u.email)}</option>`).join('');
  const modal = document.createElement('div'); modal.className = 'modal-bg open'; modal.id = 'dqAssignModal';
  modal.innerHTML = `<div class="modal"><div class="modal-header"><h2>Assign designer</h2><button class="modal-close" onclick="$('dqAssignModal').remove()">×</button></div>
  <div class="form-group"><label>Designer</label><select class="form-select" id="dq_designer_id">${opts}</select></div>
  <button class="btn btn-blue btn-full" onclick="dqSaveAssign('${orderId}')">Save</button></div>`;
  document.body.appendChild(modal);
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
}

async function dqSaveAssign(orderId) {
  const designerId = ($('dq_designer_id') && $('dq_designer_id').value) || null;
  const dr = window._dqDrMap && window._dqDrMap[orderId];
  if (dr) {
    await sb.from('design_requests').update({ assigned_designer: designerId, updated_at: new Date().toISOString() }).eq('id', dr.id);
  } else {
    await sb.from('design_requests').insert({ order_id: orderId, assigned_designer: designerId, status: 'pending' });
  }
  auditLog('design_assign', 'order', orderId, { assigned_designer: designerId });
  $('dqAssignModal')?.remove();
  pgDesignQueue();
}

function dqDesignerActions(orderId) {
  const dr = window._dqDrMap && window._dqDrMap[orderId];
  const modal = document.createElement('div'); modal.className = 'modal-bg open'; modal.id = 'dqActionsModal';
  modal.innerHTML = `<div class="modal" style="max-width:480px"><div class="modal-header"><h2>Design: ${orderId.slice(0,8)}…</h2><button class="modal-close" onclick="$('dqActionsModal').remove()">×</button></div>
  <div id="dqActMsg" class="err" style="display:none"></div>
  <div class="form-group"><label>Status</label><select class="form-select" id="dq_dr_status"><option value="pending">Pending</option><option value="in_progress">In progress</option><option value="review">Review</option><option value="approved">Approved</option></select></div>
  <div class="form-group"><label>Notes</label><textarea class="form-textarea" id="dq_dr_notes" style="min-height:70px">${escapeHtml((dr && dr.notes) || (dr && dr.revision_notes) || '')}</textarea></div>
  <div class="form-group"><label>Upload design file (AI/EPS/PDF/PNG/JPG)</label><input type="file" class="form-input" id="dq_dr_file" accept=".ai,.eps,.pdf,.png,.jpg,.jpeg"></div>
  <button class="btn btn-blue btn-full" onclick="dqSaveDesignerActions('${orderId}')">Save</button></div>`;
  document.body.appendChild(modal);
  const st = $('dq_dr_status'); if (st && dr && dr.status) st.value = dr.status;
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
}

async function dqSaveDesignerActions(orderId) {
  const msg = $('dqActMsg'); msg.style.display = 'none';
  const dr = window._dqDrMap && window._dqDrMap[orderId];
  const status = ($('dq_dr_status') && $('dq_dr_status').value) || 'pending';
  const notes = v('dq_dr_notes');
  const fileInput = $('dq_dr_file');
  let mockupLinks = (dr && dr.mockup_links && Array.isArray(dr.mockup_links)) ? [...dr.mockup_links] : [];
  if (fileInput && fileInput.files && fileInput.files[0]) {
    const file = fileInput.files[0]; const path = `orders/${orderId}/design/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
    const { data, error } = await sb.storage.from('design-files').upload(path, file, { upsert: true });
    if (error) { showErr(msg, 'Upload failed: ' + error.message); return; }
    const { data: urlData } = sb.storage.from('design-files').getPublicUrl(data.path);
    mockupLinks.push(urlData.publicUrl);
  }
  const payload = { status, notes: notes || null, revision_notes: notes || null, mockup_links: mockupLinks, updated_at: new Date().toISOString() };
  if (dr) {
    await sb.from('design_requests').update(payload).eq('id', dr.id);
  } else {
    await sb.from('design_requests').insert({ order_id: orderId, ...payload });
  }
  auditLog('design_update', 'order', orderId, { status });
  $('dqActionsModal')?.remove();
  pgDesignQueue();
}

async function dqAdvance(id, status) {
  const next = { intake: 'design', quote: 'design', design: 'production', production: 'fulfillment' };
  const ok = await updateStatus(id, next[status] || 'production');
  if (ok) pgDesignQueue();
}

// ═══════════════════ APPROVALS ═══════════════════
let _apTab = 'design';

async function pgApprovals() {
  mc('mainContent', `<div class="page">
    <div class="page-header"><h1>Approvals</h1><p>Design mockups and quotes awaiting approval</p></div>
    <div id="apErr" class="err" style="display:none"></div>
    <div class="tab-bar" id="apTabBar">
      <div class="tab active" id="apTabDesign" onclick="setTab('apTabBar',document.getElementById('apTabDesign'),apShowDesign)">Design Approvals</div>
      <div class="tab" id="apTabQuote" onclick="setTab('apTabBar',document.getElementById('apTabQuote'),apShowQuote)">Quote Approvals</div>
    </div>
    <div class="stat-grid" id="apStats"><div class="stat-card"><div class="spinner-sm"></div></div></div>
    <div class="card-grid" id="apCards"><div style="padding:20px"><div class="spinner-sm"></div></div></div>
  </div>`);
  _apTab = 'design';
  apShowDesign();
}

async function apShowDesign() {
  _apTab = 'design';
  document.querySelectorAll('#apTabs').forEach(e => e.id && e.querySelector('.tab') && e.querySelector('.tab').classList.remove('active'));
  const el = $('apTabDesign'); if (el) el.classList.add('active'); const q = $('apTabQuote'); if (q) q.classList.remove('active');
  const { data: orders, error } = await sb.from('orders').select('*').eq('status', 'design').order('created_at', { ascending: false });
  if (error) { if ($('apErr')) { $('apErr').textContent = error.message; $('apErr').style.display = 'block'; } mc('apCards', emptyState('Failed to load.', null, null)); mc('apStats', ''); return; }
  const list = orders || [];
  if ($('apStats')) $('apStats').innerHTML = `<div class="stat-card"><div class="stat-num">${list.length}</div><div class="stat-label">Design mockups awaiting approval</div></div>`;
  if (!list.length) { mc('apCards', emptyState('No design mockups awaiting approval.', null, null)); return; }
  mc('apCards', list.map(o => `
    <div class="order-card">
      <div class="card-header"><h3><span class="order-num">${escapeHtml(o.order_number || '—')}</span> ${o.is_rush ? '<span class="pill pill-rush">RUSH</span>' : ''}</h3>${pill(o.status)}</div>
      <div class="card-sub">${escapeHtml(o.client_name || o.organization || '—')}</div>
      <div class="card-meta">
        <div class="meta-row"><label>Product</label><span>${escapeHtml(o.garment_type || '—')}</span></div>
        <div class="meta-row"><label>Quantity</label><span>${o.quantity ?? '—'} units</span></div>
        <div class="meta-row"><label>Order #</label><span class="order-num">${escapeHtml(o.order_number || '—')}</span></div>
      </div>
      ${o.design_direction ? `<div class="notes-box"><label>Design</label>${escapeHtml((o.design_direction || '').slice(0,120))}…</div>` : ''}
      <div class="btn-row">
        <button class="btn btn-ghost btn-full btn-sm" onclick="apRevision('${o.id}')">↩ Request Revision</button>
        <button class="btn btn-green btn-full btn-sm" onclick="apApprove('${o.id}')">✓ Approve design</button>
      </div>
    </div>`).join(''));
}

async function apShowQuote() {
  _apTab = 'quote';
  const el = $('apTabQuote'); if (el) el.classList.add('active'); const d = $('apTabDesign'); if (d) d.classList.remove('active');
  const { data: orders, error } = await sb.from('orders').select('*').eq('status', 'quote').order('created_at', { ascending: false });
  if (error) { if ($('apErr')) { $('apErr').textContent = error.message; $('apErr').style.display = 'block'; } mc('apCards', emptyState('Failed to load.', null, null)); mc('apStats', ''); return; }
  const list = orders || [];
  if ($('apStats')) $('apStats').innerHTML = `<div class="stat-card"><div class="stat-num">${list.length}</div><div class="stat-label">Quotes ready for approval</div></div>`;
  if (!list.length) { mc('apCards', emptyState('No quotes awaiting approval.', null, null)); return; }
  mc('apCards', list.map(o => `
    <div class="order-card">
      <div class="card-header"><h3><span class="order-num">${escapeHtml(o.order_number || '—')}</span> ${o.is_rush ? '<span class="pill pill-rush">RUSH</span>' : ''}</h3>${pill(o.status)}</div>
      <div class="card-sub">${escapeHtml(o.client_name || o.organization || '—')}</div>
      <div class="card-meta">
        <div class="meta-row"><label>Product</label><span>${escapeHtml(o.garment_type || '—')}</span></div>
        <div class="meta-row"><label>Quantity</label><span>${o.quantity ?? '—'} units</span></div>
        <div class="meta-row"><label>Quote total</label><span>${o.quote_total != null ? '$' + Number(o.quote_total).toLocaleString() : '—'}</span></div>
      </div>
      <div class="btn-row">
        <button class="btn btn-ghost btn-full btn-sm" onclick="openOrder('${o.id}')">View details</button>
        <button class="btn btn-green btn-full btn-sm" onclick="apQuoteApprove('${o.id}')">✓ Approve quote</button>
      </div>
    </div>`).join(''));
}

async function apQuoteApprove(id) {
  const ok = await updateStatus(id, 'design');
  if (ok) apShowQuote();
}

async function apApprove(id) {
  const ok = await updateStatus(id, 'production');
  if (ok) pgApprovals();
}
async function apRevision(id) {
  const ok = await updateStatus(id, 'design');
  if (ok) pgApprovals();
}

// ═══════════════════ FULFILLMENT ═══════════════════
const FULFILLMENT_CHECKLIST_KEYS = ['payment_confirmed','po_created','art_sent','proof_received','in_production','shipped','delivered'];

async function pgFulfillment() {
  mc('mainContent', `<div class="page">
    <div class="page-header"><h1>Fulfillment</h1><p>Quote requests and production tracking</p></div>
    <div id="ffErr" class="err" style="display:none"></div>
    <div class="tab-bar" id="ffTabBar">
      <div class="tab active" onclick="setTab('ffTabBar',this,ffShowQuoteRequests)">Quote Requests</div>
      <div class="tab" onclick="setTab('ffTabBar',this,ffShowProduction)">Production</div>
    </div>
    <div class="stat-grid" id="ffStats"></div>
    <div class="card-grid" id="ffCards"><div style="padding:20px"><div class="spinner-sm"></div></div></div>
  </div>`);
  ffShowQuoteRequests();
}

async function ffShowQuoteRequests() {
  const { data: orders, error } = await sb.from('orders').select('*').in('status', ['intake','quote']).order('created_at', { ascending: false });
  if (error) { if ($('ffErr')) { $('ffErr').textContent = error.message; $('ffErr').style.display = 'block'; } mc('ffCards', emptyState('Failed to load.', null, null)); return; }
  const list = orders || [];
  if ($('ffStats')) $('ffStats').innerHTML = `<div class="stat-card"><div class="stat-num">${list.length}</div><div class="stat-label">Orders needing quote</div></div>`;
  if (!list.length) { mc('ffCards', emptyState('No quote requests.', null, null)); return; }
  mc('ffCards', list.map(o => `
    <div class="order-card">
      <div class="card-header"><h3><span class="order-num">${escapeHtml(o.order_number || '—')}</span></h3>${pill(o.status)}</div>
      <div class="card-sub">${escapeHtml(o.client_name || o.organization || '—')}</div>
      <div class="card-meta">
        <div class="meta-row"><label>Garment</label><span>${escapeHtml(o.garment_type || '—')}</span></div>
        <div class="meta-row"><label>Qty</label><span>${o.quantity ?? o.estimated_qty_max ?? '—'}</span></div>
        <div class="meta-row"><label>Needed by</label><span>${escapeHtml(fmtDate(o.needed_by_date))}</span></div>
      </div>
      <div class="btn-row">
        <button class="btn btn-ghost btn-sm" onclick="openOrder('${o.id}')">View</button>
        <button class="btn btn-blue btn-sm" onclick="ffOpenQuoteForm('${o.id}')">Enter quote / Send to approval</button>
      </div>
    </div>`).join(''));
}

function ffOpenQuoteForm(orderId) {
  sb.from('orders').select('*').eq('id', orderId).single().then(({ data: o }) => {
    if (!o) return;
    const modal = document.createElement('div'); modal.className = 'modal-bg open'; modal.id = 'ffQuoteModal';
    modal.innerHTML = `<div class="modal" style="max-width:480px"><div class="modal-header"><h2>Quote: ${escapeHtml(o.order_number || '—')}</h2><button class="modal-close" onclick="$('ffQuoteModal').remove()">×</button></div>
    <div id="ffQuoteMsg" class="err" style="display:none"></div>
    <div class="form-group"><label>Vendor / production partner</label><input class="form-input" id="ff_vendor" value="${escapeHtml(o.production_partner || '')}"></div>
    <div class="form-group"><label>Quote total ($)</label><input class="form-input" id="ff_quote_total" type="number" step="0.01" value="${o.quote_total ?? ''}"></div>
    <div class="form-group"><label>Notes</label><textarea class="form-textarea" id="ff_quote_notes" style="min-height:60px">${escapeHtml(o.internal_notes || '')}</textarea></div>
    <button class="btn btn-blue btn-full" onclick="ffSendQuoteToApproval('${orderId}')">Send quote to approval</button></div>`;
    document.body.appendChild(modal);
    modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
  });
}

async function ffSendQuoteToApproval(orderId) {
  const msg = $('ffQuoteMsg'); const total = parseFloat(v('ff_quote_total'));
  if (isNaN(total) || total < 0) { showErr(msg, 'Enter a valid quote total'); return; }
  const { error } = await sb.from('orders').update({
    quote_total: total, production_partner: v('ff_vendor') || null, internal_notes: v('ff_quote_notes') || null,
    status: 'quote', quote_status: 'pending_approval', updated_at: new Date().toISOString()
  }).eq('id', orderId);
  if (error) { showErr(msg, error.message); return; }
  $('ffQuoteModal')?.remove();
  ffShowQuoteRequests();
}

async function ffShowProduction() {
  const { data: orders, error } = await sb.from('orders').select('*').in('status', ['production','fulfillment','complete']).order('created_at', { ascending: false });
  if (error) { if ($('ffErr')) { $('ffErr').textContent = error.message; $('ffErr').style.display = 'block'; } mc('ffCards', emptyState('Failed to load.', null, null)); return; }
  window._ffProduction = orders || [];
  const o = window._ffProduction;
  if ($('ffStats')) $('ffStats').innerHTML = `
    <div class="stat-card"><div class="stat-num">${o.filter(x => x.status === 'production').length}</div><div class="stat-label">In production</div></div>
    <div class="stat-card"><div class="stat-num">${o.filter(x => x.status === 'fulfillment').length}</div><div class="stat-label">Ready to ship</div></div>
    <div class="stat-card"><div class="stat-num">${o.filter(x => x.status === 'complete').length}</div><div class="stat-label">Delivered</div></div>`;
  if (!o.length) { mc('ffCards', emptyState('No production orders.', null, null)); return; }
  mc('ffCards', o.map(ord => {
    const check = (ord.fulfillment_checklist && typeof ord.fulfillment_checklist === 'object') ? ord.fulfillment_checklist : {};
    return `<div class="order-card">
      <div class="card-header"><h3><span class="order-num">${escapeHtml(ord.order_number || '—')}</span> ${ord.is_rush ? '<span class="pill pill-rush">RUSH</span>' : ''}</h3>${pill(ord.status)}</div>
      <div class="card-sub">${escapeHtml(ord.client_name || ord.organization || '—')}</div>
      <div class="card-meta">
        <div class="meta-row"><label>Product</label><span>${escapeHtml(ord.garment_type || '—')}</span></div>
        <div class="meta-row"><label>Quantity</label><span>${ord.quantity ?? '—'}</span></div>
      </div>
      <div style="font-size:12px;color:#6b7280;margin-bottom:10px">Checklist: ${FULFILLMENT_CHECKLIST_KEYS.map(k => check[k] ? '✓ ' + k.replace('_',' ') : '○ ' + k.replace('_',' ')).join(' · ')}</div>
      ${ord.status !== 'complete' ? `<div class="btn-row">
        <button class="btn btn-ghost btn-sm" onclick="openOrder('${ord.id}')">View</button>
        <button class="btn btn-ghost btn-sm" onclick="ffOpenChecklist('${ord.id}')">Update checklist</button>
        <button class="btn btn-blue btn-sm" onclick="ffAdvance('${ord.id}','${ord.status}')">${ord.status === 'production' ? '→ Ready to ship' : '✓ Mark delivered'}</button>
      </div>` : `<div style="text-align:center;color:#16a34a;font-size:13px">✓ Delivered</div>`}
    </div>`;
  }).join(''));
}

function ffOpenChecklist(orderId) {
  const o = (window._ffProduction || []).find(x => x.id === orderId); if (!o) return;
  const check = (o.fulfillment_checklist && typeof o.fulfillment_checklist === 'object') ? o.fulfillment_checklist : {};
  const labels = { payment_confirmed:'Payment confirmed', po_created:'PO created', art_sent:'Art files sent', proof_received:'Proof received', in_production:'In production', shipped:'Shipped', delivered:'Delivered' };
  const modal = document.createElement('div'); modal.className = 'modal-bg open'; modal.id = 'ffChecklistModal';
  modal.innerHTML = `<div class="modal" style="max-width:420px"><div class="modal-header"><h2>Checklist: ${escapeHtml(o.order_number || '—')}</h2><button class="modal-close" onclick="$('ffChecklistModal').remove()">×</button></div>
  <div id="ffCheckMsg" class="err" style="display:none"></div>
  ${FULFILLMENT_CHECKLIST_KEYS.map(k => `<div class="form-group" style="flex-direction:row;align-items:center;gap:8px"><input type="checkbox" id="ff_c_${k}" ${check[k] ? 'checked' : ''}><label for="ff_c_${k}" style="margin:0">${labels[k] || k}</label></div>`).join('')}
  <button class="btn btn-blue btn-full" onclick="ffSaveChecklist('${orderId}')">Save</button></div>`;
  document.body.appendChild(modal);
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
}

async function ffSaveChecklist(orderId) {
  const check = {};
  FULFILLMENT_CHECKLIST_KEYS.forEach(k => { const el = $('ff_c_' + k); if (el && el.checked) check[k] = new Date().toISOString(); });
  const { error } = await sb.from('orders').update({ fulfillment_checklist: check, updated_at: new Date().toISOString() }).eq('id', orderId);
  if (error) { showErr($('ffCheckMsg'), error.message); return; }
  $('ffChecklistModal')?.remove();
  ffShowProduction();
}

async function ffAdvance(id, status) {
  const next = { production: 'fulfillment', fulfillment: 'complete' };
  const ok = await updateStatus(id, next[status]);
  if (ok) ffShowProduction();
}

// ═══════════════════ STOREFRONT ═══════════════════
function pgStorefront() {
  mc('mainContent', `<div class="page">
    <div class="page-header"><h1>Storefront Builder</h1><p>Per-chapter storefronts and product catalog</p></div>
    <div id="sfErr" class="err" style="display:none"></div>
    <div class="tab-bar">
      <div class="tab active" onclick="setTab(this.parentElement,this,()=>sfShowBuilder())">Storefronts</div>
      <div class="tab" onclick="setTab(this.parentElement,this,()=>sfShowProducts())">Products</div>
    </div>
    <div id="sfBuilder">
      <div class="form-card" style="margin-bottom:20px">
        <div class="form-section-title">Choose Chapter</div>
        <select class="form-select" id="sfChapter" onchange="sfOnChapterChange()"><option value="">— Select chapter —</option></select>
      </div>
      <div id="sfStorefrontPanel" style="display:none">
        <div class="section-card"><div class="section-title">Storefront</div><div id="sfStorefrontList"></div><button class="btn btn-blue btn-sm" onclick="sfCreateStorefront()">+ Create Storefront</button></div>
        <div id="sfStorefrontDetail" style="display:none"><div class="section-card"><div class="section-title" id="sfDetailTitle">Storefront name</div><div id="sfProductsInStorefront"></div><button class="btn btn-ghost btn-sm" onclick="sfAddProductToStorefront()">+ Add Product</button><div style="margin-top:12px"><label>Shareable link</label><div style="display:flex;gap:8px;align-items:center"><input class="form-input" id="sfShareLink" readonly style="flex:1"><button class="btn btn-ghost btn-sm" onclick="sfCopyLink()">Copy</button></div></div><button class="btn btn-green btn-sm" style="margin-top:8px" onclick="sfPublish()">Publish</button></div></div>
      </div>
      <div id="sfProductsArea" style="display:none"></div>
    </div>
    <div id="sfProducts"><div style="padding:20px"><div class="spinner-sm"></div></div></div>
  </div>`);
  sfShowBuilder();
}

async function sfShowBuilder() {
  $('sfBuilder').style.display = 'block'; $('sfProducts').style.display = 'none';
  let q = sb.from('chapters').select('id,chapter_name,school').order('chapter_name');
  if (CP?.role === 'sales_rep') q = q.eq('assigned_sales_rep', CU.id);
  const { data: ch } = await q;
  const sel = $('sfChapter'); if (sel) sel.innerHTML = '<option value="">— Select chapter —</option>' + (ch || []).map(c => `<option value="${c.id}">${escapeHtml(c.chapter_name)} · ${escapeHtml(c.school || '')}</option>`).join('');
}

async function sfShowProducts() {
  $('sfBuilder').style.display = 'none'; $('sfProducts').style.display = 'block';
  const el = $('sfProducts'); if (!el) return;
  try {
    const { data: products, error } = await sb.from('products').select('*').order('name');
    if (error) throw error;
    const list = products || [];
    if (!list.length) { el.innerHTML = emptyState('No products yet.', '+ Add Product', "openAddProduct()"); return; }
    el.innerHTML = `<div class="card-grid">${list.map(p => `
      <div class="order-card">
        <div style="font-size:15px;font-weight:600">${escapeHtml(p.name)}</div>
        <div style="font-size:12px;color:#9ca3af">${escapeHtml(p.category || '')} · $${Number(p.base_price || 0).toFixed(2)}</div>
        <div style="font-size:12px;color:#6b7280;margin:8px 0">${escapeHtml((p.short_description || p.description || '').slice(0,80))}...</div>
        <div class="btn-row"><button class="btn btn-ghost btn-sm" onclick="openEditProduct('${p.id}')">Edit</button><button class="btn btn-red btn-sm" onclick="sfToggleProduct('${p.id}',${!p.active})">${p.active ? 'Deactivate' : 'Activate'}</button></div>
      </div>`).join('')}</div><button class="btn btn-blue btn-sm" style="margin-top:12px" onclick="openAddProduct()">+ Add Product</button>`;
  } catch (e) { console.error('[Storefront]', e); el.innerHTML = emptyState('Failed to load products.', null, null); }
}

function sfOnChapterChange() {
  const id = ($('sfChapter') && $('sfChapter').value) || '';
  const panel = $('sfStorefrontPanel'); const detail = $('sfStorefrontDetail');
  if (!panel) return;
  panel.style.display = id ? 'block' : 'none';
  if (!id) { detail.style.display = 'none'; return; }
  window._sfChapterId = id;
  loadStorefrontsForChapter(id);
}

async function loadStorefrontsForChapter(chapterId) {
  const listEl = $('sfStorefrontList'); if (!listEl) return;
  const { data: list, error } = await sb.from('storefronts').select('*').eq('chapter_id', chapterId).order('created_at', { ascending: false });
  if (error) { listEl.innerHTML = '<p class="err">Failed to load.</p>'; return; }
  if (!list || !list.length) { listEl.innerHTML = '<p style="color:#6b7280">No storefronts. Create one.</p>'; return; }
  listEl.innerHTML = list.map(s => `<div class="activity-item" onclick="sfOpenStorefront('${s.id}')"><div><strong>${escapeHtml(s.name)}</strong><span style="font-size:11px;color:#9ca3af"> ${s.is_active ? '· Live' : '· Draft'}</span></div>${s.public_token ? '<span class="pill pill-complete">Has link</span>' : ''}</div>`).join('');
}

function sfCreateStorefront() {
  const chId = window._sfChapterId; if (!chId) return;
  const name = prompt('Storefront name:', 'Spring 2026');
  if (!name) return;
  const token = Array.from(crypto.getRandomValues(new Uint8Array(32))).map(b => b.toString(16).padStart(2,'0')).join('');
  sb.from('storefronts').insert({ chapter_id: chId, name, public_token: token, is_active: false }).select('id').single().then(({ data }) => { if (data) loadStorefrontsForChapter(chId); });
}

let _sfCurrentStorefrontId = null;
async function sfOpenStorefront(id) {
  _sfCurrentStorefrontId = id;
  const detail = $('sfStorefrontDetail'); const title = $('sfDetailTitle'); const link = $('sfShareLink');
  if (!detail) return;
  detail.style.display = 'block';
  const { data: s } = await sb.from('storefronts').select('*').eq('id', id).single();
  if (s) { if (title) title.textContent = s.name; if (link) link.value = window.location.origin + window.location.pathname + '?storefront_token=' + (s.public_token || ''); }
  const { data: sp } = await sb.from('storefront_products').select('*, products(*)').eq('storefront_id', id).order('sort_order');
  const productsEl = $('sfProductsInStorefront');
  if (productsEl) productsEl.innerHTML = (sp || []).map(x => `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f3f4f6">${escapeHtml(x.products?.name || '—')} · $${Number(x.price_override ?? x.products?.base_price ?? 0).toFixed(2)} <button class="btn btn-ghost btn-sm" onclick="sfRemoveProductFromStorefront('${x.id}')">Remove</button></div>`).join('') || '<p style="color:#9ca3af">No products. Add products from catalog.</p>';
}

async function sfAddProductToStorefront() {
  if (!_sfCurrentStorefrontId) return;
  const { data: prods } = await sb.from('products').select('id,name,base_price').eq('active', true);
  window._sfProductsCatalog = prods || [];
  const opts = (prods || []).map(p => `<option value="${p.id}">${escapeHtml(p.name)} — $${Number(p.base_price).toFixed(2)}</option>`).join('');
  const modal = document.createElement('div'); modal.className = 'modal-bg open'; modal.id = 'sfAddProdModal';
  modal.innerHTML = `<div class="modal"><div class="modal-header"><h2>Add product</h2><button class="modal-close" onclick="$('sfAddProdModal').remove()">×</button></div>${opts ? '<select class="form-select" id="sfAddProdSelect">'+opts+'</select>' : '<p style="color:#6b7280">No active products. Add products in the Products tab first.</p>'}<button class="btn btn-blue btn-full" style="margin-top:12px" onclick="sfAddProductConfirm()">Add</button></div>`;
  document.body.appendChild(modal);
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
}

function sfAddProductConfirm() {
  const sel = $('sfAddProdSelect'); const pid = sel && sel.value;
  if (!pid || !_sfCurrentStorefrontId) return;
  sb.from('storefront_products').insert({ storefront_id: _sfCurrentStorefrontId, product_id: pid }).then(() => { $('sfAddProdModal')?.remove(); sfOpenStorefront(_sfCurrentStorefrontId); });
}

async function sfRemoveProductFromStorefront(spId) {
  await sb.from('storefront_products').delete().eq('id', spId);
  sfOpenStorefront(_sfCurrentStorefrontId);
}

function sfCopyLink() {
  const input = $('sfShareLink'); if (input && input.value) { input.select(); document.execCommand('copy'); }
}

function sfPublish() {
  if (!_sfCurrentStorefrontId) return;
  sb.from('storefronts').update({ is_active: true }).eq('id', _sfCurrentStorefrontId).then(() => sfOpenStorefront(_sfCurrentStorefrontId));
}

function sfToggleProduct(pid, active) {
  sb.from('products').update({ active }).eq('id', pid).then(() => sfShowProducts());
}

function openAddProduct() {
  const modal = document.createElement('div'); modal.className = 'modal-bg open'; modal.id = 'addProductModal';
  modal.innerHTML = `<div class="modal" style="max-width:560px"><div class="modal-header"><h2>Add Product</h2><button class="modal-close" onclick="$('addProductModal').remove()">×</button></div><div id="apMsg" class="err" style="display:none"></div>
  <div class="form-group"><label>Name *</label><input class="form-input" id="ap_name" placeholder="e.g. Classic Tee"></div>
  <div class="form-row"><div class="form-group"><label>Base price ($) *</label><input class="form-input" id="ap_price" type="number" step="0.01"></div><div class="form-group"><label>Category</label><select class="form-select" id="ap_cat"><option>Apparel</option><option>Headwear</option><option>Bags</option><option>Accessories</option></select></div></div>
  <div class="form-group"><label>Short description</label><input class="form-input" id="ap_short_desc"></div>
  <div class="form-group"><label>Description</label><textarea class="form-textarea" id="ap_desc"></textarea></div>
  <div class="form-group"><label>Production method</label><select class="form-select" id="ap_prod_method"><option>Screen Print</option><option>Embroidery</option><option>DTG</option></select></div>
  <button class="btn btn-blue btn-full" onclick="saveProduct()">Save Product</button></div>`;
  document.body.appendChild(modal);
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
}

function openEditProduct(pid) {
  sb.from('products').select('*').eq('id', pid).single().then(({ data: p }) => {
    if (!p) return;
    const modal = document.createElement('div'); modal.className = 'modal-bg open'; modal.id = 'editProductModal';
    modal.innerHTML = `<div class="modal" style="max-width:560px"><div class="modal-header"><h2>Edit Product</h2><button class="modal-close" onclick="$('editProductModal').remove()">×</button></div><div id="epMsg" class="err" style="display:none"></div>
    <input type="hidden" id="ep_id" value="${p.id}">
    <div class="form-group"><label>Name *</label><input class="form-input" id="ep_name" value="${escapeHtml(p.name || '')}"></div>
    <div class="form-row"><div class="form-group"><label>Base price ($) *</label><input class="form-input" id="ep_price" type="number" step="0.01" value="${p.base_price ?? ''}"></div><div class="form-group"><label>Category</label><select class="form-select" id="ep_cat"><option>Apparel</option><option>Headwear</option><option>Bags</option><option>Accessories</option></select></div></div>
    <div class="form-group"><label>Short description</label><input class="form-input" id="ep_short_desc" value="${escapeHtml(p.short_description || '')}"></div>
    <div class="form-group"><label>Description</label><textarea class="form-textarea" id="ep_desc">${escapeHtml(p.description || '')}</textarea></div>
    <button class="btn btn-blue btn-full" onclick="saveProductEdit()">Save</button></div>`;
    document.body.appendChild(modal);
    const cat = $('ep_cat'); if (cat && p.category) cat.value = p.category;
    modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
  });
}

async function saveProduct() {
  const name = v('ap_name'), price = v('ap_price'); const msg = $('apMsg');
  if (!name || !price) { showErr(msg, 'Name and price required'); return; }
  const { error } = await sb.from('products').insert({ name, base_price: parseFloat(price), category: ($('ap_cat') && $('ap_cat').value) || 'Apparel', short_description: v('ap_short_desc'), description: v('ap_desc'), production_method: ($('ap_prod_method') && $('ap_prod_method').value) || 'Screen Print', active: true });
  if (error) { showErr(msg, error.message); return; }
  $('addProductModal')?.remove(); sfShowProducts();
}

async function saveProductEdit() {
  const id = v('ep_id'); const name = v('ep_name'); const price = v('ep_price'); const msg = $('epMsg');
  if (!id || !name || !price) { showErr(msg, 'Name and price required'); return; }
  const { error } = await sb.from('products').update({ name, base_price: parseFloat(price), category: ($('ep_cat') && $('ep_cat').value) || 'Apparel', short_description: v('ep_short_desc'), description: v('ep_desc') }).eq('id', id);
  if (error) { showErr(msg, error.message); return; }
  $('editProductModal')?.remove(); sfShowProducts();
}

// ═══════════════════ ADMIN ═══════════════════
async function pgAdmin() {
  mc('mainContent', `<div class="page">
    <div class="page-header"><h1>Admin Dashboard</h1><p>System oversight and delivery-focused metrics</p></div>
    <div id="adErr" class="err" style="display:none"></div>
    <div class="flag-grid" id="adFlags"><div style="color:#9ca3af;font-size:13px">Loading...</div></div>
    <div class="two-col">
      <div class="section-card"><div class="section-title">All Orders</div><div class="section-sub">Pipeline view</div><div id="adOrders"><div class="spinner-sm"></div></div></div>
      <div class="section-card"><div class="section-title">Business Metrics</div><div class="section-sub">Timeline & delivery</div><div id="adMetrics"><div class="spinner-sm"></div></div></div>
    </div>
    <div class="section-card" style="margin-top:16px"><div class="section-title">Recent Activity</div><div id="adActivity"><div class="spinner-sm"></div></div></div>
  </div>`);

  const adErr = $('adErr'); const adFlagsEl = $('adFlags'); const adOrdersEl = $('adOrders'); const adMetricsEl = $('adMetrics'); const adActivity = $('adActivity');
  try {
    const { data: orders, error } = await sb.from('orders').select('*').order('created_at', { ascending: false });
    if (error) throw error;
    const list = orders || [];
    const now = Date.now(); const day = 24 * 60 * 60 * 1000;
    const due7 = list.filter(o => o.needed_by_date && !['complete','cancelled'].includes(o.status) && (new Date(o.needed_by_date) - now) <= 7 * day).length;
    const due14 = list.filter(o => o.needed_by_date && !['complete','cancelled'].includes(o.status) && (new Date(o.needed_by_date) - now) <= 14 * day).length;
    const byStatus = {}; STATUS_FLOW.forEach(s => byStatus[s] = 0); list.forEach(o => { if (byStatus[o.status] !== undefined) byStatus[o.status]++; });
    if (adFlagsEl) adFlagsEl.innerHTML = `
      <div class="flag-card"><div class="flag-bar" style="background:#dc2626"></div><div><div class="flag-num">${due7}</div><div class="flag-label">Due in 7 days</div></div></div>
      <div class="flag-card"><div class="flag-bar" style="background:#d97706"></div><div><div class="flag-num">${due14}</div><div class="flag-label">Due in 14 days</div></div></div>
      <div class="flag-card"><div class="flag-bar" style="background:#7c3aed"></div><div><div class="flag-num">${byStatus.design || 0}</div><div class="flag-label">In Design</div></div></div>
      <div class="flag-card"><div class="flag-bar" style="background:#16a34a"></div><div><div class="flag-num">${byStatus.complete || 0}</div><div class="flag-label">Completed</div></div></div>`;

    if (adOrdersEl) adOrdersEl.innerHTML = list.length ? list.slice(0, 12).map(o => `
      <div class="activity-item" onclick="openOrder('${String(o.id).replace(/'/g, "\\'")}')">
        <div style="flex:1"><strong style="font-size:13px">${escapeHtml(o.client_name || '—')}</strong><span style="font-size:11px;color:#9ca3af;display:block">${escapeHtml(o.order_number || '—')} · ${escapeHtml(o.garment_type || '—')} · Qty ${o.quantity ?? '—'}</span></div>
        ${pill(o.status)}
      </div>`).join('') : emptyState('No orders yet.', null, null);

    const revenue = list.reduce((s, o) => s + (Number(o.budget) || Number(o.quote_total) || 0), 0);
    const avgQty = list.length ? Math.round(list.reduce((s, o) => s + (o.quantity || 0), 0) / list.length) : 0;
    const fulfillmentQueue = list.filter(o => o.status === 'production' || o.status === 'fulfillment').length;
    if (adMetricsEl) adMetricsEl.innerHTML = `
      <div class="metric-card"><div><div class="metric-label">Total Orders</div><div class="metric-val">${list.length}</div></div><span style="font-size:20px">📋</span></div>
      <div class="metric-card"><div><div class="metric-label">Pipeline Value</div><div class="metric-val">$${revenue.toLocaleString()}</div></div><span style="font-size:20px">💵</span></div>
      <div class="metric-card"><div><div class="metric-label">Avg Order Size</div><div class="metric-val">${avgQty} units</div></div><span style="font-size:20px">📦</span></div>
      <div class="metric-card"><div><div class="metric-label">Fulfillment Queue</div><div class="metric-val">${fulfillmentQueue}</div></div><span style="font-size:20px">📤</span></div>`;

    const recent = list.slice(0, 8).map(o => ({ ...o, _label: o.client_name || o.order_number || o.id }));
    if (adActivity) adActivity.innerHTML = recent.length ? recent.map(o => `<div class="activity-item" onclick="openOrder('${o.id}')"><div style="flex:1"><strong>${escapeHtml(o._label)}</strong><span style="font-size:11px;color:#9ca3af">${o.status} · ${timeAgo(o.updated_at || o.created_at)}</span></div>${pill(o.status)}</div>`).join('') : '<p style="color:#9ca3af">No activity yet.</p>';
  } catch (e) {
    console.error('[Admin]', e);
    if (adErr) { adErr.textContent = e.message || 'Failed to load.'; adErr.style.display = 'block'; }
    if (adFlagsEl) adFlagsEl.innerHTML = '<div class="flag-card"><div class="flag-label">No data</div></div>';
    if (adOrdersEl) adOrdersEl.innerHTML = emptyState('Could not load orders.', null, null);
    if (adMetricsEl) adMetricsEl.innerHTML = '<div class="metric-card"><div class="metric-label">Error</div></div>';
    if (adActivity) adActivity.innerHTML = '<p style="color:#9ca3af">No data.</p>';
  }
}

// ═══════════════════ TEAM ═══════════════════
async function pgTeam() {
  mc('mainContent', `<div class="page">
    <div class="header-row">
      <div class="page-header" style="margin-bottom:0"><h1>Team Management</h1><p>Invite and manage your team members</p></div>
      <button class="btn-sm-blue" onclick="openInvite()">+ Invite Member</button>
    </div><br>
    <div class="stat-grid" id="tmStats"><div class="stat-card"><div class="spinner-sm"></div></div></div>
    <div class="section-card">
      <div class="section-title">Team Members</div>
      <div class="section-sub">Change roles using the dropdown. You cannot change your own role.</div>
      <div id="tmList"><div style="padding:20px"><div class="spinner-sm"></div></div></div>
    </div>

    <!-- invite modal -->
    <div class="modal-bg" id="inviteModal">
      <div class="modal">
        <div class="modal-header"><h2>Invite Team Member</h2><button class="modal-close" onclick="closeInvite()">×</button></div>
        <div id="invMsg" class="err" style="display:none"></div>
        <div class="form-group"><label>Full Name *</label><input class="form-input" id="inv_name" placeholder="e.g. Sarah Johnson"></div>
        <div class="form-group"><label>Email Address *</label><input class="form-input" id="inv_email" type="email" placeholder="sarah@sturtee.com"></div>
        <div class="form-group"><label>Temporary Password *</label>
          <div style="position:relative">
            <input class="form-input" id="inv_pass" type="text" style="padding-right:88px">
            <button onclick="genPass()" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:#f3f4f6;border:none;border-radius:5px;padding:4px 10px;font-size:11px;cursor:pointer;font-family:inherit">Generate</button>
          </div>
        </div>
        <div class="form-group"><label>Role</label>
          <select class="form-select" id="inv_role">
            <option value="sales_rep">Sales Rep</option>
            <option value="designer">Designer</option>
            <option value="fulfillment">Fulfillment</option>
            <option value="admin">Admin</option>
            <option value="super_admin">Super Admin</option>
          </select>
        </div>
        <div class="btn-row">
          <button class="btn btn-ghost btn-full" onclick="closeInvite()">Cancel</button>
          <button class="btn btn-blue btn-full" id="invBtn" onclick="createMember()">Create Account</button>
        </div>
        <div class="info-box">💡 After creating the account, share the email and temporary password with the team member. They can sign in right away.</div>
      </div>
    </div>
  </div>`);
  await loadTeam();
  genPass();
}

async function loadTeam() {
  const { data: members } = await sb.from('users').select('*').order('created_at', { ascending: true });
  const { data: statsRows } = await sb.from('user_stats').select('*');
  const statsByUser = {}; (statsRows || []).forEach(s => { statsByUser[s.user_id] = s; });
  const m = (members || []).map(u => ({ ...u, _stats: statsByUser[u.id] }));

  const tmStatsEl = $('tmStats'); if (tmStatsEl) tmStatsEl.innerHTML = `
    <div class="stat-card"><div class="stat-bar" style="background:#0f75bc"></div><div><div class="stat-num">${m.length}</div><div class="stat-label">Total Members</div></div></div>
    <div class="stat-card"><div class="stat-bar" style="background:#dc2626"></div><div><div class="stat-num">${m.filter(x => x.role === 'admin' || x.role === 'super_admin').length}</div><div class="stat-label">Admins</div></div></div>
    <div class="stat-card"><div class="stat-bar" style="background:#2563eb"></div><div><div class="stat-num">${m.filter(x => x.role === 'sales_rep').length}</div><div class="stat-label">Sales Reps</div></div></div>
    <div class="stat-card"><div class="stat-bar" style="background:#7c3aed"></div><div><div class="stat-num">${m.filter(x => x.role === 'designer').length}</div><div class="stat-label">Designers</div></div></div>`;

  window._teamMembers = m;
  if (!m.length) { mc('tmList', emptyState('No team members yet.', null, null)); return; }

  const tmListEl = $('tmList'); if (!tmListEl) return;
  tmListEl.innerHTML = `<table class="team-table">
    <thead><tr>
      <th>Name</th><th>Email</th><th>Role</th><th>Joined</th><th>Actions</th>
    </tr></thead>
    <tbody>${m.map(u => `<tr>
      <td>
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:32px;height:32px;border-radius:50%;background:#0f75bc;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;color:#fff;flex-shrink:0">${(u.full_name || u.email).charAt(0).toUpperCase()}</div>
          <div><div style="font-weight:500">${escapeHtml(u.full_name || '—')}</div>${u.id === CU.id ? '<div style="font-size:11px;color:#9ca3af">You</div>' : ''}</div>
        </div>
      </td>
      <td style="color:#6b7280">${escapeHtml(u.email)}</td>
      <td>
        <select onchange="updateRole('${u.id}',this.value)" style="font-size:12px;padding:5px 8px;border:1px solid #e5e7eb;border-radius:6px;background:#f9fafb;font-family:inherit;cursor:pointer" ${u.id === CU.id ? 'disabled title="Cannot change your own role"' : ''}>
          <option value="sales_rep" ${u.role === 'sales_rep' ? 'selected' : ''}>Sales Rep</option>
          <option value="designer" ${u.role === 'designer' ? 'selected' : ''}>Designer</option>
          <option value="fulfillment" ${u.role === 'fulfillment' ? 'selected' : ''}>Fulfillment</option>
          <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
          <option value="super_admin" ${u.role === 'super_admin' ? 'selected' : ''}>Super Admin</option>
        </select>
      </td>
      <td style="color:#9ca3af;font-size:12px">${fmtDate(u.created_at)}</td>
      <td>${u.id !== CU.id ? `<button class="btn btn-ghost btn-sm" onclick="openEditMember('${u.id}')">Edit</button> <button class="btn btn-red btn-sm" onclick="removeMember('${u.id}','${escJs(u.full_name || u.email)}')">Remove</button>` : '—'}</td>
    </tr>`).join('')}
    </tbody>
  </table>`;
}

function openInvite() { const m = $('inviteModal'); if (m) m.classList.add('open'); }
function closeInvite() {
  const modal = $('inviteModal'); if (modal) modal.classList.remove('open');
  mc('invMsg', '');
  const invName = $('inv_name'), invEmail = $('inv_email'); if (invName) invName.value = ''; if (invEmail) invEmail.value = '';
  genPass();
}

function genPass() {
  const c = 'ABCDEFGHJKMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789!@#';
  let p = '';
  for (let i = 0; i < 12; i++) p += c[Math.floor(Math.random() * c.length)];
  const el = $('inv_pass'); if (el) el.value = p;
}

async function createMember() {
  const name = v('inv_name'), email = v('inv_email'), pass = v('inv_pass');
  const roleEl = $('inv_role'); const role = (roleEl && roleEl.value) ? roleEl.value : 'sales_rep';
  const msg = $('invMsg');
  if (!name || !email || !pass) { showErr(msg, '⚠ Please fill in all fields'); return; }
  const btn = $('invBtn');
  if (btn) { btn.disabled = true; btn.textContent = 'Creating...'; }

  const { data, error } = await sb.auth.signUp({ email, password: pass, options: { data: { full_name: name } } });
  if (error) { showErr(msg, '⚠ ' + error.message); if (btn) { btn.disabled = false; btn.textContent = 'Create Account'; } return; }

  if (data.user) {
    await sb.from('users').upsert({ id: data.user.id, email, full_name: name, role });
    auditLog('user_created', 'user', data.user.id, { email, role });
  }

  if (btn) { btn.disabled = false; btn.textContent = 'Create Account'; }
  msg.innerHTML = `<div style="background:#dcfce7;color:#16a34a;border-radius:8px;padding:12px 14px;font-size:13px;margin-bottom:14px;line-height:1.6">
    ✅ Account created!<br>
    <strong>Email:</strong> ${escapeHtml(email)}<br>
    <strong>Password:</strong> ${escapeHtml(pass)}<br>
    Share these with ${escapeHtml(name)}.
  </div>`;
  setTimeout(() => loadTeam(), 800);
}

async function updateRole(userId, newRole) {
  const { error } = await sb.from('users').update({ role: newRole }).eq('id', userId);
  if (error) alert('Error updating role: ' + error.message);
}

async function openEditMember(userId) {
  const u = (window._teamMembers || []).find(x => x.id === userId); if (!u) return;
  const perms = (u.permissions && typeof u.permissions === 'object') ? JSON.stringify(u.permissions, null, 2) : '{}';
  const st = u._stats || {};
  const modal = document.createElement('div'); modal.className = 'modal-bg open'; modal.id = 'editMemberModal';
  modal.innerHTML = `<div class="modal" style="max-width:520px;max-height:90vh;overflow-y:auto"><div class="modal-header"><h2>Edit member</h2><button class="modal-close" onclick="$('editMemberModal').remove()">×</button></div>
  <div id="emMsg" class="err" style="display:none"></div>
  <p style="font-weight:600;margin-bottom:8px">${escapeHtml(u.full_name || u.email)}</p>
  <div class="form-group"><label>Role</label><select class="form-select" id="em_role"><option value="sales_rep">Sales Rep</option><option value="designer">Designer</option><option value="fulfillment">Fulfillment</option><option value="admin">Admin</option><option value="super_admin">Super Admin</option></select></div>
  <div class="form-group"><label>Permissions (JSON)</label><textarea class="form-textarea" id="em_permissions" style="min-height:60px;font-size:12px">${escapeHtml(perms)}</textarea></div>
  <div class="form-section-title">Stats</div>
  <div class="form-row"><div class="form-group"><label>Orders count</label><input class="form-input" id="em_orders_count" type="number" value="${st.orders_count ?? 0}"></div><div class="form-group"><label>Revenue</label><input class="form-input" id="em_revenue" type="number" step="0.01" value="${st.revenue ?? 0}"></div></div>
  <div class="form-group"><label>Design count</label><input class="form-input" id="em_design_count" type="number" value="${st.design_count ?? 0}"></div>
  <div class="form-section-title" style="margin-top:16px">Activity (last 50)</div>
  <div id="emActivity" style="max-height:200px;overflow-y:auto;font-size:12px;color:#6b7280"><div class="spinner-sm"></div></div>
  <button class="btn btn-blue btn-full" onclick="saveEditMember('${userId}')">Save</button></div>`;
  document.body.appendChild(modal);
  const roleEl = $('em_role'); if (roleEl && u.role) roleEl.value = u.role;
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
  const actEl = $('emActivity'); if (actEl) {
    const { data: logs } = await sb.from('audit_log').select('action,entity_type,entity_id,created_at').eq('user_id', userId).order('created_at', { ascending: false }).limit(50);
    actEl.innerHTML = (logs && logs.length) ? logs.map(l => `<div style="padding:6px 0;border-bottom:1px solid #f3f4f6">${escapeHtml(l.action)} · ${l.entity_type || ''} · ${timeAgo(l.created_at)}</div>`).join('') : '<p style="color:#9ca3af">No activity yet.</p>';
  }
}

async function saveEditMember(userId) {
  const msg = $('emMsg');
  let perms = {};
  try { perms = JSON.parse(v('em_permissions') || '{}'); } catch (e) { showErr(msg, 'Invalid JSON for permissions'); return; }
  const role = ($('em_role') && $('em_role').value) || 'sales_rep';
  const ordersCount = parseInt(v('em_orders_count'), 10) || 0;
  const revenue = parseFloat(v('em_revenue')) || 0;
  const designCount = parseInt(v('em_design_count'), 10) || 0;
  const { error: uErr } = await sb.from('users').update({ role, permissions: perms }).eq('id', userId);
  if (uErr) { showErr(msg, uErr.message); return; }
  await sb.from('user_stats').upsert({ user_id: userId, orders_count: ordersCount, revenue, design_count: designCount, updated_at: new Date().toISOString() }, { onConflict: 'user_id' });
  $('editMemberModal')?.remove();
  loadTeam();
}

async function removeMember(userId, name) {
  if (!confirm(`Remove ${name} from the team?`)) return;
  await sb.from('users').delete().eq('id', userId);
  loadTeam();
}

// ═══════════════════ START ═══════════════════
boot();
</script>
</body>
</html>
