<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sturtee Merch Portal</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:#f1f3f5;color:#0f75bc;font-size:14px}
.app{display:flex;height:100vh;overflow:hidden}
.sidebar{width:230px;flex-shrink:0;background:#fff;border-right:1px solid #e5e7eb;display:flex;flex-direction:column;overflow-y:auto}
.main-content{flex:1;overflow-y:auto;padding:32px 36px}
.top-bar{background:#f8f9fa;border-bottom:1px solid #dee2e6;padding:8px 20px;font-size:12px;color:#9ca3af}
.sidebar-brand{padding:20px 20px 12px;border-bottom:1px solid #f3f4f6}
.sidebar-brand h2{font-size:16px;font-weight:700;color:#0f75bc}
.sidebar-brand p{font-size:11px;color:#9ca3af;margin-top:2px}
.sidebar-user{padding:14px 16px;border-bottom:1px solid #f3f4f6;display:flex;align-items:center;gap:10px}
.avatar{width:32px;height:32px;border-radius:50%;background:#e5e7eb;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:13px;color:#6b7280;flex-shrink:0}
.user-name{font-size:13px;font-weight:600;color:#0f75bc}
.role-badge{display:inline-block;font-size:10px;font-weight:600;padding:2px 7px;border-radius:4px;margin-top:3px;text-transform:lowercase}
.badge-admin{background:#fee2e2;color:#dc2626}
.badge-sales_rep{background:#dbeafe;color:#2563eb}
.badge-designer{background:#ede9fe;color:#7c3aed}
.badge-fulfillment{background:#dcfce7;color:#16a34a}
.badge-super_admin{background:#0f75bc;color:#fff}
.nav{padding:12px 0;flex:1}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 20px;font-size:13.5px;color:#4b5563;cursor:pointer;transition:background .15s}
.nav-item:hover{background:#f9fafb;color:#0f75bc}
.nav-item.active{background:#f3f4f6;color:#0f75bc;font-weight:500}
.nav-item svg{width:16px;height:16px;flex-shrink:0;opacity:.7}
.nav-item.active svg{opacity:1}
.sidebar-footer{padding:12px 0;border-top:1px solid #f3f4f6}
.sign-out{display:flex;align-items:center;gap:10px;padding:9px 20px;font-size:13px;color:#6b7280;cursor:pointer}
.sign-out:hover{color:#0f75bc}
.login-page{min-height:100vh;background:#f1f3f5;display:flex;flex-direction:column}
.login-topbar{padding:10px 20px;font-size:12px;color:#9ca3af}
.login-wrap{flex:1;display:flex;align-items:center;justify-content:center;padding:40px 20px}
.login-inner{width:100%;max-width:420px}
.login-logo{display:flex;flex-direction:column;align-items:center;margin-bottom:24px}
.logo-icon{width:52px;height:52px;background:#0f75bc;border-radius:14px;display:flex;align-items:center;justify-content:center;margin-bottom:14px}
.login-inner h1{font-size:22px;font-weight:700;text-align:center}
.subtitle{font-size:13px;color:#6b7280;text-align:center;margin-top:4px}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:24px;margin-bottom:16px}
.card h3{font-size:16px;font-weight:600;margin-bottom:4px}
.card-sub{font-size:12px;color:#6b7280;margin-bottom:20px}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:13px;font-weight:500;margin-bottom:6px}
.form-input{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px;font-family:inherit;background:#f9fafb;color:#0f75bc;outline:none;transition:border .15s}
.form-input:focus{border-color:#3b82f6;background:#fff}
.btn-primary{width:100%;padding:11px;background:#0f75bc;color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;transition:background .15s}
.btn-primary:hover{background:#0d69a8}
.btn-primary:disabled{background:#9ca3af;cursor:not-allowed}
.demo-account{display:flex;align-items:center;gap:12px;padding:10px 14px;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;transition:background .15s;margin-bottom:6px}
.demo-account:hover{background:#f9fafb}
.demo-avatar{width:30px;height:30px;border-radius:50%;background:#e5e7eb;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;color:#6b7280;flex-shrink:0}
.demo-info strong{font-size:13px;font-weight:600;display:block}
.demo-info span{font-size:11px;color:#9ca3af}
.login-footer{text-align:center;font-size:11px;color:#9ca3af;padding:16px}
.error-msg{background:#fee2e2;color:#dc2626;border-radius:8px;padding:10px 14px;font-size:13px;margin-bottom:14px;display:none}
.success-msg{background:#dcfce7;color:#16a34a;border-radius:8px;padding:10px 14px;font-size:13px;margin-bottom:14px;display:none}
.loading-screen{display:flex;align-items:center;justify-content:center;height:100vh;background:#f1f3f5;flex-direction:column;gap:12px}
.spinner{width:32px;height:32px;border:3px solid #e5e7eb;border-top-color:#0f75bc;border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.page-header{margin-bottom:28px}
.page-header h1{font-size:22px;font-weight:700}
.page-header p{font-size:13px;color:#6b7280;margin-top:3px}
.header-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:28px}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:18px 20px;display:flex;align-items:flex-start;gap:14px}
.stat-bar{width:4px;height:40px;border-radius:2px;flex-shrink:0;margin-top:2px}
.stat-num{font-size:28px;font-weight:700;line-height:1}
.stat-label{font-size:12px;color:#6b7280;margin-top:4px}
.quick-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:24px}
.quick-card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:16px 18px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:border-color .15s,box-shadow .15s}
.quick-card:hover{border-color:#d1d5db;box-shadow:0 2px 8px rgba(0,0,0,.06)}
.quick-icon{width:36px;height:36px;border-radius:8px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.quick-icon svg{width:18px;height:18px}
.quick-info strong{font-size:14px;font-weight:600;display:block}
.quick-info span{font-size:12px;color:#9ca3af}
.section-card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:20px 24px;margin-bottom:16px}
.section-title{font-size:15px;font-weight:600;margin-bottom:4px}
.section-sub{font-size:12px;color:#6b7280;margin-bottom:16px}
.activity-item{display:flex;align-items:center;gap:12px;padding:11px 0;border-bottom:1px solid #f3f4f6}
.activity-item:last-child{border-bottom:none}
.activity-icon{width:30px;height:30px;border-radius:8px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.activity-info{flex:1}
.activity-info strong{font-size:13px;font-weight:500}
.activity-info span{font-size:11px;color:#9ca3af;display:block;margin-top:1px}
.status-pill{font-size:11px;font-weight:500;padding:3px 10px;border-radius:6px;border:1px solid #e5e7eb;white-space:nowrap}
.pill-pending,.pill-intake{border-color:#e5e7eb;color:#6b7280;background:#fff}
.pill-approved{background:#0f75bc;color:#fff;border-color:#0f75bc}
.pill-shipped{background:#0f75bc;color:#fff;border-color:#0f75bc}
.pill-pending-approval{background:#fef3c7;color:#d97706;border-color:#fde68a}
.pill-in-progress,.pill-design{background:#dbeafe;color:#2563eb;border-color:#bfdbfe}
.pill-completed,.pill-complete{background:#dcfce7;color:#16a34a;border-color:#bbf7d0}
.pill-revision{background:#fed7aa;color:#c2410c;border-color:#fdba74}
.pill-rush{background:#fee2e2;color:#dc2626;border-color:#fecaca;font-size:10px}
.pill-production{background:#dbeafe;color:#2563eb;border-color:#bfdbfe}
.pill-fulfillment,.pill-ready{background:#fef3c7;color:#d97706;border-color:#fde68a}
.pill-transit{background:#ede9fe;color:#7c3aed;border-color:#ddd6fe}
.pill-inactive{background:#f3f4f6;color:#6b7280;border-color:#e5e7eb}
.pill-quote{background:#ede9fe;color:#7c3aed;border-color:#ddd6fe}
.tab-bar{display:flex;background:#f3f4f6;border-radius:8px;padding:3px;margin-bottom:20px;width:fit-content}
.tab{padding:7px 18px;border-radius:6px;font-size:13px;cursor:pointer;color:#6b7280;transition:all .15s;white-space:nowrap}
.tab.active{background:#fff;color:#0f75bc;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,.1)}
.design-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px}
.design-card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:20px}
.design-card-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:4px}
.design-card-header h3{font-size:15px;font-weight:600;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.design-card-sub{font-size:12px;color:#6b7280;margin-bottom:16px}
.design-meta{display:grid;grid-template-columns:1fr 1fr;gap:10px 20px;margin-bottom:14px}
.meta-item label{font-size:11px;color:#9ca3af;display:block;margin-bottom:2px}
.meta-item span{font-size:13px;font-weight:500}
.notes-box{background:#f9fafb;border-radius:6px;padding:10px 12px;font-size:12px;color:#6b7280;margin-bottom:14px}
.notes-box label{display:block;font-size:11px;color:#9ca3af;margin-bottom:4px}
.btn-dark{width:100%;padding:10px;background:#0f75bc;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:6px;transition:background .15s}
.btn-dark:hover{background:#0d69a8}
.btn-outline{width:100%;padding:10px;background:#fff;color:#0f75bc;border:1px solid #e5e7eb;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:6px;transition:background .15s}
.btn-outline:hover{background:#f9fafb}
.btn-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.btn-sm-dark{padding:8px 16px;background:#0f75bc;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:6px;white-space:nowrap}
.form-card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:28px;max-width:700px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.form-section{margin-bottom:24px}
.form-section-title{font-size:13px;font-weight:600;margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid #f3f4f6}
.form-select{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px;font-family:inherit;background:#f9fafb;color:#0f75bc;outline:none}
.form-textarea{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px;font-family:inherit;background:#f9fafb;color:#0f75bc;outline:none;resize:vertical;min-height:80px}
.approval-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:16px}
.mockup-thumbs{display:flex;gap:8px;margin:14px 0;flex-wrap:wrap}
.mockup-thumb{width:68px;height:68px;border:1px solid #e5e7eb;border-radius:8px;background:#f9fafb;display:flex;align-items:center;justify-content:center}
.fulfillment-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px}
.special-box{background:#fff8f0;border:1px solid #fed7aa;border-radius:6px;padding:10px 12px;margin:10px 0;font-size:12px;color:#92400e}
.product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
.product-card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:20px}
.chapter-tags{display:flex;flex-wrap:wrap;gap:6px;margin:10px 0}
.chapter-tag{font-size:11px;padding:2px 8px;background:#f3f4f6;border-radius:4px;color:#374151}
.flag-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:12px;margin-bottom:24px}
.flag-card{background:#fff;border:1px solid #fecaca;border-radius:10px;padding:16px 18px;display:flex;align-items:flex-start;gap:14px}
.flag-bar{width:4px;height:36px;border-radius:2px;flex-shrink:0}
.flag-num{font-size:24px;font-weight:700;line-height:1}
.flag-label{font-size:12px;color:#6b7280;margin-top:3px}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.metric-card{background:#f9fafb;border-radius:8px;padding:14px 16px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
.metric-val{font-size:22px;font-weight:700}
.metric-label{font-size:12px;color:#6b7280}
.page{animation:fadeUp .2s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.order-num{font-family:monospace;font-size:12px;color:#6b7280}
@media(max-width:700px){.two-col,.form-row{grid-template-columns:1fr}.sidebar{width:200px}.main-content{padding:20px 16px}}
</style>
</head>
<body>

<div id="loadingScreen" class="loading-screen">
  <div class="spinner"></div>
  <div style="font-size:13px;color:#9ca3af">Loading Sturtee...</div>
</div>

<div id="loginPage" class="login-page" style="display:none">
  <div class="login-topbar">Sturtee Merchandise Workflow System</div>
  <div class="login-wrap">
    <div class="login-inner">
      <div class="login-logo">
        <div class="logo-icon">
          <svg width="26" height="26" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
        </div>
        <h1>Sturtee Merch Portal</h1>
        <p class="subtitle">Sign in to access the workflow system</p>
      </div>
      <div class="card">
        <h3>Sign In</h3>
        <p class="card-sub">Enter your credentials to continue</p>
        <div id="loginError" class="error-msg"></div>
        <div id="loginSuccess" class="success-msg"></div>
        <div class="form-group"><label>Email</label><input type="email" class="form-input" id="loginEmail" placeholder="you@sturtee.com"></div>
        <div class="form-group"><label>Password</label><input type="password" class="form-input" id="loginPassword" placeholder="Enter password" onkeydown="if(event.key==='Enter')handleLogin()"></div>
        <button class="btn-primary" id="loginBtn" onclick="handleLogin()">Sign In</button>
      </div>
      <div class="login-footer">Sturtee Merch Portal ¬∑ v1.0</div>
    </div>
  </div>
</div>

<div id="appShell" class="app" style="display:none">
  <div class="sidebar">
    <div class="sidebar-brand"><h2>Sturtee Merch</h2><p>Workflow Portal</p></div>
    <div class="sidebar-user">
      <div class="avatar" id="sidebarAvatar">?</div>
      <div class="user-info">
        <div class="user-name" id="sidebarName">Loading...</div>
        <span class="role-badge" id="sidebarBadge">...</span>
      </div>
    </div>
    <nav class="nav" id="sidebarNav"></nav>
    <div class="sidebar-footer">
      <div class="sign-out" onclick="signOut()">
        <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
        Sign Out
      </div>
    </div>
  </div>
  <div style="flex:1;display:flex;flex-direction:column;overflow:hidden">
    <div class="top-bar">Merchandise Workflow System</div>
    <div class="main-content" id="mainContent"></div>
  </div>
</div>

<script>
const SUPABASE_URL='https://xtgtihetywvytwqiyriw.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh0Z3RpaGV0eXd2eXR3cWl5cml3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NDUyMDIsImV4cCI6MjA4NzAyMTIwMn0.YPRcqWz7uFR-WybGnK6HcZ_v-EYCeedDgLJB4_4iQUU';
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
let currentUser=null,currentProfile=null,currentPage='dashboard';

const NAV_BY_ROLE={
  super_admin:['dashboard','quote-request','design-queue','approvals','fulfillment','storefront','admin-panel','team'],
  admin:['dashboard','quote-request','design-queue','approvals','fulfillment','storefront','admin-panel','team'],
  sales_rep:['dashboard','quote-request','approvals','storefront'],
  designer:['dashboard','design-queue','approvals'],
  fulfillment:['dashboard','fulfillment']
};
const NAV={
  'dashboard':{label:'Dashboard',icon:'<circle cx="12" cy="12" r="3"/><path d="M19.07 4.93l-1.41 1.41M5.34 18.66l-1.41 1.41M2 12H4M20 12h2M6.34 5.34L4.93 3.93M18.66 18.66l1.41 1.41M12 2v2M12 20v2"/>'},
  'quote-request':{label:'Quote Request',icon:'<path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>'},
  'design-queue':{label:'Design Queue',icon:'<circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2M9 9h.01M15 9h.01"/>'},
  'approvals':{label:'Approvals',icon:'<path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>'},
  'fulfillment':{label:'Fulfillment',icon:'<path d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>'},
  'storefront':{label:'Storefront',icon:'<path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>'},
  'admin-panel':{label:'Admin',icon:'<path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/>'},
  'team':{label:'Team',icon:'<path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>'}
};

async function boot(){
  const{data:{session}}=await sb.auth.getSession();
  if(session)await loadProfile(session.user);
  else showLogin();
}

async function loadProfile(user){
  currentUser=user;
  const{data:profile}=await sb.from('users').select('*').eq('id',user.id).single();
  if(!profile){
    const{data:np}=await sb.from('users').insert({id:user.id,email:user.email,full_name:user.user_metadata?.full_name||user.email.split('@')[0],role:'admin'}).select().single();
    currentProfile=np;
  }else{currentProfile=profile;}
  showApp();
}

function showLogin(){
  document.getElementById('loadingScreen').style.display='none';
  document.getElementById('loginPage').style.display='flex';
  document.getElementById('appShell').style.display='none';
}

function showApp(){
  document.getElementById('loadingScreen').style.display='none';
  document.getElementById('loginPage').style.display='none';
  document.getElementById('appShell').style.display='flex';
  const name=currentProfile?.full_name||currentUser.email;
  const role=currentProfile?.role||'admin';
  document.getElementById('sidebarAvatar').textContent=name.charAt(0).toUpperCase();
  document.getElementById('sidebarName').textContent=name;
  const badge=document.getElementById('sidebarBadge');
  badge.textContent=role.replace('_',' ');
  badge.className='role-badge badge-'+role;
  buildNav(role);
  navigate('dashboard');
}

async function handleLogin(){
  const email=document.getElementById('loginEmail').value.trim();
  const password=document.getElementById('loginPassword').value;
  const errEl=document.getElementById('loginError');
  const btn=document.getElementById('loginBtn');
  if(!email||!password){showErr(errEl,'Please enter email and password');return;}
  btn.disabled=true;btn.textContent='Signing in...';
  const{data,error}=await sb.auth.signInWithPassword({email,password});
  btn.disabled=false;btn.textContent='Sign In';
  if(error){showErr(errEl,error.message);return;}
  errEl.style.display='none';
  await loadProfile(data.user);
}


  if(password.length<6){showErr(errEl,'Password must be at least 6 characters');return;}
  const{error}=await sb.auth.signUp({email,password,options:{data:{full_name:name}}});
  if(error){showErr(errEl,error.message);return;}
  errEl.style.display='none';
  const s=document.getElementById('loginSuccess');
  s.textContent='Account created! Check your email to confirm, then sign in.';
  s.style.display='block';
}

async function signOut(){
  await sb.auth.signOut();
  currentUser=null;currentProfile=null;
  showLogin();
}

function showErr(el,msg){el.textContent=msg;el.style.display='block';}

function buildNav(role){
  const pages=NAV_BY_ROLE[role]||['dashboard'];
  document.getElementById('sidebarNav').innerHTML=pages.map(p=>`<div class="nav-item" id="nav-${p}" onclick="navigate('${p}')"><svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">${NAV[p].icon}</svg>${NAV[p].label}</div>`).join('');
}

function navigate(page){
  currentPage=page;
  document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
  const el=document.getElementById('nav-'+page);
  if(el)el.classList.add('active');
  const renders={dashboard:renderDashboard,'quote-request':renderQuoteRequest,'design-queue':renderDesignQueue,approvals:renderApprovals,fulfillment:renderFulfillment,storefront:renderStorefront,'admin-panel':renderAdminPanel,team:renderTeam};
  (renders[page]||renderDashboard)();
}

function setTab(c,el){
  if(typeof c==='string')c=document.getElementById(c);
  c.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
}

function timeAgo(d){
  const diff=Date.now()-new Date(d).getTime();
  const m=Math.floor(diff/60000);
  if(m<60)return m+'m ago';
  const h=Math.floor(m/60);
  if(h<24)return h+'h ago';
  return Math.floor(h/24)+'d ago';
}

async function updateOrderStatus(id,status){
  const{error}=await sb.from('orders').update({status,updated_at:new Date().toISOString()}).eq('id',id);
  if(error){alert('Error: '+error.message);return;}
  navigate(currentPage);
}

// ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ
async function renderDashboard(){
  const main=document.getElementById('mainContent');
  main.innerHTML=`<div class="page">
    <div class="page-header"><h1>Merchandise Workflow</h1><p>Monitor and manage all orders across the pipeline</p></div>
    <div class="stat-grid" id="dashStats"><div class="stat-card"><div class="spinner" style="width:20px;height:20px;border-width:2px"></div></div></div>
    <div class="quick-grid">
      <div class="quick-card" onclick="navigate('quote-request')"><div class="quick-icon"><svg fill="none" viewBox="0 0 24 24" stroke="#4b5563" stroke-width="2"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg></div><div class="quick-info"><strong>New Quote</strong><span>Create quote request</span></div></div>
      <div class="quick-card" onclick="navigate('design-queue')"><div class="quick-icon"><svg fill="none" viewBox="0 0 24 24" stroke="#4b5563" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2M9 9h.01M15 9h.01"/></svg></div><div class="quick-info"><strong>Design Queue</strong><span>View pending designs</span></div></div>
      <div class="quick-card" onclick="navigate('approvals')"><div class="quick-icon"><svg fill="none" viewBox="0 0 24 24" stroke="#4b5563" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg></div><div class="quick-info"><strong>Approvals</strong><span>Review submissions</span></div></div>
      <div class="quick-card" onclick="navigate('fulfillment')"><div class="quick-icon"><svg fill="none" viewBox="0 0 24 24" stroke="#4b5563" stroke-width="2"><path d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg></div><div class="quick-info"><strong>Fulfillment</strong><span>Track shipments</span></div></div>
      <div class="quick-card" onclick="navigate('storefront')"><div class="quick-icon"><svg fill="none" viewBox="0 0 24 24" stroke="#4b5563" stroke-width="2"><path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg></div><div class="quick-info"><strong>Storefront</strong><span>Manage products</span></div></div>
    </div>
    <div class="section-card">
      <div class="section-title">Recent Orders</div>
      <div class="section-sub">Latest activity across all workflows</div>
      <div id="recentOrders"><div style="text-align:center;padding:20px;color:#9ca3af;font-size:13px">Loading...</div></div>
    </div>
  </div>`;

  const{data:orders}=await sb.from('orders').select('status');
  if(orders){
    const c={intake:0,quote:0,design:0,production:0,fulfillment:0};
    orders.forEach(o=>{if(c[o.status]!==undefined)c[o.status]++;});
    document.getElementById('dashStats').innerHTML=`
      <div class="stat-card"><div class="stat-bar" style="background:#3b82f6"></div><div><div class="stat-num">${c.intake+c.quote}</div><div class="stat-label">Pending Quotes</div></div></div>
      <div class="stat-card"><div class="stat-bar" style="background:#8b5cf6"></div><div><div class="stat-num">${c.design}</div><div class="stat-label">In Design</div></div></div>
      <div class="stat-card"><div class="stat-bar" style="background:#f59e0b"></div><div><div class="stat-num">${c.production}</div><div class="stat-label">In Production</div></div></div>
      <div class="stat-card"><div class="stat-bar" style="background:#22c55e"></div><div><div class="stat-num">${c.fulfillment}</div><div class="stat-label">Ready to Fulfill</div></div></div>`;
  }

  const role=currentProfile?.role;
  let q=sb.from('orders').select('*').order('created_at',{ascending:false}).limit(6);
  if(role==='sales_rep')q=q.eq('rep_id',currentUser.id);
  const{data:recent}=await q;
  const el=document.getElementById('recentOrders');
  if(!recent||!recent.length){
    el.innerHTML=`<div style="text-align:center;padding:30px;color:#9ca3af;font-size:13px">No orders yet. <span style="color:#3b82f6;cursor:pointer" onclick="navigate('quote-request')">Create your first quote ‚Üí</span></div>`;
    return;
  }
  el.innerHTML=recent.map(o=>`<div class="activity-item">
    <div class="activity-icon"><svg width="15" height="15" fill="none" viewBox="0 0 24 24" stroke="#9ca3af" stroke-width="2"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg></div>
    <div class="activity-info"><strong>${o.client_name}${o.event_name?' ‚Äì '+o.event_name:''}</strong><span>${timeAgo(o.created_at)}</span></div>
    <span class="status-pill pill-${o.status}">${o.status}</span>
  </div>`).join('');
}

// ‚îÄ‚îÄ QUOTE REQUEST ‚îÄ‚îÄ
function renderQuoteRequest(){
  document.getElementById('mainContent').innerHTML=`<div class="page">
    <div class="page-header"><h1>Quote Request</h1><p>Submit a new merchandise order request</p></div>
    <div id="quoteMsg"></div>
    <div class="form-card">
      <div class="form-section">
        <div class="form-section-title">Client Information</div>
        <div class="form-row">
          <div class="form-group"><label>Client Name *</label><input class="form-input" id="q_client" placeholder="e.g. Alpha Phi"></div>
          <div class="form-group"><label>Organization</label><input class="form-input" id="q_org" placeholder="e.g. Kappa Delta"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Event / Campaign</label><input class="form-input" id="q_event" placeholder="e.g. Spring Formal 2026"></div>
          <div class="form-group"><label>Contact Email</label><input class="form-input" id="q_email" type="email" placeholder="client@org.com"></div>
        </div>
      </div>
      <div class="form-section">
        <div class="form-section-title">Order Details</div>
        <div class="form-row">
          <div class="form-group"><label>Garment Type</label><select class="form-select" id="q_garment"><option>T-Shirt</option><option>Hoodie</option><option>Tank Top</option><option>Crewneck</option><option>Long Sleeve</option><option>Hat</option></select></div>
          <div class="form-group"><label>Print Method</label><select class="form-select" id="q_print"><option>Screen Print</option><option>Embroidery</option><option>DTG</option><option>Sublimation</option></select></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Quantity *</label><input class="form-input" id="q_qty" type="number" placeholder="e.g. 50"></div>
          <div class="form-group"><label>Budget ($)</label><input class="form-input" id="q_budget" placeholder="e.g. 1200"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label>Required By Date</label><input class="form-input" id="q_date" type="date"></div>
          <div class="form-group"><label>Fulfillment Type</label><select class="form-select" id="q_fulfill"><option value="bulk">Bulk Delivery</option><option value="individual">Individual Ship</option></select></div>
        </div>
        <div class="form-group"><label>Rush Order?</label><select class="form-select" id="q_rush"><option value="false">No ‚Äì Standard</option><option value="true">Yes ‚Äì Rush (+25%)</option></select></div>
      </div>
      <div class="form-section">
        <div class="form-section-title">Design Brief</div>
        <div class="form-group"><label>Design Description</label><textarea class="form-textarea" id="q_notes" placeholder="Describe what you want. Colors, placement, text, logos..."></textarea></div>
      </div>
      <button class="btn-primary" onclick="submitQuote()">Submit Quote Request</button>
    </div>
  </div>`;
}

async function submitQuote(){
  const client=document.getElementById('q_client').value.trim();
  const qty=parseInt(document.getElementById('q_qty').value);
  const msg=document.getElementById('quoteMsg');
  if(!client){showErr(msg,'Client name is required');return;}
  if(!qty||qty<1){showErr(msg,'Please enter a valid quantity');return;}
  msg.style.display='none';
  const{error}=await sb.from('orders').insert({
    client_name:client,
    organization:document.getElementById('q_org').value.trim(),
    event_name:document.getElementById('q_event').value.trim(),
    garment_type:document.getElementById('q_garment').value,
    print_method:document.getElementById('q_print').value,
    quantity:qty,
    budget:parseFloat(document.getElementById('q_budget').value)||null,
    timeline_date:document.getElementById('q_date').value||null,
    fulfillment_type:document.getElementById('q_fulfill').value,
    is_rush:document.getElementById('q_rush').value==='true',
    design_notes:document.getElementById('q_notes').value.trim(),
    rep_id:currentUser.id,
    status:'intake'
  });
  if(error){showErr(msg,'Error: '+error.message);return;}
  msg.style.cssText='display:block;background:#dcfce7;color:#16a34a;border-radius:8px;padding:10px 14px;font-size:13px;margin-bottom:14px';
  msg.textContent='‚úÖ Quote submitted! Redirecting to dashboard...';
  setTimeout(()=>navigate('dashboard'),1500);
}

// ‚îÄ‚îÄ DESIGN QUEUE ‚îÄ‚îÄ
async function renderDesignQueue(){
  document.getElementById('mainContent').innerHTML=`<div class="page">
    <div class="page-header"><h1>Design Queue</h1><p>Manage mockup creation and design workflow</p></div>
    <div class="stat-grid" id="dqStats"><div class="stat-card"><div class="spinner" style="width:20px;height:20px;border-width:2px"></div></div></div>
    <div class="tab-bar">
      <div class="tab active" onclick="setTab(this.parentElement,this);filterDesigns('all')">All Designs</div>
      <div class="tab" onclick="setTab(this.parentElement,this);filterDesigns('intake')">Pending</div>
      <div class="tab" onclick="setTab(this.parentElement,this);filterDesigns('design')">In Progress</div>
      <div class="tab" onclick="setTab(this.parentElement,this);filterDesigns('production')">Production</div>
    </div>
    <div class="design-grid" id="designCards"><div style="color:#9ca3af;font-size:13px">Loading...</div></div>
  </div>`;
  const{data:orders}=await sb.from('orders').select('*').in('status',['intake','quote','design','production']).order('created_at',{ascending:false});
  window._dqOrders=orders||[];
  renderDesignCards(window._dqOrders);
  const o=window._dqOrders;
  document.getElementById('dqStats').innerHTML=`
    <div class="stat-card"><div><div class="stat-num">${o.filter(x=>x.status==='intake').length}</div><div class="stat-label">Pending</div></div></div>
    <div class="stat-card"><div><div class="stat-num">${o.filter(x=>x.status==='design').length}</div><div class="stat-label">In Progress</div></div></div>
    <div class="stat-card"><div><div class="stat-num">${o.filter(x=>x.status==='production').length}</div><div class="stat-label">Production</div></div></div>
    <div class="stat-card"><div><div class="stat-num">${o.length}</div><div class="stat-label">Total</div></div></div>`;
}

function filterDesigns(s){
  const o=window._dqOrders||[];
  renderDesignCards(s==='all'?o:o.filter(x=>x.status===s));
}

function renderDesignCards(orders){
  const el=document.getElementById('designCards');
  if(!orders.length){el.innerHTML=`<div style="color:#9ca3af;font-size:13px;padding:20px">No orders found.</div>`;return;}
  el.innerHTML=orders.map(o=>{
    const pill=o.status==='design'?'pill-in-progress':o.status==='production'?'pill-production':'pill-pending';
    return `<div class="design-card">
      <div class="design-card-header"><h3>${o.client_name}${o.is_rush?' <span class="status-pill pill-rush">RUSH</span>':''}</h3><span class="status-pill ${pill}">${o.status}</span></div>
      <div class="design-card-sub">${o.event_name||o.organization||'‚Äî'}</div>
      <div class="design-meta">
        <div class="meta-item"><label>Product:</label><span>${o.garment_type||'‚Äî'}</span></div>
        <div class="meta-item"><label>Quantity:</label><span>${o.quantity||'‚Äî'} units</span></div>
        <div class="meta-item"><label>Due Date:</label><span>${o.timeline_date||'TBD'}</span></div>
        <div class="meta-item"><label>Order #:</label><span class="order-num">${o.order_number||'‚Äî'}</span></div>
      </div>
      ${o.design_notes?`<div class="notes-box"><label>Notes:</label>${o.design_notes}</div>`:''}
      <div class="btn-row">
        <button class="btn-outline" onclick="updateOrderStatus('${o.id}','design')">‚ñ∂ Start Design</button>
        <button class="btn-dark" onclick="updateOrderStatus('${o.id}','production')">‚úì To Production</button>
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ APPROVALS ‚îÄ‚îÄ
async function renderApprovals(){
  document.getElementById('mainContent').innerHTML=`<div class="page">
    <div class="page-header"><h1>Approval Flow</h1><p>Review and approve design mockups</p></div>
    <div class="stat-grid" id="appStats"><div class="stat-card"><div class="spinner" style="width:20px;height:20px;border-width:2px"></div></div></div>
    <div class="tab-bar"><div class="tab active" onclick="setTab(this.parentElement,this)">Pending Review</div><div class="tab" onclick="setTab(this.parentElement,this)">Approved</div><div class="tab" onclick="setTab(this.parentElement,this)">All</div></div>
    <div class="approval-grid" id="appCards"><div style="color:#9ca3af;font-size:13px">Loading...</div></div>
  </div>`;
  const{data:orders}=await sb.from('orders').select('*').in('status',['design','production']).order('created_at',{ascending:false});
  const list=orders||[];
  document.getElementById('appStats').innerHTML=`
    <div class="stat-card"><div><div class="stat-num">${list.filter(o=>o.status==='design').length}</div><div class="stat-label">Pending Review</div></div></div>
    <div class="stat-card"><div><div class="stat-num">${list.filter(o=>o.status==='production').length}</div><div class="stat-label">Approved</div></div></div>
    <div class="stat-card"><div><div class="stat-num">0</div><div class="stat-label">Revisions</div></div></div>
    <div class="stat-card"><div><div class="stat-num">${list.length}</div><div class="stat-label">Total</div></div></div>`;
  if(!list.length){document.getElementById('appCards').innerHTML=`<div style="color:#9ca3af;font-size:13px;padding:20px">No items pending approval.</div>`;return;}
  document.getElementById('appCards').innerHTML=list.map(o=>`
    <div class="design-card">
      <div class="design-card-header"><h3>${o.client_name}</h3><span class="status-pill pill-pending-approval">pending approval</span></div>
      <div class="design-card-sub">${o.event_name||o.organization||'‚Äî'}</div>
      <div class="design-meta">
        <div class="meta-item"><label>Product:</label><span>${o.garment_type||'‚Äî'}</span></div>
        <div class="meta-item"><label>Quantity:</label><span>${o.quantity||'‚Äî'} units</span></div>
        <div class="meta-item"><label>Method:</label><span>${o.print_method||'‚Äî'}</span></div>
        <div class="meta-item"><label>Order #:</label><span class="order-num">${o.order_number||'‚Äî'}</span></div>
      </div>
      ${o.design_notes?`<div class="notes-box"><label>Design Notes:</label>${o.design_notes}</div>`:''}
      <div class="mockup-thumbs"><div class="mockup-thumb"><svg fill="none" viewBox="0 0 24 24" stroke="#d1d5db" stroke-width="1.5"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></div></div>
      <div class="btn-row">
        <button class="btn-outline" onclick="updateOrderStatus('${o.id}','design')">‚Ü© Request Revision</button>
        <button class="btn-dark" onclick="updateOrderStatus('${o.id}','fulfillment')">‚úì Approve</button>
      </div>
    </div>`).join('');
}

// ‚îÄ‚îÄ FULFILLMENT ‚îÄ‚îÄ
async function renderFulfillment(){
  document.getElementById('mainContent').innerHTML=`<div class="page">
    <div class="page-header"><h1>Fulfillment Dashboard</h1><p>Track production and shipping status</p></div>
    <div class="stat-grid" id="ffStats"><div class="stat-card"><div class="spinner" style="width:20px;height:20px;border-width:2px"></div></div></div>
    <div class="tab-bar"><div class="tab active" onclick="setTab(this.parentElement,this)">Active</div><div class="tab" onclick="setTab(this.parentElement,this)">Completed</div></div>
    <div class="fulfillment-grid" id="ffCards"><div style="color:#9ca3af;font-size:13px">Loading...</div></div>
  </div>`;
  const{data:orders}=await sb.from('orders').select('*').in('status',['production','fulfillment','complete']).order('created_at',{ascending:false});
  const list=orders||[];
  document.getElementById('ffStats').innerHTML=`
    <div class="stat-card"><div class="stat-bar" style="background:#3b82f6"></div><div><div class="stat-num">${list.filter(o=>o.status==='production').length}</div><div class="stat-label">In Production</div></div></div>
    <div class="stat-card"><div class="stat-bar" style="background:#f59e0b"></div><div><div class="stat-num">${list.filter(o=>o.status==='fulfillment').length}</div><div class="stat-label">Ready to Ship</div></div></div>
    <div class="stat-card"><div class="stat-bar" style="background:#22c55e"></div><div><div class="stat-num">${list.filter(o=>o.status==='complete').length}</div><div class="stat-label">Complete</div></div></div>
    <div class="stat-card"><div class="stat-bar" style="background:#8b5cf6"></div><div><div class="stat-num">${list.length}</div><div class="stat-label">Total</div></div></div>`;
  if(!list.length){document.getElementById('ffCards').innerHTML=`<div style="color:#9ca3af;font-size:13px;padding:20px">No orders in fulfillment yet.</div>`;return;}
  document.getElementById('ffCards').innerHTML=list.map(o=>{
    const pill=o.status==='production'?'pill-production':o.status==='fulfillment'?'pill-ready':'pill-completed';
    return `<div class="design-card">
      <div class="design-card-header"><h3>${o.client_name}</h3><span class="status-pill ${pill}">${o.status}</span></div>
      <div class="design-card-sub">${o.event_name||o.organization||'‚Äî'}</div>
      <div class="design-meta">
        <div class="meta-item"><label>Product:</label><span>${o.garment_type||'‚Äî'}</span></div>
        <div class="meta-item"><label>Quantity:</label><span>${o.quantity||'‚Äî'} units</span></div>
        <div class="meta-item"><label>Fulfillment:</label><span>${o.fulfillment_type||'bulk'}</span></div>
        <div class="meta-item"><label>Order #:</label><span class="order-num">${o.order_number||'‚Äî'}</span></div>
      </div>
      ${o.is_rush?`<div class="special-box"><label>‚ö° Rush Order</label>Expedited shipping required</div>`:''}
      <div class="btn-row">
        <button class="btn-outline" onclick="updateOrderStatus('${o.id}','fulfillment')">üì¶ Mark Ready</button>
        <button class="btn-dark" onclick="updateOrderStatus('${o.id}','complete')">‚úì Complete</button>
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ STOREFRONT ‚îÄ‚îÄ
function renderStorefront(){
  document.getElementById('mainContent').innerHTML=`<div class="page">
    <div class="header-row"><div class="page-header" style="margin-bottom:0"><h1>Storefront Management</h1><p>Manage products, variants, and chapter assignments</p></div><button class="btn-sm-dark">+ New Product</button></div><br>
    <div class="stat-grid">
      <div class="stat-card"><div class="stat-bar" style="background:#3b82f6"></div><div><div class="stat-num">3</div><div class="stat-label">Total Products</div></div></div>
      <div class="stat-card"><div class="stat-bar" style="background:#22c55e"></div><div><div class="stat-num">2</div><div class="stat-label">Active</div></div></div>
      <div class="stat-card"><div class="stat-bar" style="background:#8b5cf6"></div><div><div class="stat-num">10</div><div class="stat-label">Variants</div></div></div>
      <div class="stat-card"><div class="stat-bar" style="background:#f59e0b"></div><div><div class="stat-num">8</div><div class="stat-label">Chapters</div></div></div>
    </div>
    <div class="tab-bar"><div class="tab active" onclick="setTab(this.parentElement,this)">All Products</div><div class="tab" onclick="setTab(this.parentElement,this)">Active</div><div class="tab" onclick="setTab(this.parentElement,this)">Inactive</div></div>
    <div class="product-grid">
      ${pCard('Classic Greek Letter T-Shirt','$18.50','Premium cotton tee with custom Greek letters.',['Alpha Phi','Kappa Delta','Pi Beta Phi'],'5 options','225 units',true)}
      ${pCard('Premium Hoodie','$42.00','Heavyweight hoodie with embroidered Greek letters.',['Sigma Chi','Delta Gamma'],'3 options','67 units',true)}
      ${pCard('Sorority Tank Top','$15.00','Lightweight tank perfect for recruitment.',['Alpha Phi'],'2 options','5 units',false)}
    </div>
  </div>`;
}

function pCard(name,price,desc,chapters,variants,stock,active){
  return `<div class="product-card">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:2px"><span style="font-size:15px;font-weight:600">${name}</span><div style="text-align:right"><span style="font-size:14px;font-weight:600">${price}</span><span style="display:block;font-size:10px;color:#9ca3af">Base Price</span></div></div>
    <div style="font-size:12px;color:#9ca3af;margin-bottom:10px">Apparel ${!active?'<span class="status-pill pill-inactive" style="font-size:10px">Inactive</span>':''}</div>
    <div style="font-size:12px;color:#6b7280;margin-bottom:12px;line-height:1.5">${desc}</div>
    <div class="mockup-thumb" style="margin-bottom:12px"><svg fill="none" viewBox="0 0 24 24" stroke="#d1d5db" stroke-width="1.5"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div><div style="font-size:11px;color:#9ca3af">Variants:</div><div style="font-size:13px;font-weight:500">${variants}</div></div>
      <div><div style="font-size:11px;color:#9ca3af">Total Stock:</div><div style="font-size:13px;font-weight:500">${stock}</div></div>
    </div>
    <div style="font-size:12px;color:#6b7280;margin-bottom:6px">üë• Assigned Chapters (${chapters.length})</div>
    <div class="chapter-tags">${chapters.map(c=>`<span class="chapter-tag">${c}</span>`).join('')}</div>
    <div class="btn-row" style="margin-top:14px"><button class="btn-outline">‚úèÔ∏è Edit</button><button class="${active?'btn-outline':'btn-dark'}">${active?'üö´ Deactivate':'üëÅ Activate'}</button></div>
  </div>`;
}

// ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ
async function renderAdminPanel(){
  document.getElementById('mainContent').innerHTML=`<div class="page">
    <div class="page-header"><h1>Admin Dashboard</h1><p>System oversight and management controls</p></div>
    <div class="quick-grid" style="grid-template-columns:repeat(auto-fill,minmax(180px,1fr))">
      <div class="quick-card"><div class="quick-icon" style="background:#fff0f0"><svg fill="none" viewBox="0 0 24 24" stroke="#dc2626" stroke-width="2"><path d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"/></svg></div><div class="quick-info"><strong>Flags</strong><span>Review exceptions</span></div></div>
      <div class="quick-card"><div class="quick-icon" style="background:#eff6ff"><svg fill="none" viewBox="0 0 24 24" stroke="#2563eb" stroke-width="2"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg></div><div class="quick-info"><strong>Employees</strong><span>Manage team</span></div></div>
      <div class="quick-card"><div class="quick-icon" style="background:#f5f3ff"><svg fill="none" viewBox="0 0 24 24" stroke="#7c3aed" stroke-width="2"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg></div><div class="quick-info"><strong>Rules</strong><span>Configure defaults</span></div></div>
      <div class="quick-card"><div class="quick-icon" style="background:#f0fdf4"><svg fill="none" viewBox="0 0 24 24" stroke="#16a34a" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg></div><div class="quick-info"><strong>Audit Log</strong><span>Track changes</span></div></div>
    </div>
    <div class="section-card" style="margin-bottom:16px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span>‚ö†Ô∏è</span><div class="section-title">Active Flags & Exceptions</div></div>
      <div class="section-sub">Items requiring admin attention</div>
      <div class="flag-grid" id="flagGrid"><div style="color:#9ca3af;font-size:13px">Loading...</div></div>
    </div>
    <div class="two-col">
      <div class="section-card"><div class="section-title">All Orders</div><div class="section-sub">Full order list</div><div id="allOrders"><div style="color:#9ca3af;font-size:13px">Loading...</div></div></div>
      <div class="section-card"><div class="section-title">Business Metrics</div><div class="section-sub">Key performance indicators</div><div id="metrics"><div style="color:#9ca3af;font-size:13px">Loading...</div></div></div>
    </div>
  </div>`;

  const{data:orders}=await sb.from('orders').select('*').order('created_at',{ascending:false});
  const list=orders||[];
  const rush=list.filter(o=>o.is_rush).length;

  document.getElementById('flagGrid').innerHTML=`
    <div class="flag-card"><div class="flag-bar" style="background:#dc2626"></div><div><div class="flag-num">${rush}</div><div class="flag-label">Rush Orders</div></div></div>
    <div class="flag-card"><div class="flag-bar" style="background:#f59e0b"></div><div><div class="flag-num">${list.filter(o=>o.status==='intake').length}</div><div class="flag-label">Pending Intake</div></div></div>
    <div class="flag-card"><div class="flag-bar" style="background:#eab308"></div><div><div class="flag-num">${list.filter(o=>o.status==='design').length}</div><div class="flag-label">In Design</div></div></div>
    <div class="flag-card"><div class="flag-bar" style="background:#22c55e"></div><div><div class="flag-num">${list.length}</div><div class="flag-label">Total Orders</div></div></div>`;

  document.getElementById('allOrders').innerHTML=list.length?list.slice(0,10).map(o=>`
    <div class="activity-item">
      <div class="activity-info"><strong>${o.client_name}</strong><span>${o.order_number||'‚Äî'} ¬∑ ${o.garment_type||'‚Äî'} ¬∑ Qty ${o.quantity||'‚Äî'}</span></div>
      <span class="status-pill pill-${o.status}">${o.status}</span>
    </div>`).join(''):'<div style="color:#9ca3af;font-size:13px">No orders yet.</div>';

  const revenue=list.reduce((s,o)=>s+(o.budget||0),0);
  const avgQty=list.length?Math.round(list.reduce((s,o)=>s+(o.quantity||0),0)/list.length):0;
  document.getElementById('metrics').innerHTML=`
    <div class="metric-card"><div><div class="metric-label">Total Orders</div><div class="metric-val">${list.length}</div></div><span>üìã</span></div>
    <div class="metric-card"><div><div class="metric-label">Est. Pipeline Value</div><div class="metric-val">$${revenue.toLocaleString()}</div><div style="font-size:11px;color:#6b7280">Based on client budgets</div></div><span>üíµ</span></div>
    <div class="metric-card"><div><div class="metric-label">Rush Orders</div><div class="metric-val">${rush}</div>${rush>0?'<div style="font-size:11px;color:#dc2626">Needs attention</div>':''}</div><span>‚ö°</span></div>
    <div class="metric-card"><div><div class="metric-label">Avg Order Size</div><div class="metric-val">${avgQty} units</div></div><span>üì¶</span></div>`;
}

// ‚îÄ‚îÄ TEAM MANAGEMENT ‚îÄ‚îÄ
async function renderTeam(){
  document.getElementById('mainContent').innerHTML=`<div class="page">
    <div class="header-row">
      <div class="page-header" style="margin-bottom:0"><h1>Team Management</h1><p>Invite and manage your team members</p></div>
      <button class="btn-sm-dark" onclick="showInviteModal()">+ Invite Member</button>
    </div><br>
    <div class="stat-grid" id="teamStats"><div class="stat-card"><div class="spinner" style="width:20px;height:20px;border-width:2px"></div></div></div>

    <!-- INVITE MODAL -->
    <div id="inviteModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:100;display:none;align-items:center;justify-content:center">
      <div style="background:#fff;border-radius:14px;padding:28px;width:100%;max-width:440px;margin:20px;box-shadow:0 20px 60px rgba(0,0,0,.2)">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <h2 style="font-size:17px;font-weight:700">Invite Team Member</h2>
          <button onclick="hideInviteModal()" style="background:none;border:none;cursor:pointer;font-size:20px;color:#9ca3af;line-height:1">√ó</button>
        </div>
        <div id="inviteMsg"></div>
        <div class="form-group"><label>Full Name</label><input class="form-input" id="inv_name" placeholder="e.g. Sarah Johnson"></div>
        <div class="form-group"><label>Email Address</label><input class="form-input" id="inv_email" type="email" placeholder="sarah@sturtee.com"></div>
        <div class="form-group"><label>Temporary Password</label>
          <div style="position:relative">
            <input class="form-input" id="inv_pass" type="text" placeholder="They'll change this on first login" style="padding-right:90px">
            <button onclick="genPass()" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:#f3f4f6;border:none;border-radius:5px;padding:4px 8px;font-size:11px;cursor:pointer;font-family:inherit;color:#374151">Generate</button>
          </div>
        </div>
        <div class="form-group"><label>Role</label>
          <select class="form-select" id="inv_role">
            <option value="admin">Admin</option>
            <option value="sales_rep">Sales Rep</option>
            <option value="designer">Designer</option>
            <option value="fulfillment">Fulfillment</option>
            <option value="super_admin">Super Admin</option>
          </select>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:4px">
          <button class="btn-outline" onclick="hideInviteModal()">Cancel</button>
          <button class="btn-dark" id="inviteBtn" onclick="createTeamMember()">Create Account</button>
        </div>
        <div style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;padding:10px 12px;margin-top:14px;font-size:12px;color:#0369a1">
          üí° Share the email + temp password with the team member. They can sign in immediately and update their password in their account settings.
        </div>
      </div>
    </div>

    <div class="section-card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div><div class="section-title">All Team Members</div><div class="section-sub" style="margin-bottom:0">Manage roles and access levels</div></div>
        <div class="tab-bar" style="margin-bottom:0">
          <div class="tab active" onclick="setTab(this.parentElement,this);filterTeam('all')">All</div>
          <div class="tab" onclick="setTab(this.parentElement,this);filterTeam('admin')">Admins</div>
          <div class="tab" onclick="setTab(this.parentElement,this);filterTeam('sales_rep')">Sales</div>
          <div class="tab" onclick="setTab(this.parentElement,this);filterTeam('designer')">Design</div>
          <div class="tab" onclick="setTab(this.parentElement,this);filterTeam('fulfillment')">Fulfillment</div>
        </div>
      </div>
      <div id="teamList"><div style="text-align:center;padding:30px;color:#9ca3af;font-size:13px">Loading team...</div></div>
    </div>
  </div>`;

  await loadTeam();
}

async function loadTeam(){
  const{data:members}=await sb.from('users').select('*').order('created_at',{ascending:true});
  window._teamMembers=members||[];

  // Stats
  const m=window._teamMembers;
  document.getElementById('teamStats').innerHTML=`
    <div class="stat-card"><div class="stat-bar" style="background:#0f75bc"></div><div><div class="stat-num">${m.length}</div><div class="stat-label">Total Members</div></div></div>
    <div class="stat-card"><div class="stat-bar" style="background:#dc2626"></div><div><div class="stat-num">${m.filter(x=>x.role==='admin'||x.role==='super_admin').length}</div><div class="stat-label">Admins</div></div></div>
    <div class="stat-card"><div class="stat-bar" style="background:#2563eb"></div><div><div class="stat-num">${m.filter(x=>x.role==='sales_rep').length}</div><div class="stat-label">Sales Reps</div></div></div>
    <div class="stat-card"><div class="stat-bar" style="background:#7c3aed"></div><div><div class="stat-num">${m.filter(x=>x.role==='designer').length}</div><div class="stat-label">Designers</div></div></div>`;

  renderTeamList(window._teamMembers);
}

function filterTeam(role){
  const m=window._teamMembers||[];
  renderTeamList(role==='all'?m:m.filter(x=>x.role===role));
}

function renderTeamList(members){
  const el=document.getElementById('teamList');
  if(!members.length){el.innerHTML=`<div style="text-align:center;padding:30px;color:#9ca3af;font-size:13px">No team members found.</div>`;return;}

  const roleColors={super_admin:'badge-super_admin',admin:'badge-admin',sales_rep:'badge-sales_rep',designer:'badge-designer',fulfillment:'badge-fulfillment'};
  const roleLabels={super_admin:'Super Admin',admin:'Admin',sales_rep:'Sales Rep',designer:'Designer',fulfillment:'Fulfillment'};

  el.innerHTML=`<table style="width:100%;border-collapse:collapse">
    <thead><tr style="border-bottom:1px solid #f3f4f6">
      <th style="text-align:left;padding:8px 12px;font-size:11px;color:#9ca3af;font-weight:600;text-transform:uppercase;letter-spacing:.05em">Member</th>
      <th style="text-align:left;padding:8px 12px;font-size:11px;color:#9ca3af;font-weight:600;text-transform:uppercase;letter-spacing:.05em">Email</th>
      <th style="text-align:left;padding:8px 12px;font-size:11px;color:#9ca3af;font-weight:600;text-transform:uppercase;letter-spacing:.05em">Role</th>
      <th style="text-align:left;padding:8px 12px;font-size:11px;color:#9ca3af;font-weight:600;text-transform:uppercase;letter-spacing:.05em">Joined</th>
      <th style="text-align:left;padding:8px 12px;font-size:11px;color:#9ca3af;font-weight:600;text-transform:uppercase;letter-spacing:.05em">Actions</th>
    </tr></thead>
    <tbody>${members.map(m=>`
    <tr style="border-bottom:1px solid #f9fafb" onmouseover="this.style.background='#fafafa'" onmouseout="this.style.background=''">
      <td style="padding:12px">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:34px;height:34px;border-radius:50%;background:#e5e7eb;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:13px;color:#6b7280;flex-shrink:0">${(m.full_name||m.email).charAt(0).toUpperCase()}</div>
          <div><div style="font-size:13px;font-weight:500">${m.full_name||'‚Äî'}</div>${m.id===currentUser.id?'<div style="font-size:11px;color:#9ca3af">You</div>':''}</div>
        </div>
      </td>
      <td style="padding:12px;font-size:13px;color:#6b7280">${m.email}</td>
      <td style="padding:12px">
        <select onchange="updateRole('${m.id}',this.value)" style="font-size:12px;padding:4px 8px;border:1px solid #e5e7eb;border-radius:6px;background:#f9fafb;font-family:inherit;color:#374151;cursor:pointer" ${m.id===currentUser.id?'disabled':''}>
          <option value="sales_rep" ${m.role==='sales_rep'?'selected':''}>Sales Rep</option>
          <option value="designer" ${m.role==='designer'?'selected':''}>Designer</option>
          <option value="fulfillment" ${m.role==='fulfillment'?'selected':''}>Fulfillment</option>
          <option value="admin" ${m.role==='admin'?'selected':''}>Admin</option>
          <option value="super_admin" ${m.role==='super_admin'?'selected':''}>Super Admin</option>
        </select>
      </td>
      <td style="padding:12px;font-size:12px;color:#9ca3af">${m.created_at?new Date(m.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'‚Äî'}</td>
      <td style="padding:12px">
        ${m.id!==currentUser.id?`<button onclick="removeMember('${m.id}','${m.full_name||m.email}')" style="font-size:12px;padding:5px 10px;border:1px solid #fecaca;border-radius:6px;background:#fff;color:#dc2626;cursor:pointer;font-family:inherit">Remove</button>`:'<span style="font-size:12px;color:#d1d5db">‚Äî</span>'}
      </td>
    </tr>`).join('')}
    </tbody>
  </table>`;
}

function showInviteModal(){
  const m=document.getElementById('inviteModal');
  m.style.display='flex';
  genPass();
}
function hideInviteModal(){
  document.getElementById('inviteModal').style.display='none';
  document.getElementById('inviteMsg').innerHTML='';
  document.getElementById('inv_name').value='';
  document.getElementById('inv_email').value='';
}

function genPass(){
  const chars='ABCDEFGHJKMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789!@#$';
  let p='';
  for(let i=0;i<12;i++)p+=chars[Math.floor(Math.random()*chars.length)];
  document.getElementById('inv_pass').value=p;
}

async function createTeamMember(){
  const name=document.getElementById('inv_name').value.trim();
  const email=document.getElementById('inv_email').value.trim();
  const pass=document.getElementById('inv_pass').value.trim();
  const role=document.getElementById('inv_role').value;
  const msg=document.getElementById('inviteMsg');
  const btn=document.getElementById('inviteBtn');

  if(!name||!email||!pass){
    msg.innerHTML=`<div class="error-msg" style="display:block">Please fill in all fields.</div>`;return;
  }

  btn.disabled=true;btn.textContent='Creating...';

  // Use Supabase admin signup via anon key (creates unconfirmed user)
  const{data,error}=await sb.auth.signUp({
    email,
    password:pass,
    options:{data:{full_name:name}}
  });

  if(error){
    msg.innerHTML=`<div class="error-msg" style="display:block">${error.message}</div>`;
    btn.disabled=false;btn.textContent='Create Account';return;
  }

  // If user was created, insert profile with correct role
  if(data.user){
    await sb.from('users').upsert({
      id:data.user.id,
      email,
      full_name:name,
      role
    });
  }

  btn.disabled=false;btn.textContent='Create Account';
  msg.innerHTML=`<div class="success-msg" style="display:block">‚úÖ Account created! Share these credentials:<br><strong>${email}</strong> / <strong>${pass}</strong></div>`;

  // Refresh team list after short delay
  setTimeout(()=>loadTeam(),1000);
}

async function updateRole(userId,newRole){
  const{error}=await sb.from('users').update({role:newRole}).eq('id',userId);
  if(error){alert('Error updating role: '+error.message);}
}

async function removeMember(userId,name){
  if(!confirm(`Remove ${name} from the team? This cannot be undone.`))return;
  const{error}=await sb.from('users').delete().eq('id',userId);
  if(error){alert('Error: '+error.message);return;}
  loadTeam();
}

boot();
</script>
</body>
</html>
