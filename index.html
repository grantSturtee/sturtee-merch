<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sturtee Merch Portal</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:#f1f3f5;color:#111827;font-size:14px}
.app{display:flex;height:100vh;overflow:hidden}
.sidebar{width:230px;flex-shrink:0;background:#fff;border-right:1px solid #e5e7eb;display:flex;flex-direction:column;overflow-y:auto}
.main-content{flex:1;overflow-y:auto;padding:32px 36px}
.top-bar{background:#f8f9fa;border-bottom:1px solid #dee2e6;padding:8px 20px;font-size:12px;color:#9ca3af}
.sidebar-brand{padding:20px 20px 12px;border-bottom:1px solid #f3f4f6}
.sidebar-brand h2{font-size:16px;font-weight:700;color:#111827}
.sidebar-brand p{font-size:11px;color:#9ca3af;margin-top:2px}
.sidebar-user{padding:14px 16px;border-bottom:1px solid #f3f4f6;display:flex;align-items:center;gap:10px}
.avatar{width:32px;height:32px;border-radius:50%;background:#0f75bc;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;color:#fff;flex-shrink:0}
.user-name{font-size:13px;font-weight:600;color:#111827}
.role-badge{display:inline-block;font-size:10px;font-weight:600;padding:2px 7px;border-radius:4px;margin-top:3px;text-transform:lowercase}
.badge-admin{background:#fee2e2;color:#dc2626}
.badge-sales_rep{background:#dbeafe;color:#2563eb}
.badge-designer{background:#ede9fe;color:#7c3aed}
.badge-fulfillment{background:#dcfce7;color:#16a34a}
.badge-super_admin{background:#0f75bc;color:#fff}
.nav{padding:12px 0;flex:1}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 20px;font-size:13px;color:#4b5563;cursor:pointer;transition:background .15s}
.nav-item:hover{background:#f0f8ff;color:#0f75bc}
.nav-item.active{background:#e8f4fd;color:#0f75bc;font-weight:600}
.nav-item svg{width:16px;height:16px;flex-shrink:0;opacity:.7}
.nav-item.active svg{opacity:1}
.sidebar-footer{padding:12px 0;border-top:1px solid #f3f4f6}
.sign-out{display:flex;align-items:center;gap:10px;padding:9px 20px;font-size:13px;color:#6b7280;cursor:pointer}
.sign-out:hover{color:#dc2626}
.login-page{min-height:100vh;background:#f1f3f5;display:flex;flex-direction:column}
.login-wrap{flex:1;display:flex;align-items:center;justify-content:center;padding:40px 20px}
.login-inner{width:100%;max-width:400px}
.login-logo{display:flex;flex-direction:column;align-items:center;margin-bottom:24px}
.logo-icon{width:52px;height:52px;background:#0f75bc;border-radius:14px;display:flex;align-items:center;justify-content:center;margin-bottom:14px}
.login-inner h1{font-size:22px;font-weight:700;text-align:center;color:#111827}
.login-sub{font-size:13px;color:#6b7280;text-align:center;margin-top:4px}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:24px;margin-bottom:16px}
.card h3{font-size:16px;font-weight:600;margin-bottom:4px;color:#111827}
.card-sub{font-size:12px;color:#6b7280;margin-bottom:20px}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:13px;font-weight:500;margin-bottom:6px;color:#374151}
.form-input{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px;font-family:inherit;background:#f9fafb;color:#111827;outline:none;transition:border .15s}
.form-input:focus{border-color:#0f75bc;background:#fff}
.form-select{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px;font-family:inherit;background:#f9fafb;color:#111827;outline:none}
.form-textarea{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;font-size:13px;font-family:inherit;background:#f9fafb;color:#111827;outline:none;resize:vertical;min-height:80px}
.btn-primary{width:100%;padding:11px;background:#0f75bc;color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit}
.btn-primary:hover{background:#0d69a8}
.btn-primary:disabled{background:#9ca3af;cursor:not-allowed}
.login-footer{text-align:center;font-size:11px;color:#9ca3af;padding:16px}
.err{background:#fee2e2;color:#dc2626;border-radius:8px;padding:10px 14px;font-size:13px;margin-bottom:14px;display:none}
.loading-screen{display:flex;align-items:center;justify-content:center;height:100vh;background:#f1f3f5;flex-direction:column;gap:12px}
.spinner{width:32px;height:32px;border:3px solid #e5e7eb;border-top-color:#0f75bc;border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.page-header{margin-bottom:28px}
.page-header h1{font-size:22px;font-weight:700;color:#111827}
.page-header p{font-size:13px;color:#6b7280;margin-top:3px}
.header-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:28px}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:18px 20px;display:flex;align-items:flex-start;gap:14px}
.stat-bar{width:4px;height:40px;border-radius:2px;flex-shrink:0;margin-top:2px}
.stat-num{font-size:28px;font-weight:700;line-height:1;color:#111827}
.stat-label{font-size:12px;color:#6b7280;margin-top:4px}
.quick-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:24px}
.quick-card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:16px 18px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:border-color .15s,box-shadow .15s}
.quick-card:hover{border-color:#0f75bc;box-shadow:0 2px 8px rgba(15,117,188,.1)}
.quick-icon{width:36px;height:36px;border-radius:8px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.quick-icon svg{width:18px;height:18px}
.quick-info strong{font-size:14px;font-weight:600;display:block;color:#111827}
.quick-info span{font-size:12px;color:#9ca3af}
.section-card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:20px 24px;margin-bottom:16px}
.section-title{font-size:15px;font-weight:600;margin-bottom:4px;color:#111827}
.section-sub{font-size:12px;color:#6b7280;margin-bottom:16px}
.activity-item{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid #f3f4f6;cursor:pointer}
.activity-item:last-child{border-bottom:none}
.activity-item:hover{background:#fafafa;margin:0 -8px;padding:12px 8px;border-radius:6px}
.activity-info{flex:1}
.activity-info strong{font-size:13px;font-weight:500;color:#111827}
.activity-info span{font-size:11px;color:#9ca3af;display:block;margin-top:1px}
.pill{font-size:11px;font-weight:500;padding:3px 10px;border-radius:6px;border:1px solid #e5e7eb;white-space:nowrap;display:inline-block}
.pill-intake{border-color:#e5e7eb;color:#6b7280;background:#fff}
.pill-quote{background:#ede9fe;color:#7c3aed;border-color:#ddd6fe}
.pill-design{background:#dbeafe;color:#2563eb;border-color:#bfdbfe}
.pill-production{background:#fef3c7;color:#d97706;border-color:#fde68a}
.pill-fulfillment{background:#fed7aa;color:#c2410c;border-color:#fdba74}
.pill-complete{background:#dcfce7;color:#16a34a;border-color:#bbf7d0}
.pill-cancelled{background:#f3f4f6;color:#6b7280;border-color:#e5e7eb}
.pill-rush{background:#fee2e2;color:#dc2626;border-color:#fecaca;font-size:10px}
.tab-bar{display:flex;background:#f3f4f6;border-radius:8px;padding:3px;margin-bottom:20px;width:fit-content}
.tab{padding:7px 16px;border-radius:6px;font-size:13px;cursor:pointer;color:#6b7280;transition:all .15s;white-space:nowrap}
.tab.active{background:#fff;color:#0f75bc;font-weight:600;box-shadow:0 1px 3px rgba(0,0,0,.1)}
.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px}
.order-card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:20px}
.order-card:hover{box-shadow:0 2px 12px rgba(0,0,0,.08)}
.card-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:4px}
.card-header h3{font-size:15px;font-weight:600;color:#111827}
.card-sub{font-size:12px;color:#6b7280;margin-bottom:14px}
.card-meta{display:grid;grid-template-columns:1fr 1fr;gap:8px 20px;margin-bottom:14px}
.meta-row label{font-size:11px;color:#9ca3af;display:block;margin-bottom:1px}
.meta-row span{font-size:13px;font-weight:500;color:#111827}
.notes-box{background:#f9fafb;border-radius:6px;padding:10px 12px;font-size:12px;color:#6b7280;margin-bottom:14px;line-height:1.5}
.notes-box label{display:block;font-size:11px;color:#9ca3af;margin-bottom:3px;font-weight:600}
.btn-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.btn{padding:9px 16px;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;font-family:inherit;border:none;transition:background .15s;display:inline-flex;align-items:center;justify-content:center;gap:6px}
.btn-blue{background:#0f75bc;color:#fff}.btn-blue:hover{background:#0d69a8}
.btn-ghost{background:#fff;color:#111827;border:1px solid #e5e7eb}.btn-ghost:hover{background:#f9fafb}
.btn-red{background:#fee2e2;color:#dc2626;border:1px solid #fecaca}
.btn-green{background:#dcfce7;color:#16a34a;border:1px solid #bbf7d0}
.btn-full{width:100%}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-sm-blue{padding:8px 16px;background:#0f75bc;color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;font-family:inherit}
.form-card{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:28px;max-width:680px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.form-section{margin-bottom:24px}
.form-section-title{font-size:13px;font-weight:600;margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid #f3f4f6;color:#111827}
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:200;align-items:center;justify-content:center}
.modal-bg.open{display:flex}
.modal{background:#fff;border-radius:14px;padding:28px;width:100%;max-width:480px;margin:20px;box-shadow:0 20px 60px rgba(0,0,0,.2);max-height:90vh;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal-header h2{font-size:17px;font-weight:700;color:#111827}
.modal-close{background:none;border:none;cursor:pointer;font-size:22px;color:#9ca3af;line-height:1}
.empty{text-align:center;padding:48px 20px;color:#9ca3af}
.empty p{font-size:14px;margin-bottom:16px}
.order-num{font-family:monospace;font-size:11px;color:#9ca3af}
.flag-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:12px;margin-bottom:20px}
.flag-card{background:#fff;border:1px solid #fecaca;border-radius:10px;padding:16px 18px;display:flex;align-items:flex-start;gap:12px}
.flag-bar{width:4px;height:36px;border-radius:2px;flex-shrink:0}
.flag-num{font-size:24px;font-weight:700;line-height:1;color:#111827}
.flag-label{font-size:12px;color:#6b7280;margin-top:3px}
.metric-card{background:#f9fafb;border-radius:8px;padding:14px 16px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
.metric-val{font-size:22px;font-weight:700;color:#111827}
.metric-label{font-size:12px;color:#6b7280}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.team-table{width:100%;border-collapse:collapse}
.team-table th{text-align:left;padding:8px 14px;font-size:11px;color:#9ca3af;font-weight:600;text-transform:uppercase;letter-spacing:.05em;border-bottom:1px solid #f3f4f6}
.team-table td{padding:13px 14px;border-bottom:1px solid #f9fafb;font-size:13px;color:#374151}
.team-table tr:hover td{background:#fafafa}
.info-box{background:#f0f8ff;border:1px solid #bae6fd;border-radius:8px;padding:12px 14px;font-size:12px;color:#0369a1;margin-top:14px;line-height:1.5}
.flow-bar{display:flex;align-items:center;margin-bottom:20px;overflow-x:auto;padding-bottom:4px}
.flow-node{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:500;white-space:nowrap;border:1.5px solid #e5e7eb;color:#9ca3af;background:#fff}
.flow-node.done{background:#dcfce7;border-color:#bbf7d0;color:#16a34a}
.flow-node.current{background:#0f75bc;border-color:#0f75bc;color:#fff}
.flow-arrow{width:20px;height:2px;background:#e5e7eb;flex-shrink:0}
.flow-arrow.done{background:#bbf7d0}
.page{animation:fadeUp .18s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}
@media(max-width:700px){.two-col,.form-row{grid-template-columns:1fr}.sidebar{width:200px}.main-content{padding:20px 16px}.card-grid{grid-template-columns:1fr}}
</style>
</head>
<body>

<div id="loadingScreen" class="loading-screen">
  <div class="spinner"></div>
  <div style="font-size:13px;color:#9ca3af;margin-top:4px">Loading Sturtee...</div>
</div>

<div id="loginPage" class="login-page" style="display:none">
  <div class="login-wrap">
    <div class="login-inner">
      <div class="login-logo">
        <div class="logo-icon">
          <svg width="26" height="26" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
        </div>
        <h1>Sturtee Merch Portal</h1>
        <p class="login-sub">Sign in to access the workflow system</p>
      </div>
      <div class="card">
        <h3>Sign In</h3>
        <p class="card-sub">Enter your credentials to continue</p>
        <div id="loginErr" class="err"></div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" class="form-input" id="loginEmail" placeholder="you@sturtee.com" onkeydown="if(event.key==='Enter')doLogin()">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" class="form-input" id="loginPass" placeholder="Enter password" onkeydown="if(event.key==='Enter')doLogin()">
        </div>
        <button class="btn-primary" id="loginBtn" onclick="doLogin()">Sign In</button>
      </div>
      <div class="login-footer">Sturtee Merch Portal v1.0</div>
    </div>
  </div>
</div>

<div id="appShell" class="app" style="display:none">
  <div class="sidebar">
    <div class="sidebar-brand"><h2>Sturtee Merch</h2><p>Workflow Portal</p></div>
    <div class="sidebar-user">
      <div class="avatar" id="sbAvatar">?</div>
      <div style="flex:1;min-width:0">
        <div class="user-name" id="sbName">...</div>
        <span class="role-badge" id="sbBadge">...</span>
      </div>
    </div>
    <nav class="nav" id="sbNav"></nav>
    <div class="sidebar-footer">
      <div class="sign-out" onclick="doSignOut()">
        <svg width="15" height="15" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
        Sign Out
      </div>
    </div>
  </div>
  <div style="flex:1;display:flex;flex-direction:column;overflow:hidden">
    <div class="top-bar">Sturtee Merchandise Workflow System</div>
    <div class="main-content" id="mainContent"></div>
  </div>
</div>

<!-- ORDER DETAIL MODAL -->
<div class="modal-bg" id="orderModal">
  <div class="modal" style="max-width:560px">
    <div class="modal-header">
      <h2 id="omTitle">Order Details</h2>
      <button class="modal-close" onclick="closeOrderModal()">&#215;</button>
    </div>
    <div id="omFlowBar"></div>
    <div id="omBody"></div>
    <div id="omActions" style="margin-top:16px"></div>
  </div>
</div>

<!-- INVITE MODAL -->
<div class="modal-bg" id="inviteModal">
  <div class="modal">
    <div class="modal-header">
      <h2>Invite Team Member</h2>
      <button class="modal-close" onclick="closeInvite()">&#215;</button>
    </div>
    <div id="invMsg"></div>
    <div class="form-group"><label>Full Name</label><input class="form-input" id="inv_name" placeholder="e.g. Sarah Johnson"></div>
    <div class="form-group"><label>Email Address</label><input class="form-input" id="inv_email" type="email" placeholder="sarah@sturtee.com"></div>
    <div class="form-group"><label>Temporary Password</label>
      <div style="position:relative">
        <input class="form-input" id="inv_pass" type="text" style="padding-right:90px">
        <button onclick="genPass()" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:#f3f4f6;border:none;border-radius:5px;padding:4px 10px;font-size:11px;cursor:pointer;font-family:inherit">Generate</button>
      </div>
    </div>
    <div class="form-group"><label>Role</label>
      <select class="form-select" id="inv_role">
        <option value="sales_rep">Sales Rep</option>
        <option value="designer">Designer</option>
        <option value="fulfillment">Fulfillment</option>
        <option value="admin">Admin</option>
        <option value="super_admin">Super Admin</option>
      </select>
    </div>
    <div class="btn-row">
      <button class="btn btn-ghost btn-full" onclick="closeInvite()">Cancel</button>
      <button class="btn btn-blue btn-full" id="invBtn" onclick="createMember()">Create Account</button>
    </div>
    <div class="info-box">After creating the account, share the email and temporary password with your team member. They can sign in right away.</div>
  </div>
</div>

<script>
var sb = supabase.createClient(
  'https://xtgtihetywvytwqiyriw.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh0Z3RpaGV0eXd2eXR3cWl5cml3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NDUyMDIsImV4cCI6MjA4NzAyMTIwMn0.YPRcqWz7uFR-WybGnK6HcZ_v-EYCeedDgLJB4_4iQUU'
);

var CU = null, CP = null, PAGE = 'dashboard';

var NAV_ROLES = {
  super_admin: ['dashboard','quote-request','design-queue','approvals','fulfillment','storefront','admin','team'],
  admin:       ['dashboard','quote-request','design-queue','approvals','fulfillment','storefront','admin','team'],
  sales_rep:   ['dashboard','quote-request','approvals','storefront'],
  designer:    ['dashboard','design-queue','approvals'],
  fulfillment: ['dashboard','fulfillment']
};

var NAV_LABELS = {
  'dashboard':'Dashboard','quote-request':'New Quote','design-queue':'Design Queue',
  'approvals':'Approvals','fulfillment':'Fulfillment','storefront':'Storefront',
  'admin':'Admin','team':'Team'
};

var STATUS_LABELS = {
  intake:'Intake', quote:'Quoted', design:'Design',
  production:'Production', fulfillment:'Fulfillment',
  complete:'Complete', cancelled:'Cancelled'
};
var STATUS_FLOW = ['intake','quote','design','production','fulfillment','complete'];

// ── BOOT ──
async function boot() {
  var res = await sb.auth.getSession();
  if (res.data.session) {
    await loadProfile(res.data.session.user);
  } else {
    showLogin();
  }
}

async function loadProfile(user) {
  CU = user;
  var res = await sb.from('users').select('*').eq('id', user.id).single();
  if (!res.data) {
    var ins = await sb.from('users').insert({
      id: user.id,
      email: user.email,
      full_name: (user.user_metadata && user.user_metadata.full_name) ? user.user_metadata.full_name : user.email.split('@')[0],
      role: 'admin'
    }).select().single();
    CP = ins.data;
  } else {
    CP = res.data;
  }
  showApp();
}

function showLogin() {
  document.getElementById('loadingScreen').style.display = 'none';
  document.getElementById('loginPage').style.display = 'flex';
  document.getElementById('appShell').style.display = 'none';
}

function showApp() {
  document.getElementById('loadingScreen').style.display = 'none';
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('appShell').style.display = 'flex';
  var name = (CP && CP.full_name) ? CP.full_name : CU.email;
  var role = (CP && CP.role) ? CP.role : 'admin';
  document.getElementById('sbAvatar').textContent = name.charAt(0).toUpperCase();
  document.getElementById('sbName').textContent = name;
  var badge = document.getElementById('sbBadge');
  badge.textContent = role.replace('_', ' ');
  badge.className = 'role-badge badge-' + role;
  buildNav(role);
  go('dashboard');
}

async function doLogin() {
  var email = document.getElementById('loginEmail').value.trim();
  var pass = document.getElementById('loginPass').value;
  var errEl = document.getElementById('loginErr');
  if (!email || !pass) { errEl.textContent = 'Please enter your email and password'; errEl.style.display = 'block'; return; }
  var btn = document.getElementById('loginBtn');
  btn.disabled = true; btn.textContent = 'Signing in...';
  var res = await sb.auth.signInWithPassword({ email: email, password: pass });
  btn.disabled = false; btn.textContent = 'Sign In';
  if (res.error) { errEl.textContent = res.error.message; errEl.style.display = 'block'; return; }
  errEl.style.display = 'none';
  await loadProfile(res.data.user);
}

async function doSignOut() {
  await sb.auth.signOut();
  CU = null; CP = null;
  showLogin();
}

// ── NAV ──
function buildNav(role) {
  var pages = NAV_ROLES[role] || ['dashboard'];
  var html = '';
  for (var i = 0; i < pages.length; i++) {
    var p = pages[i];
    html += '<div class="nav-item" id="nav-' + p + '" onclick="go(\'' + p + '\')">' + NAV_LABELS[p] + '</div>';
  }
  document.getElementById('sbNav').innerHTML = html;
}

function go(page) {
  PAGE = page;
  var items = document.querySelectorAll('.nav-item');
  for (var i = 0; i < items.length; i++) items[i].classList.remove('active');
  var el = document.getElementById('nav-' + page);
  if (el) el.classList.add('active');
  var renders = {
    dashboard: pgDashboard,
    'quote-request': pgQuote,
    'design-queue': pgDesignQueue,
    approvals: pgApprovals,
    fulfillment: pgFulfillment,
    storefront: pgStorefront,
    admin: pgAdmin,
    team: pgTeam
  };
  (renders[page] || pgDashboard)();
}

function setTab(container, el, fn) {
  var tabs = container.querySelectorAll('.tab');
  for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
  el.classList.add('active');
  if (fn) fn();
}

// ── HELPERS ──
function gv(id) { return (document.getElementById(id) ? document.getElementById(id).value.trim() : ''); }
function el(id) { return document.getElementById(id); }
function html(id, content) { document.getElementById(id).innerHTML = content; }

function timeAgo(d) {
  var diff = Date.now() - new Date(d).getTime();
  var m = Math.floor(diff / 60000);
  if (m < 1) return 'just now';
  if (m < 60) return m + 'm ago';
  var h = Math.floor(m / 60);
  if (h < 24) return h + 'h ago';
  return Math.floor(h / 24) + 'd ago';
}

function fmtDate(d) {
  if (!d) return '—';
  return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function pill(status) {
  var label = STATUS_LABELS[status] || status;
  return '<span class="pill pill-' + status + '">' + label + '</span>';
}

function buildFlowBar(currentStatus) {
  var ci = STATUS_FLOW.indexOf(currentStatus);
  var html = '<div class="flow-bar">';
  for (var i = 0; i < STATUS_FLOW.length; i++) {
    var s = STATUS_FLOW[i];
    var cls = i < ci ? 'done' : (i === ci ? 'current' : '');
    html += '<div class="flow-node ' + cls + '">' + STATUS_LABELS[s] + '</div>';
    if (i < STATUS_FLOW.length - 1) {
      html += '<div class="flow-arrow ' + (i < ci ? 'done' : '') + '"></div>';
    }
  }
  html += '</div>';
  return html;
}

function emptyHTML(msg, btnLabel, btnFn) {
  var btn = btnLabel ? '<button class="btn btn-blue" onclick="' + btnFn + '">' + btnLabel + '</button>' : '';
  return '<div class="empty"><p>' + msg + '</p>' + btn + '</div>';
}

async function updateStatus(id, status) {
  var res = await sb.from('orders').update({ status: status, updated_at: new Date().toISOString() }).eq('id', id);
  if (res.error) { alert('Error: ' + res.error.message); return false; }
  return true;
}

// ── ORDER MODAL ──
async function openOrder(id) {
  var res = await sb.from('orders').select('*').eq('id', id).single();
  var o = res.data;
  if (!o) return;
  var role = CP ? CP.role : '';
  var canAdvance = (role === 'admin' || role === 'super_admin' || role === 'fulfillment');
  var nextMap = { intake:'quote', quote:'design', design:'production', production:'fulfillment', fulfillment:'complete' };
  var next = nextMap[o.status];

  el('omTitle').textContent = o.client_name + (o.event_name ? ' – ' + o.event_name : '');
  el('omFlowBar').innerHTML = buildFlowBar(o.status);

  var body = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px 24px;margin-bottom:16px">';
  body += '<div><div style="font-size:11px;color:#9ca3af;margin-bottom:2px">Order #</div><div style="font-family:monospace;font-size:13px">' + (o.order_number || '—') + '</div></div>';
  body += '<div><div style="font-size:11px;color:#9ca3af;margin-bottom:2px">Status</div>' + pill(o.status) + '</div>';
  body += '<div><div style="font-size:11px;color:#9ca3af;margin-bottom:2px">Garment</div><div style="font-size:13px;font-weight:500">' + (o.garment_type || '—') + '</div></div>';
  body += '<div><div style="font-size:11px;color:#9ca3af;margin-bottom:2px">Print Method</div><div style="font-size:13px;font-weight:500">' + (o.print_method || '—') + '</div></div>';
  body += '<div><div style="font-size:11px;color:#9ca3af;margin-bottom:2px">Quantity</div><div style="font-size:13px;font-weight:500">' + (o.quantity || '—') + ' units</div></div>';
  body += '<div><div style="font-size:11px;color:#9ca3af;margin-bottom:2px">Budget</div><div style="font-size:13px;font-weight:500">' + (o.budget ? '$' + o.budget.toLocaleString() : '—') + '</div></div>';
  body += '<div><div style="font-size:11px;color:#9ca3af;margin-bottom:2px">Due Date</div><div style="font-size:13px;font-weight:500">' + fmtDate(o.timeline_date) + '</div></div>';
  body += '<div><div style="font-size:11px;color:#9ca3af;margin-bottom:2px">Fulfillment</div><div style="font-size:13px;font-weight:500">' + (o.fulfillment_type || 'bulk') + '</div></div>';
  body += '<div><div style="font-size:11px;color:#9ca3af;margin-bottom:2px">Organization</div><div style="font-size:13px;font-weight:500">' + (o.organization || '—') + '</div></div>';
  body += '<div><div style="font-size:11px;color:#9ca3af;margin-bottom:2px">Rush</div><div style="font-size:13px;font-weight:500">' + (o.is_rush ? 'Yes ⚡' : 'No') + '</div></div>';
  body += '</div>';
  if (o.design_notes) {
    body += '<div class="notes-box"><label>Design Brief</label>' + o.design_notes + '</div>';
  }
  body += '<div style="font-size:11px;color:#9ca3af">Created ' + fmtDate(o.created_at) + '</div>';
  el('omBody').innerHTML = body;

  var actions = '';
  if (canAdvance && next) {
    actions = '<div class="btn-row">' +
      '<button class="btn btn-ghost btn-full" onclick="cancelOrder(\'' + o.id + '\')">Cancel Order</button>' +
      '<button class="btn btn-blue btn-full" onclick="advanceOrder(\'' + o.id + '\',\'' + next + '\')">Move to ' + STATUS_LABELS[next] + ' &rarr;</button>' +
      '</div>';
  } else if (o.status === 'complete') {
    actions = '<div style="text-align:center;padding:12px;color:#16a34a;font-weight:600">Order Complete</div>';
  }
  el('omActions').innerHTML = actions;
  el('orderModal').classList.add('open');
}

function closeOrderModal() {
  el('orderModal').classList.remove('open');
}

async function advanceOrder(id, status) {
  var ok = await updateStatus(id, status);
  if (ok) { closeOrderModal(); go(PAGE); }
}

async function cancelOrder(id) {
  if (!confirm('Cancel this order?')) return;
  var ok = await updateStatus(id, 'cancelled');
  if (ok) { closeOrderModal(); go(PAGE); }
}

// ── DASHBOARD ──
async function pgDashboard() {
  el('mainContent').innerHTML = '<div class="page">' +
    '<div class="page-header"><h1>Dashboard</h1><p>Live overview of all orders in the pipeline</p></div>' +
    '<div class="stat-grid" id="dStats"><div class="stat-card"><div class="spinner" style="width:20px;height:20px;border-width:2px"></div></div></div>' +
    '<div class="quick-grid">' +
      '<div class="quick-card" onclick="go(\'quote-request\')"><div class="quick-icon"><svg fill="none" viewBox="0 0 24 24" stroke="#0f75bc" stroke-width="2"><path d="M12 4v16m8-8H4"/></svg></div><div class="quick-info"><strong>New Quote</strong><span>Start a new order</span></div></div>' +
      '<div class="quick-card" onclick="go(\'design-queue\')"><div class="quick-icon"><svg fill="none" viewBox="0 0 24 24" stroke="#7c3aed" stroke-width="2"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg></div><div class="quick-info"><strong>Design Queue</strong><span>View active designs</span></div></div>' +
      '<div class="quick-card" onclick="go(\'approvals\')"><div class="quick-icon"><svg fill="none" viewBox="0 0 24 24" stroke="#16a34a" stroke-width="2"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div><div class="quick-info"><strong>Approvals</strong><span>Pending review</span></div></div>' +
      '<div class="quick-card" onclick="go(\'fulfillment\')"><div class="quick-icon"><svg fill="none" viewBox="0 0 24 24" stroke="#d97706" stroke-width="2"><path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg></div><div class="quick-info"><strong>Fulfillment</strong><span>Production &amp; shipping</span></div></div>' +
    '</div>' +
    '<div class="section-card"><div class="section-title">Recent Orders</div><div class="section-sub">Click any order to view details and take action</div><div id="dRecent"><div style="padding:20px;text-align:center"><div class="spinner" style="width:20px;height:20px;border-width:2px;margin:0 auto"></div></div></div></div>' +
    '</div>';

  var statsRes = await sb.from('orders').select('status');
  if (statsRes.data) {
    var c = { intake:0, quote:0, design:0, production:0, fulfillment:0, complete:0 };
    for (var i = 0; i < statsRes.data.length; i++) {
      var s = statsRes.data[i].status;
      if (c[s] !== undefined) c[s]++;
    }
    el('dStats').innerHTML =
      '<div class="stat-card"><div class="stat-bar" style="background:#0f75bc"></div><div><div class="stat-num">' + (c.intake + c.quote) + '</div><div class="stat-label">Pending Quotes</div></div></div>' +
      '<div class="stat-card"><div class="stat-bar" style="background:#7c3aed"></div><div><div class="stat-num">' + c.design + '</div><div class="stat-label">In Design</div></div></div>' +
      '<div class="stat-card"><div class="stat-bar" style="background:#d97706"></div><div><div class="stat-num">' + c.production + '</div><div class="stat-label">In Production</div></div></div>' +
      '<div class="stat-card"><div class="stat-bar" style="background:#16a34a"></div><div><div class="stat-num">' + c.fulfillment + '</div><div class="stat-label">Ready to Ship</div></div></div>';
  }

  var q = sb.from('orders').select('*').order('created_at', { ascending: false }).limit(8);
  if (CP && CP.role === 'sales_rep') q = q.eq('rep_id', CU.id);
  var recent = await q;
  if (!recent.data || !recent.data.length) {
    el('dRecent').innerHTML = emptyHTML('No orders yet.', 'Create First Quote', "go('quote-request')");
    return;
  }
  var rHtml = '';
  for (var i = 0; i < recent.data.length; i++) {
    var o = recent.data[i];
    rHtml += '<div class="activity-item" onclick="openOrder(\'' + o.id + '\')">' +
      '<div class="activity-info"><strong>' + o.client_name + (o.event_name ? ' – ' + o.event_name : '') + '</strong>' +
      '<span>' + (o.order_number || '—') + ' · ' + (o.garment_type || '—') + ' · Qty ' + (o.quantity || '—') + ' · ' + timeAgo(o.created_at) + '</span></div>' +
      pill(o.status) + (o.is_rush ? ' <span class="pill pill-rush">RUSH</span>' : '') +
      '</div>';
  }
  el('dRecent').innerHTML = rHtml;
}

// ── QUOTE REQUEST ──
function pgQuote() {
  el('mainContent').innerHTML = '<div class="page">' +
    '<div class="page-header"><h1>New Quote Request</h1><p>Submit a new merchandise order</p></div>' +
    '<div id="quoteMsg"></div>' +
    '<div class="form-card">' +
      '<div class="form-section"><div class="form-section-title">Client Information</div>' +
        '<div class="form-row">' +
          '<div class="form-group"><label>Client / Chapter Name *</label><input class="form-input" id="q_client" placeholder="e.g. Alpha Phi"></div>' +
          '<div class="form-group"><label>Organization / School</label><input class="form-input" id="q_org" placeholder="e.g. Ohio State"></div>' +
        '</div>' +
        '<div class="form-row">' +
          '<div class="form-group"><label>Event / Campaign Name</label><input class="form-input" id="q_event" placeholder="e.g. Spring Formal 2026"></div>' +
          '<div class="form-group"><label>Client Contact Email</label><input class="form-input" id="q_email" type="email" placeholder="contact@chapter.com"></div>' +
        '</div>' +
      '</div>' +
      '<div class="form-section"><div class="form-section-title">Order Details</div>' +
        '<div class="form-row">' +
          '<div class="form-group"><label>Garment Type</label><select class="form-select" id="q_garment"><option>T-Shirt</option><option>Hoodie</option><option>Crewneck</option><option>Tank Top</option><option>Long Sleeve</option><option>Polo</option><option>Hat</option><option>Jacket</option><option>Other</option></select></div>' +
          '<div class="form-group"><label>Print Method</label><select class="form-select" id="q_print"><option>Screen Print</option><option>Embroidery</option><option>DTG</option><option>Sublimation</option><option>Heat Transfer</option></select></div>' +
        '</div>' +
        '<div class="form-row">' +
          '<div class="form-group"><label>Quantity *</label><input class="form-input" id="q_qty" type="number" min="1" placeholder="e.g. 50"></div>' +
          '<div class="form-group"><label>Client Budget ($)</label><input class="form-input" id="q_budget" type="number" placeholder="e.g. 1200"></div>' +
        '</div>' +
        '<div class="form-row">' +
          '<div class="form-group"><label>Needed By Date</label><input class="form-input" id="q_date" type="date"></div>' +
          '<div class="form-group"><label>Fulfillment Type</label><select class="form-select" id="q_fulfill"><option value="bulk">Bulk Delivery</option><option value="individual">Individual Ship</option></select></div>' +
        '</div>' +
        '<div class="form-group"><label>Rush Order?</label><select class="form-select" id="q_rush"><option value="false">No – Standard timeline</option><option value="true">Yes – Rush (+25% fee)</option></select></div>' +
      '</div>' +
      '<div class="form-section"><div class="form-section-title">Design Brief</div>' +
        '<div class="form-group"><label>Design Description</label><textarea class="form-textarea" id="q_notes" placeholder="Describe the design: colors, placement, text, logos..."></textarea></div>' +
      '</div>' +
      '<button class="btn-primary" onclick="submitQuote()">Submit Quote Request</button>' +
    '</div></div>';
}

async function submitQuote() {
  var client = gv('q_client');
  var qty = parseInt(gv('q_qty'));
  var msgEl = el('quoteMsg');
  if (!client) { msgEl.textContent = 'Client name is required'; msgEl.style.cssText = 'display:block;background:#fee2e2;color:#dc2626;border-radius:8px;padding:10px 14px;font-size:13px;margin-bottom:14px'; return; }
  if (!qty || qty < 1) { msgEl.textContent = 'Please enter a valid quantity'; msgEl.style.cssText = 'display:block;background:#fee2e2;color:#dc2626;border-radius:8px;padding:10px 14px;font-size:13px;margin-bottom:14px'; return; }
  msgEl.style.display = 'none';
  var res = await sb.from('orders').insert({
    client_name: client,
    organization: gv('q_org'),
    event_name: gv('q_event'),
    garment_type: el('q_garment').value,
    print_method: el('q_print').value,
    quantity: qty,
    budget: parseFloat(gv('q_budget')) || null,
    timeline_date: gv('q_date') || null,
    fulfillment_type: el('q_fulfill').value,
    is_rush: el('q_rush').value === 'true',
    design_notes: gv('q_notes'),
    rep_id: CU.id,
    status: 'intake'
  });
  if (res.error) { msgEl.textContent = 'Error: ' + res.error.message; msgEl.style.cssText = 'display:block;background:#fee2e2;color:#dc2626;border-radius:8px;padding:10px 14px;font-size:13px;margin-bottom:14px'; return; }
  msgEl.textContent = 'Quote submitted successfully! Redirecting...';
  msgEl.style.cssText = 'display:block;background:#dcfce7;color:#16a34a;border-radius:8px;padding:10px 14px;font-size:13px;margin-bottom:14px';
  setTimeout(function() { go('dashboard'); }, 1400);
}

// ── DESIGN QUEUE ──
async function pgDesignQueue() {
  el('mainContent').innerHTML = '<div class="page">' +
    '<div class="page-header"><h1>Design Queue</h1><p>Manage mockup creation and design workflow</p></div>' +
    '<div class="stat-grid" id="dqStats"><div class="stat-card"><div class="spinner" style="width:20px;height:20px;border-width:2px"></div></div></div>' +
    '<div class="tab-bar">' +
      '<div class="tab active" onclick="setTab(this.parentElement,this,function(){dqFilter(\'all\')})">All</div>' +
      '<div class="tab" onclick="setTab(this.parentElement,this,function(){dqFilter(\'intake\')})">Pending</div>' +
      '<div class="tab" onclick="setTab(this.parentElement,this,function(){dqFilter(\'design\')})">In Progress</div>' +
      '<div class="tab" onclick="setTab(this.parentElement,this,function(){dqFilter(\'production\')})">Production</div>' +
    '</div>' +
    '<div class="card-grid" id="dqCards"><div style="padding:20px;text-align:center"><div class="spinner" style="width:20px;height:20px;border-width:2px;margin:0 auto"></div></div></div>' +
    '</div>';

  var res = await sb.from('orders').select('*').in('status', ['intake','quote','design','production']).order('created_at', { ascending: true });
  window._dqAll = res.data || [];
  dqRender(window._dqAll);

  var o = window._dqAll;
  var pending = 0, indesign = 0, prod = 0;
  for (var i = 0; i < o.length; i++) {
    if (o[i].status === 'intake' || o[i].status === 'quote') pending++;
    if (o[i].status === 'design') indesign++;
    if (o[i].status === 'production') prod++;
  }
  el('dqStats').innerHTML =
    '<div class="stat-card"><div><div class="stat-num">' + pending + '</div><div class="stat-label">Pending</div></div></div>' +
    '<div class="stat-card"><div><div class="stat-num">' + indesign + '</div><div class="stat-label">In Design</div></div></div>' +
    '<div class="stat-card"><div><div class="stat-num">' + prod + '</div><div class="stat-label">Production</div></div></div>' +
    '<div class="stat-card"><div><div class="stat-num">' + o.length + '</div><div class="stat-label">Total Active</div></div></div>';
}

function dqFilter(s) {
  var o = window._dqAll || [];
  dqRender(s === 'all' ? o : o.filter(function(x) { return x.status === s; }));
}

function dqRender(orders) {
  if (!orders.length) { el('dqCards').innerHTML = emptyHTML('No orders in this stage.', null, null); return; }
  var h = '';
  for (var i = 0; i < orders.length; i++) {
    var o = orders[i];
    var nextLabel = (o.status === 'intake' || o.status === 'quote') ? 'Start Design' : (o.status === 'design' ? 'To Production' : 'To Fulfillment');
    h += '<div class="order-card">' +
      '<div class="card-header"><h3>' + o.client_name + (o.is_rush ? ' <span class="pill pill-rush">RUSH</span>' : '') + '</h3>' + pill(o.status) + '</div>' +
      '<div class="card-sub">' + (o.event_name || o.organization || '—') + '</div>' +
      '<div class="card-meta">' +
        '<div class="meta-row"><label>Garment</label><span>' + (o.garment_type || '—') + '</span></div>' +
        '<div class="meta-row"><label>Quantity</label><span>' + (o.quantity || '—') + ' units</span></div>' +
        '<div class="meta-row"><label>Method</label><span>' + (o.print_method || '—') + '</span></div>' +
        '<div class="meta-row"><label>Due</label><span>' + fmtDate(o.timeline_date) + '</span></div>' +
      '</div>' +
      (o.design_notes ? '<div class="notes-box"><label>Brief</label>' + o.design_notes + '</div>' : '') +
      '<div class="btn-row">' +
        '<button class="btn btn-ghost btn-full btn-sm" onclick="openOrder(\'' + o.id + '\')">View Details</button>' +
        '<button class="btn btn-blue btn-full btn-sm" onclick="dqAdvance(\'' + o.id + '\',\'' + o.status + '\')">' + nextLabel + '</button>' +
      '</div></div>';
  }
  el('dqCards').innerHTML = h;
}

async function dqAdvance(id, status) {
  var nextMap = { intake:'design', quote:'design', design:'production', production:'fulfillment' };
  var ok = await updateStatus(id, nextMap[status] || 'production');
  if (ok) pgDesignQueue();
}

// ── APPROVALS ──
async function pgApprovals() {
  el('mainContent').innerHTML = '<div class="page">' +
    '<div class="page-header"><h1>Approvals</h1><p>Review completed designs and approve for production</p></div>' +
    '<div class="stat-grid" id="apStats"><div class="stat-card"><div class="spinner" style="width:20px;height:20px;border-width:2px"></div></div></div>' +
    '<div class="card-grid" id="apCards"><div style="padding:20px;text-align:center"><div class="spinner" style="width:20px;height:20px;border-width:2px;margin:0 auto"></div></div></div>' +
    '</div>';

  var res = await sb.from('orders').select('*').in('status', ['design','production']).order('created_at', { ascending: false });
  var list = res.data || [];

  var pending = 0, approved = 0, rush = 0;
  for (var i = 0; i < list.length; i++) {
    if (list[i].status === 'design') pending++;
    if (list[i].status === 'production') approved++;
    if (list[i].is_rush) rush++;
  }
  el('apStats').innerHTML =
    '<div class="stat-card"><div><div class="stat-num">' + pending + '</div><div class="stat-label">Awaiting Approval</div></div></div>' +
    '<div class="stat-card"><div><div class="stat-num">' + approved + '</div><div class="stat-label">Approved</div></div></div>' +
    '<div class="stat-card"><div><div class="stat-num">' + rush + '</div><div class="stat-label">Rush</div></div></div>' +
    '<div class="stat-card"><div><div class="stat-num">' + list.length + '</div><div class="stat-label">Total</div></div></div>';

  if (!list.length) { el('apCards').innerHTML = emptyHTML('No items pending approval.', null, null); return; }
  var h = '';
  for (var i = 0; i < list.length; i++) {
    var o = list[i];
    h += '<div class="order-card">' +
      '<div class="card-header"><h3>' + o.client_name + (o.is_rush ? ' <span class="pill pill-rush">RUSH</span>' : '') + '</h3>' + pill(o.status) + '</div>' +
      '<div class="card-sub">' + (o.event_name || o.organization || '—') + '</div>' +
      '<div class="card-meta">' +
        '<div class="meta-row"><label>Product</label><span>' + (o.garment_type || '—') + '</span></div>' +
        '<div class="meta-row"><label>Quantity</label><span>' + (o.quantity || '—') + ' units</span></div>' +
        '<div class="meta-row"><label>Method</label><span>' + (o.print_method || '—') + '</span></div>' +
        '<div class="meta-row"><label>Order #</label><span class="order-num">' + (o.order_number || '—') + '</span></div>' +
      '</div>' +
      (o.design_notes ? '<div class="notes-box"><label>Design Notes</label>' + o.design_notes + '</div>' : '') +
      '<div class="btn-row">' +
        '<button class="btn btn-ghost btn-full btn-sm" onclick="apRevision(\'' + o.id + '\')">Request Revision</button>' +
        '<button class="btn btn-green btn-full btn-sm" onclick="apApprove(\'' + o.id + '\')">Approve</button>' +
      '</div></div>';
  }
  el('apCards').innerHTML = h;
}

async function apApprove(id) { var ok = await updateStatus(id, 'production'); if (ok) pgApprovals(); }
async function apRevision(id) { var ok = await updateStatus(id, 'design'); if (ok) pgApprovals(); }

// ── FULFILLMENT ──
async function pgFulfillment() {
  el('mainContent').innerHTML = '<div class="page">' +
    '<div class="page-header"><h1>Fulfillment</h1><p>Track production and shipping status</p></div>' +
    '<div class="stat-grid" id="ffStats"><div class="stat-card"><div class="spinner" style="width:20px;height:20px;border-width:2px"></div></div></div>' +
    '<div class="tab-bar">' +
      '<div class="tab active" onclick="setTab(this.parentElement,this,function(){ffFilter(\'active\')})">Active</div>' +
      '<div class="tab" onclick="setTab(this.parentElement,this,function(){ffFilter(\'complete\')})">Completed</div>' +
      '<div class="tab" onclick="setTab(this.parentElement,this,function(){ffFilter(\'all\')})">All</div>' +
    '</div>' +
    '<div class="card-grid" id="ffCards"><div style="padding:20px;text-align:center"><div class="spinner" style="width:20px;height:20px;border-width:2px;margin:0 auto"></div></div></div>' +
    '</div>';

  var res = await sb.from('orders').select('*').in('status', ['production','fulfillment','complete']).order('created_at', { ascending: false });
  window._ffAll = res.data || [];
  ffFilter('active');

  var o = window._ffAll;
  var prod = 0, ship = 0, done = 0;
  for (var i = 0; i < o.length; i++) {
    if (o[i].status === 'production') prod++;
    if (o[i].status === 'fulfillment') ship++;
    if (o[i].status === 'complete') done++;
  }
  el('ffStats').innerHTML =
    '<div class="stat-card"><div class="stat-bar" style="background:#d97706"></div><div><div class="stat-num">' + prod + '</div><div class="stat-label">In Production</div></div></div>' +
    '<div class="stat-card"><div class="stat-bar" style="background:#0f75bc"></div><div><div class="stat-num">' + ship + '</div><div class="stat-label">Ready to Ship</div></div></div>' +
    '<div class="stat-card"><div class="stat-bar" style="background:#16a34a"></div><div><div class="stat-num">' + done + '</div><div class="stat-label">Delivered</div></div></div>' +
    '<div class="stat-card"><div class="stat-bar" style="background:#6b7280"></div><div><div class="stat-num">' + o.length + '</div><div class="stat-label">Total</div></div></div>';
}

function ffFilter(f) {
  var o = window._ffAll || [];
  var filtered = f === 'active' ? o.filter(function(x) { return x.status !== 'complete'; }) :
                 f === 'complete' ? o.filter(function(x) { return x.status === 'complete'; }) : o;
  if (!filtered.length) { el('ffCards').innerHTML = emptyHTML('No orders in this stage.', null, null); return; }
  var h = '';
  for (var i = 0; i < filtered.length; i++) {
    var o = filtered[i];
    h += '<div class="order-card">' +
      '<div class="card-header"><h3>' + o.client_name + (o.is_rush ? ' <span class="pill pill-rush">RUSH</span>' : '') + '</h3>' + pill(o.status) + '</div>' +
      '<div class="card-sub">' + (o.event_name || o.organization || '—') + '</div>' +
      '<div class="card-meta">' +
        '<div class="meta-row"><label>Product</label><span>' + (o.garment_type || '—') + '</span></div>' +
        '<div class="meta-row"><label>Quantity</label><span>' + (o.quantity || '—') + ' units</span></div>' +
        '<div class="meta-row"><label>Fulfillment</label><span>' + (o.fulfillment_type || 'bulk') + '</span></div>' +
        '<div class="meta-row"><label>Order #</label><span class="order-num">' + (o.order_number || '—') + '</span></div>' +
      '</div>' +
      (o.is_rush ? '<div style="background:#fff8f0;border:1px solid #fed7aa;border-radius:6px;padding:8px 12px;font-size:12px;color:#92400e;margin-bottom:12px">Rush – expedited shipping required</div>' : '') +
      (o.status !== 'complete' ?
        '<div class="btn-row">' +
          '<button class="btn btn-ghost btn-full btn-sm" onclick="openOrder(\'' + o.id + '\')">View Details</button>' +
          '<button class="btn btn-blue btn-full btn-sm" onclick="ffAdvance(\'' + o.id + '\',\'' + o.status + '\')">' + (o.status === 'production' ? 'Mark Ready to Ship' : 'Mark Delivered') + '</button>' +
        '</div>'
        : '<div style="text-align:center;color:#16a34a;font-size:13px;font-weight:600;padding:4px">Delivered ' + fmtDate(o.updated_at) + '</div>'
      ) +
      '</div>';
  }
  el('ffCards').innerHTML = h;
}

async function ffAdvance(id, status) {
  var nextMap = { production: 'fulfillment', fulfillment: 'complete' };
  var ok = await updateStatus(id, nextMap[status]);
  if (ok) pgFulfillment();
}

// ── STOREFRONT ──
function pgStorefront() {
  el('mainContent').innerHTML = '<div class="page">' +
    '<div class="header-row">' +
      '<div class="page-header" style="margin-bottom:0"><h1>Storefront</h1><p>Manage products and pricing</p></div>' +
      '<button class="btn-sm-blue" onclick="openAddProduct()">+ Add Product</button>' +
    '</div><br>' +
    '<div class="stat-grid" id="sfStats"></div>' +
    '<div id="sfProducts"></div>' +
    '</div>';
  if (!window._products) window._products = [];
  sfRefresh();
}

function sfRefresh() {
  var p = window._products;
  var active = p.filter(function(x) { return x.active; }).length;
  el('sfStats').innerHTML =
    '<div class="stat-card"><div class="stat-bar" style="background:#0f75bc"></div><div><div class="stat-num">' + p.length + '</div><div class="stat-label">Products</div></div></div>' +
    '<div class="stat-card"><div class="stat-bar" style="background:#16a34a"></div><div><div class="stat-num">' + active + '</div><div class="stat-label">Active</div></div></div>' +
    '<div class="stat-card"><div class="stat-bar" style="background:#9ca3af"></div><div><div class="stat-num">' + (p.length - active) + '</div><div class="stat-label">Inactive</div></div></div>';
  if (!p.length) {
  el('sfProducts').innerHTML = emptyHTML(
    'No products yet. Add your first product.',
    '+ Add First Product',
    'openAddProduct()'
  );
  return;
}

  }
  var h = '<div class="card-grid">';
  for (var i = 0; i < p.length; i++) {
    var prod = p[i];
    h += '<div class="order-card">' +
      '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px">' +
        '<span style="font-size:15px;font-weight:600;color:#111827">' + prod.name + '</span>' +
        '<div style="text-align:right"><span style="font-size:15px;font-weight:700;color:#0f75bc">$' + prod.price + '</span><span style="display:block;font-size:10px;color:#9ca3af">Base Price</span></div>' +
      '</div>' +
      '<div style="font-size:12px;color:#9ca3af;margin-bottom:8px">' + prod.category + ' · ' + (prod.active ? '<span style="color:#16a34a">Active</span>' : '<span style="color:#9ca3af">Inactive</span>') + '</div>' +
      '<div style="font-size:12px;color:#6b7280;margin-bottom:14px;line-height:1.5">' + (prod.desc || '') + '</div>' +
      '<div class="btn-row">' +
        '<button class="btn btn-ghost btn-full btn-sm" onclick="toggleProduct(' + i + ')">' + (prod.active ? 'Deactivate' : 'Activate') + '</button>' +
        '<button class="btn btn-red btn-full btn-sm" onclick="removeProduct(' + i + ')">Remove</button>' +
      '</div></div>';
  }
  h += '</div>';
  el('sfProducts').innerHTML = h;
}

function openAddProduct() {
  el('mainContent').insertAdjacentHTML('afterend', '<div class="modal-bg open" id="addProdModal">' +
    '<div class="modal"><div class="modal-header"><h2>Add Product</h2><button class="modal-close" onclick="document.getElementById(\'addProdModal\').remove()">&#215;</button></div>' +
    '<div id="apMsg"></div>' +
    '<div class="form-group"><label>Product Name *</label><input class="form-input" id="ap_name" placeholder="e.g. Classic T-Shirt"></div>' +
    '<div class="form-row"><div class="form-group"><label>Base Price ($) *</label><input class="form-input" id="ap_price" type="number" placeholder="18.50"></div>' +
    '<div class="form-group"><label>Category</label><select class="form-select" id="ap_cat"><option>Apparel</option><option>Headwear</option><option>Bags</option><option>Accessories</option></select></div></div>' +
    '<div class="form-group"><label>Description</label><textarea class="form-textarea" id="ap_desc" placeholder="Describe the product..."></textarea></div>' +
    '<div class="btn-row"><button class="btn btn-ghost btn-full" onclick="document.getElementById(\'addProdModal\').remove()">Cancel</button>' +
    '<button class="btn btn-blue btn-full" onclick="saveProduct()">Add Product</button></div>' +
    '</div></div>');
}

function saveProduct() {
  var name = gv('ap_name'), price = gv('ap_price');
  if (!name || !price) { el('apMsg').innerHTML = '<div style="color:#dc2626;font-size:13px;margin-bottom:12px">Name and price are required</div>'; return; }
  window._products.push({ name: name, price: parseFloat(price).toFixed(2), category: el('ap_cat').value, desc: gv('ap_desc'), active: true });
  var m = document.getElementById('addProdModal');
  if (m) m.remove();
  sfRefresh();
}

function toggleProduct(i) { window._products[i].active = !window._products[i].active; sfRefresh(); }
function removeProduct(i) { if (!confirm('Remove this product?')) return; window._products.splice(i, 1); sfRefresh(); }

// ── ADMIN ──
async function pgAdmin() {
  el('mainContent').innerHTML = '<div class="page">' +
    '<div class="page-header"><h1>Admin Dashboard</h1><p>System oversight and business metrics</p></div>' +
    '<div class="flag-grid" id="adFlags"><div style="color:#9ca3af;font-size:13px">Loading...</div></div>' +
    '<div class="two-col">' +
      '<div class="section-card"><div class="section-title">All Orders</div><div class="section-sub">Click to view order details</div><div id="adOrders"><div class="spinner" style="width:20px;height:20px;border-width:2px"></div></div></div>' +
      '<div class="section-card"><div class="section-title">Business Metrics</div><div class="section-sub">Key performance indicators</div><div id="adMetrics"></div></div>' +
    '</div></div>';

  var res = await sb.from('orders').select('*').order('created_at', { ascending: false });
  var list = res.data || [];
  var rush = 0;
  for (var i = 0; i < list.length; i++) {
    if (list[i].is_rush && list[i].status !== 'complete' && list[i].status !== 'cancelled') rush++;
  }

  el('adFlags').innerHTML =
    '<div class="flag-card"><div class="flag-bar" style="background:#dc2626"></div><div><div class="flag-num">' + rush + '</div><div class="flag-label">Active Rush Orders</div></div></div>' +
    '<div class="flag-card"><div class="flag-bar" style="background:#d97706"></div><div><div class="flag-num">' + list.filter(function(o) { return o.status === 'intake'; }).length + '</div><div class="flag-label">New Intakes</div></div></div>' +
    '<div class="flag-card"><div class="flag-bar" style="background:#7c3aed"></div><div><div class="flag-num">' + list.filter(function(o) { return o.status === 'design'; }).length + '</div><div class="flag-label">In Design</div></div></div>' +
    '<div class="flag-card"><div class="flag-bar" style="background:#16a34a"></div><div><div class="flag-num">' + list.filter(function(o) { return o.status === 'complete'; }).length + '</div><div class="flag-label">Completed</div></div></div>';

  if (!list.length) { el('adOrders').innerHTML = emptyHTML('No orders yet.', null, null); }
  else {
    var h = '';
    for (var i = 0; i < Math.min(list.length, 12); i++) {
      var o = list[i];
      h += '<div class="activity-item" onclick="openOrder(\'' + o.id + '\')">' +
        '<div class="activity-info"><strong>' + o.client_name + '</strong><span>' + (o.order_number || '—') + ' · ' + (o.garment_type || '—') + ' · Qty ' + (o.quantity || '—') + '</span></div>' +
        pill(o.status) + '</div>';
    }
    el('adOrders').innerHTML = h;
  }

  var revenue = 0, totalQty = 0;
  for (var i = 0; i < list.length; i++) { revenue += (list[i].budget || 0); totalQty += (list[i].quantity || 0); }
  var avgQty = list.length ? Math.round(totalQty / list.length) : 0;
  el('adMetrics').innerHTML =
    '<div class="metric-card"><div><div class="metric-label">Total Orders</div><div class="metric-val">' + list.length + '</div></div><span style="font-size:20px">📋</span></div>' +
    '<div class="metric-card"><div><div class="metric-label">Pipeline Value</div><div class="metric-val">$' + revenue.toLocaleString() + '</div><div style="font-size:11px;color:#6b7280">Client budgets</div></div><span style="font-size:20px">💵</span></div>' +
    '<div class="metric-card"><div><div class="metric-label">Avg Order Size</div><div class="metric-val">' + avgQty + ' units</div></div><span style="font-size:20px">📦</span></div>' +
    '<div class="metric-card"><div><div class="metric-label">Rush Orders Active</div><div class="metric-val">' + rush + '</div></div><span style="font-size:20px">⚡</span></div>';
}

// ── TEAM ──
async function pgTeam() {
  el('mainContent').innerHTML = '<div class="page">' +
    '<div class="header-row">' +
      '<div class="page-header" style="margin-bottom:0"><h1>Team Management</h1><p>Invite and manage your team members</p></div>' +
      '<button class="btn-sm-blue" onclick="openInvite()">+ Invite Member</button>' +
    '</div><br>' +
    '<div class="stat-grid" id="tmStats"></div>' +
    '<div class="section-card"><div class="section-title">Team Members</div><div class="section-sub">Change roles using the dropdown. You cannot change your own role.</div><div id="tmList"><div style="padding:20px;text-align:center"><div class="spinner" style="width:20px;height:20px;border-width:2px;margin:0 auto"></div></div></div></div>' +
    '</div>';
  await loadTeam();
  genPass();
}

async function loadTeam() {
  var res = await sb.from('users').select('*').order('created_at', { ascending: true });
  var m = res.data || [];
  var admins = 0, sales = 0, designers = 0;
  for (var i = 0; i < m.length; i++) {
    if (m[i].role === 'admin' || m[i].role === 'super_admin') admins++;
    if (m[i].role === 'sales_rep') sales++;
    if (m[i].role === 'designer') designers++;
  }
  if (el('tmStats')) {
    el('tmStats').innerHTML =
      '<div class="stat-card"><div class="stat-bar" style="background:#0f75bc"></div><div><div class="stat-num">' + m.length + '</div><div class="stat-label">Total Members</div></div></div>' +
      '<div class="stat-card"><div class="stat-bar" style="background:#dc2626"></div><div><div class="stat-num">' + admins + '</div><div class="stat-label">Admins</div></div></div>' +
      '<div class="stat-card"><div class="stat-bar" style="background:#2563eb"></div><div><div class="stat-num">' + sales + '</div><div class="stat-label">Sales Reps</div></div></div>' +
      '<div class="stat-card"><div class="stat-bar" style="background:#7c3aed"></div><div><div class="stat-num">' + designers + '</div><div class="stat-label">Designers</div></div></div>';
  }
  if (!m.length) { el('tmList').innerHTML = emptyHTML('No team members yet.', null, null); return; }
  var h = '<table class="team-table"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Joined</th><th>Actions</th></tr></thead><tbody>';
  for (var i = 0; i < m.length; i++) {
    var u = m[i];
    var isMe = (u.id === CU.id);
    var roleSelect = '<select onchange="updateRole(\'' + u.id + '\',this.value)" style="font-size:12px;padding:5px 8px;border:1px solid #e5e7eb;border-radius:6px;background:#f9fafb;font-family:inherit;cursor:pointer"' + (isMe ? ' disabled' : '') + '>' +
      '<option value="sales_rep"' + (u.role === 'sales_rep' ? ' selected' : '') + '>Sales Rep</option>' +
      '<option value="designer"' + (u.role === 'designer' ? ' selected' : '') + '>Designer</option>' +
      '<option value="fulfillment"' + (u.role === 'fulfillment' ? ' selected' : '') + '>Fulfillment</option>' +
      '<option value="admin"' + (u.role === 'admin' ? ' selected' : '') + '>Admin</option>' +
      '<option value="super_admin"' + (u.role === 'super_admin' ? ' selected' : '') + '>Super Admin</option>' +
      '</select>';
    var removeBtn = isMe ? '—' : '<button class="btn btn-red btn-sm" data-id="' + u.id + '" data-name="' + (u.full_name || u.email) + '" onclick="removeMember(this)">Remove</button>';
    h += '<tr>' +
      '<td><div style="display:flex;align-items:center;gap:10px"><div style="width:32px;height:32px;border-radius:50%;background:#0f75bc;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;color:#fff;flex-shrink:0">' + (u.full_name || u.email).charAt(0).toUpperCase() + '</div>' +
      '<div><div style="font-weight:500">' + (u.full_name || '—') + '</div>' + (isMe ? '<div style="font-size:11px;color:#9ca3af">You</div>' : '') + '</div></div></td>' +
      '<td style="color:#6b7280">' + u.email + '</td>' +
      '<td>' + roleSelect + '</td>' +
      '<td style="color:#9ca3af;font-size:12px">' + fmtDate(u.created_at) + '</td>' +
      '<td>' + removeBtn + '</td>' +
      '</tr>';
  }
  h += '</tbody></table>';
  el('tmList').innerHTML = h;
}

function openInvite() { el('inviteModal').classList.add('open'); }
function closeInvite() {
  el('inviteModal').classList.remove('open');
  el('invMsg').innerHTML = '';
  el('inv_name').value = ''; el('inv_email').value = '';
  genPass();
}

function genPass() {
  var c = 'ABCDEFGHJKMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789!@#';
  var p = '';
  for (var i = 0; i < 12; i++) p += c[Math.floor(Math.random() * c.length)];
  if (el('inv_pass')) el('inv_pass').value = p;
}

async function createMember() {
  var name = gv('inv_name'), email = gv('inv_email'), pass = gv('inv_pass');
  var role = el('inv_role').value;
  var msgEl = el('invMsg');
  if (!name || !email || !pass) { msgEl.innerHTML = '<div style="color:#dc2626;font-size:13px;margin-bottom:12px">Please fill in all fields</div>'; return; }
  var btn = el('invBtn');
  btn.disabled = true; btn.textContent = 'Creating...';
  var res = await sb.auth.signUp({ email: email, password: pass, options: { data: { full_name: name } } });
  if (res.error) { msgEl.innerHTML = '<div style="color:#dc2626;font-size:13px;margin-bottom:12px">' + res.error.message + '</div>'; btn.disabled = false; btn.textContent = 'Create Account'; return; }
  if (res.data.user) {
    await sb.from('users').upsert({ id: res.data.user.id, email: email, full_name: name, role: role });
  }
  btn.disabled = false; btn.textContent = 'Create Account';
  msgEl.innerHTML = '<div style="background:#dcfce7;color:#16a34a;border-radius:8px;padding:12px 14px;font-size:13px;margin-bottom:14px;line-height:1.6">Account created!<br><strong>Email:</strong> ' + email + '<br><strong>Password:</strong> ' + pass + '<br>Share these with ' + name + '.</div>';
  setTimeout(loadTeam, 800);
}

async function updateRole(userId, newRole) {
  var res = await sb.from('users').update({ role: newRole }).eq('id', userId);
  if (res.error) alert('Error updating role: ' + res.error.message);
}

async function removeMember(btn) {
  var userId = btn.getAttribute('data-id');
  var name = btn.getAttribute('data-name');
  if (!confirm('Remove ' + name + ' from the team?')) return;
  await sb.from('users').delete().eq('id', userId);
  loadTeam();
}

boot();
</script>
</body>
</html>
